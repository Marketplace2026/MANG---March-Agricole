<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portefeuille - MANG</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

/* HEADER */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
}

.profile{
  display:flex;
  align-items:center;
  gap:12px;
}

.profile-circle{
  width:45px;
  height:45px;
  border-radius:50%;
  background:white;
  color:#1f4d3a;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

.close-btn{
  background:rgba(255,255,255,0.15);
  border:none;
  width:40px;
  height:40px;
  border-radius:50%;
  color:white;
  font-size:18px;
  cursor:pointer;
  transition:0.3s;
}
.close-btn:hover{background:red;}

/* CARD */
.container{padding:20px;}

.card{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

.balance-title{opacity:0.7;font-size:14px;}
.balance{font-size:34px;font-weight:700;margin-top:5px;}

.actions{
  margin-top:20px;
  display:flex;
  gap:15px;
}

button{
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
  flex:1;
}

.deposit{background:#00c853;color:white;}
.deposit:hover{background:#00a844;}

.withdraw{background:#ff5252;color:white;}
.withdraw:hover{background:#e63e3e;}

/* TRANSACTIONS */
.transaction{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.amount.plus{color:#00e676;font-weight:bold;}
.amount.minus{color:#ff5252;font-weight:bold;}

.empty{opacity:0.6;}

/* MODAL */
.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-content{
  background:#ffffff;
  color:#333;
  width:90%;
  max-width:400px;
  padding:25px;
  border-radius:20px;
  animation:pop 0.3s ease;
}

@keyframes pop{
  from{transform:scale(0.8);opacity:0;}
  to{transform:scale(1);opacity:1;}
}

.modal h3{margin-bottom:15px;}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-bottom:15px;
}

.operator{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.operator div{
  flex:1;
  border:2px solid #ddd;
  padding:10px;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  transition:0.3s;
}

.operator div.active{
  border-color:#1f4d3a;
  background:#e8f5e9;
}

.modal button{
  width:100%;
  background:#1f4d3a;
  color:white;
}
  
  .back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}
  .wallet-box {
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

#walletNumber {
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 3px;
  margin-bottom: 10px;
}
  
  .modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: flex-end;
  z-index: 1000;
}

.slide-up {
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-content {
  background: white;
  width: 100%;
  max-width: 450px;
  padding: 20px;
  border-radius: 20px 20px 0 0;
}

.modal-content input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.send-btn {
  padding: 12px 18px;
  background: #1e8e3e;
  color: white;
  border: none;
  border-radius: 10px;
  margin-bottom:25px;
}

.receiver-info {
  font-size: 13px;
  margin-bottom: 10px;
  color: green;
}

.loader {
  border: 4px solid #eee;
  border-top: 4px solid #1e8e3e;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  margin: 10px auto;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.close {
  float: right;
  font-size: 20px;
  cursor: pointer;
}
  #openTransferModal{
    margin-bottom:25px;
  }
  /* ======================
BOUTONS ACTIONS
===================== */
.actions {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin: 20px 0;
}

.actions button {
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.actions .deposit { background: #1f4d3a; }
.actions .deposit:hover { background: #16663d; }

.actions .withdraw { background: #dc2626; }
.actions .withdraw:hover { background: #b71c1c; }

/* ======================
MODALES
===================== */
.modal {
  display: none;
  position: fixed;
  top:0; left:0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  padding: 25px 30px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  text-align: center;
  position: relative;
}

.modal-content input {
  width: 100%;
  padding: 12px 15px;
  margin: 12px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

.modal-content button {
  background: #1f4d3a;
  color: #fff;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  transition: all 0.3s ease;
}
  
  /* ===== Operator selector ===== */
.operator-select {
  display: flex;
  justify-content: space-around;
  margin: 10px 0;
}
.operator-select label {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}
.operator-select img {
  width: 40px;
  height: 40px;
  margin-bottom: 4px;
}
.operator-select input[type="radio"] {
  display: none;
}
.operator-select input[type="radio"]:checked + img {
  border: 2px solid #1f4d3a;
  border-radius: 50%;
  padding: 2px;
}

.modal-content button:hover {
  background: #16663d;
}

.modal-content .close {
  position: absolute;
  top: 12px;
  right: 15px;
  font-size: 20px;
  color: #777;
  cursor: pointer;
  font-weight: bold;
}

.modal-content .close:hover {
  color: #000;
}

.modal-content h3 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #0b3d2e;
}

/* Responsive */
@media (max-width: 450px) {
  .modal-content {
    padding: 20px;
    width: 95%;
  }

  .modal-content input,
  .modal-content button {
    font-size: 14px;
    padding: 10px 15px;
  }
}
  
  
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>


<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <div class="profile">
    <div class="profile-circle">üë§</div>
    <div>
      <div>Mon Portefeuille</div>
      <small id="userEmail"></small>
    </div>
  </div>
  <div class="back" onclick="window.location.href='profile.html'">‚¨Ö Retour</div>
</div>

<!-- ================= WALLET CONTAINER ================= -->
<div id="walletContainer" style="display:none;">

  <div class="card">
    <div class="balance-title">Solde disponible</div>
    <div class="balance"><span id="balance">0</span></div>

    <div class="actions">
      <button class="deposit" onclick="openDeposit()">Recharger</button>
      <button class="withdraw" onclick="openWithdraw()">Retirer</button>
    </div>
  </div>

  <div class="wallet-box">
    <h3>Mon num√©ro de portefeuille</h3>
    <div id="walletNumber">Chargement...</div>
    <button onclick="copyWalletNumber()">Copier</button>
  </div>

  <button id="openTransferModal" class="send-btn">
    üí∏ Envoyer de l'argent
  </button>


  <!-- ================= TRANSFER MODAL ================= -->
<div class="modal" id="transferModal">
  <div class="modal-content">
    <h3>Envoyer de l'argent</h3>

    <input type="text" id="receiverNumber" placeholder="Num√©ro portefeuille">

    <div id="receiverInfo" style="margin:8px 0; font-size:13px;"></div>

    <input type="number" id="transferAmount" placeholder="Montant">

    <input type="password" id="transferPin" maxlength="4" placeholder="Votre PIN">

    <div id="transferLoader" style="display:none; margin:10px;">
      Traitement...
    </div>

    <button onclick="confirmTransfer()">Envoyer</button>
    <button onclick="closeTransferModal()" style="margin-top:8px; background:#ccc; color:#000;">
      Annuler
    </button>
  </div>
</div>
  <div class="card">
  <h3>Historique</h3>

  <select id="filterType" onchange="loadTransactions()">
    <option value="">Toutes</option>
    <option value="deposit">Rechargement</option>
    <option value="withdraw">Retrait</option>
    <option value="transfer">Transfert</option>
    <option value="purchase">Achat</option>
  </select>

  <canvas id="walletChart" height="120"></canvas>

  <div id="transactions"></div>
  </div>

  <div class="modal" id="detailModal">
  <div class="modal-content">
    <div id="transactionDetails"></div>
    <button onclick="closeDetail()">Fermer</button>
  </div>
  </div>
</div>

<!-- ================= PIN CREATION ================= -->
<div class="modal" id="createPinModal">
  <div class="modal-content">
    <h3>Cr√©er votre PIN</h3>
    <input type="password" id="newPin" maxlength="4" placeholder="4 chiffres">
    <button onclick="createPin()">Cr√©er</button>
  </div>
</div>

<!-- ================= PIN VERIFY ================= -->
<div class="modal" id="verifyPinModal">
  <div class="modal-content">
    <h3>Entrer votre PIN</h3>
    <input type="password" id="verifyPinInput" maxlength="4" placeholder="Votre PIN">
    <button onclick="verifyPin()">Valider</button>
  </div>
</div>
        <script type="module">
import { supabase } from './supabase.js';

let currentUser = null;
let currentProfile = null;

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", async () => {

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    location.href = "login.html";
    return;
  }

  currentUser = user;
  document.getElementById("userEmail").innerText = user.email;

  await checkPinStatus();
});

/* ================= PIN SYSTEM ================= */

async function checkPinStatus() {

  const { data: profile } = await supabase
    .from("profiles")
    .select("id, pin")
    .eq("id", currentUser.id)
    .single();

  currentProfile = profile;

  if (!profile.pin) {
    document.getElementById("createPinModal").style.display = "flex";
  } else {
    document.getElementById("verifyPinModal").style.display = "flex";
  }
}

async function createPin() {

  const pin = document.getElementById("newPin").value.trim();

  if (pin.length !== 4 || isNaN(pin)) {
    alert("Le PIN doit contenir 4 chiffres");
    return;
  }

  await supabase
    .from("profiles")
    .update({ pin })
    .eq("id", currentUser.id);

  document.getElementById("createPinModal").style.display = "none";

  unlockWallet();
}

function verifyPin() {

  const enteredPin = document.getElementById("verifyPinInput").value.trim();

  if (enteredPin === currentProfile.pin) {
    document.getElementById("verifyPinModal").style.display = "none";
    unlockWallet();
  } else {
    alert("‚ùå PIN incorrect");
  }
}

function unlockWallet(){
  document.getElementById("walletContainer").style.display = "block";
  loadWallet();
}

/* ================= WALLET ================= */

async function loadWallet(){

  const { data } = await supabase
    .from("wallets")
    .select("balance, wallet_number")
    .eq("user_id", currentUser.id)
    .single();

  document.getElementById("balance").innerText =
    Number(data.balance).toLocaleString("fr-FR") + " FCFA";

  document.getElementById("walletNumber").innerText =
    data.wallet_number;

  loadTransactions();
}
 /* ======================
   TRANSFERT D'ARGENT
===================== */

// üîπ Ouvrir le modal
function openTransferModal() {
  const modal = document.getElementById("transferModal");
  if (modal) modal.style.display = "flex";
}

// üîπ Fermer le modal et r√©initialiser les champs
function closeTransferModal() {
  const modal = document.getElementById("transferModal");
  if (modal) modal.style.display = "none";

  const info = document.getElementById("receiverInfo");
  if (info) info.innerHTML = "";

  document.getElementById("receiverNumber").value = "";
  document.getElementById("transferAmount").value = "";
  document.getElementById("transferPin").value = "";
}

// üîπ Bouton pour ouvrir le modal
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("openTransferModal");
  if (btn) btn.addEventListener("click", openTransferModal);
});

// üîé V√©rification automatique du destinataire
document.addEventListener("input", async (e) => {
  if (e.target.id !== "receiverNumber") return;

  const number = e.target.value.replace(/\s/g, "").trim();
  if (number.length < 6) return;

  try {
    // R√©cup√©rer l'utilisateur √† partir du wallet_number
    const { data: walletData } = await supabase
      .from("wallets")
      .select("user_id")
      .eq("wallet_number", number)
      .maybeSingle(); // ‚úÖ use maybeSingle pour √©viter l'erreur

    const info = document.getElementById("receiverInfo");
    if (!info) return;

    if (!walletData) {
      info.innerHTML = "Num√©ro introuvable";
      return;
    }

    // R√©cup√©rer l'email du destinataire
    const { data: profileData } = await supabase
      .from("profiles")
      .select("email")
      .eq("id", walletData.user_id)
      .maybeSingle();

    if (profileData) {
      info.innerHTML = `Destinataire : <b>${profileData.email}</b>`;
    } else {
      info.innerHTML = "Destinataire trouv√©";
    }

  } catch (err) {
    console.error("Erreur v√©rification destinataire :", err);
  }
});

// üîπ Confirmer le transfert
async function confirmTransfer() {
  if (!confirm("√ätes-vous s√ªr de vouloir effectuer ce transfert ?")) return;
  await sendMoney();
}

// üîπ Envoyer l'argent
async function sendMoney() {
  const loader = document.getElementById("transferLoader");
  if (loader) loader.style.display = "block";

  try {
    const receiverNumber = document.getElementById("receiverNumber")?.value.replace(/\s/g, "").trim();
    const amount = parseFloat(document.getElementById("transferAmount")?.value);
    const pin = document.getElementById("transferPin")?.value.trim();

    if (!receiverNumber || !amount || !pin) throw new Error("Veuillez remplir tous les champs");

    // üîπ R√©cup√©rer l'utilisateur connect√©
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) throw new Error("Utilisateur non connect√©");

    // üîπ Appel RPC transfer_money
    const { error: rpcError } = await supabase.rpc("transfer_money", {
      sender_uuid: user.id,
      receiver_wallet_number: receiverNumber,
      transfer_amount: amount,
      user_pin: pin
    });

    if (rpcError) throw rpcError;

    // üîπ Succ√®s
    alert("‚úÖ Transfert r√©ussi !");
    closeTransferModal();
    await loadWallet();
    await loadTransactions(); // recharge les transactions

  } catch (err) {
    alert("‚ùå " + err.message);
    console.error("Erreur transfert :", err);
  } finally {
    if (loader) loader.style.display = "none";
  }
}

// üîπ Export des fonctions pour le HTML
window.openTransferModal = openTransferModal;
window.closeTransferModal = closeTransferModal;
window.confirmTransfer = confirmTransfer;
window.sendMoney = sendMoney;

    
/* ================= TRANSACTIONS ================= */

async function loadTransactions(){

  const { data } = await supabase
    .from("wallet_transactions")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending:false });

  const container = document.getElementById("transactions");
  container.innerHTML = "";

  if (!data || data.length === 0){
    container.innerHTML = "<div class='empty'>Aucune transaction</div>";
    return;
  }

  data.forEach(tx=>{
    const div = document.createElement("div");
    div.className="transaction";

    const isPlus = Number(tx.amount) > 0;

    div.innerHTML = `
      <div>${tx.transaction_type}</div>
      <div class="amount ${isPlus ? 'plus':'minus'}">
        ${isPlus?'+':'-'}
        ${Math.abs(tx.amount).toLocaleString("fr-FR")} FCFA
      </div>
    `;

    container.appendChild(div);
  });
}

/* ================= GLOBAL ================= */

window.createPin = createPin;
window.verifyPin = verifyPin;

</script>
  
</body>
</html>
