<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portefeuille - MANG</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

/* HEADER */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
}

.profile{
  display:flex;
  align-items:center;
  gap:12px;
}

.profile-circle{
  width:45px;
  height:45px;
  border-radius:50%;
  background:white;
  color:#1f4d3a;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

.close-btn{
  background:rgba(255,255,255,0.15);
  border:none;
  width:40px;
  height:40px;
  border-radius:50%;
  color:white;
  font-size:18px;
  cursor:pointer;
  transition:0.3s;
}
.close-btn:hover{background:red;}

/* CARD */
.container{padding:20px;}

.card{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

.balance-title{opacity:0.7;font-size:14px;}
.balance{font-size:34px;font-weight:700;margin-top:5px;}

.actions{
  margin-top:20px;
  display:flex;
  gap:15px;
}

button{
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
  flex:1;
}

.deposit{background:#00c853;color:white;}
.deposit:hover{background:#00a844;}

.withdraw{background:#ff5252;color:white;}
.withdraw:hover{background:#e63e3e;}

/* TRANSACTIONS */
.transaction{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.amount.plus{color:#00e676;font-weight:bold;}
.amount.minus{color:#ff5252;font-weight:bold;}

.empty{opacity:0.6;}

/* MODAL */
.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-content{
  background:#ffffff;
  color:#333;
  width:90%;
  max-width:400px;
  padding:25px;
  border-radius:20px;
  animation:pop 0.3s ease;
}

@keyframes pop{
  from{transform:scale(0.8);opacity:0;}
  to{transform:scale(1);opacity:1;}
}

.modal h3{margin-bottom:15px;}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-bottom:15px;
}

.operator{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.operator div{
  flex:1;
  border:2px solid #ddd;
  padding:10px;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  transition:0.3s;
}

.operator div.active{
  border-color:#1f4d3a;
  background:#e8f5e9;
}

.modal button{
  width:100%;
  background:#1f4d3a;
  color:white;
}
  
  .back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="topbar">
  <div class="profile">
    <div class="profile-circle">üë§</div>
    <div>
      <div>Mon Portefeuille</div>
      <small id="userEmail"></small>
    </div>
  </div>
  <div class="back" onclick="window.location.href='profile.html'">‚¨Ö Retour</div>

</div>

<div class="container">

  <div class="card">
    <div class="balance-title">Solde disponible</div>
    <div class="balance"><span id="balance">0</span> FCFA</div>

    <div class="actions">
      <button class="deposit" onclick="openDeposit()">Recharger</button>
      <button class="withdraw" onclick="openWithdraw()">Retirer</button>
    </div>
  </div>

  <div class="card">
    <h3>Historique</h3>
    <div style="margin:15px 0;display:flex;gap:10px;flex-wrap:wrap">
  <select id="filterType" onchange="loadTransactions()" style="padding:8px;border-radius:8px;">
    <option value="">Toutes</option>
    <option value="deposit">Rechargement</option>
    <option value="withdraw">Retrait</option>
    <option value="purchase">Achat</option>
    <option value="premium">Premium</option>
    <option value="transfer">Transfert</option>
  </select>
</div>

<canvas id="walletChart" height="120"></canvas>
    <div id="transactions"></div>
  </div>

</div>

<!-- MODAL -->
<div class="modal" id="paymentModal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>

    <input type="number" id="amountInput" placeholder="Montant (FCFA)">
    <input type="text" id="phoneInput" placeholder="Num√©ro Mobile Money">

    <div class="operator">
      <div onclick="selectOperator(this,'MTN')">üü° MTN</div>
      <div onclick="selectOperator(this,'MOOV')">üîµ Moov</div>
      <div onclick="selectOperator(this,'CELTIS')">üü¢ Celtis</div>
    </div>

    <button onclick="submitTransaction()">Confirmer</button>
  </div>
</div>
<!-- MODAL DETAIL TRANSACTION -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3>D√©tails de la transaction</h3>
    <div id="transactionDetails"></div>
    <button onclick="closeDetail()">Fermer</button>
  </div>
</div>

  
  <script type="module">
import { supabase } from './supabase.js';

let currentUser=null;
let walletChart=null;

/* ====================== LOAD USER ====================== */

async function loadUser(){
  const { data:{user} } = await supabase.auth.getUser();
  if(!user){location.href="login.html";return;}
  currentUser=user;

  document.getElementById("userEmail").innerText=user.email;

  document.getElementById("filterType")
  ?.addEventListener("change",loadTransactions);

  loadWallet();
}

/* ====================== LOAD WALLET ====================== */

async function loadWallet(){
  const { data } = await supabase
  .from("profiles")
  .select("wallet_balance")
  .eq("id",currentUser.id)
  .single();

  document.getElementById("balance")
  .innerText=formatMoney(data?.wallet_balance||0);

  loadTransactions();
}

/* ====================== LOAD TRANSACTIONS ====================== */

async function loadTransactions(){

  const filter=document.getElementById("filterType")?.value || "";

  let query=supabase
  .from("wallet_transactions")
  .select("*")
  .eq("user_id",currentUser.id)
  .order("created_at",{ascending:false});

  if(filter){
    query=query.ilike("type",`%${filter}%`);
  }

  const { data,error }=await query;

  const container=document.getElementById("transactions");
  container.innerHTML="";

  if(error || !data || data.length===0){
    container.innerHTML=`<div class="empty">Aucune transaction</div>`;
    renderChart(0,0);
    return;
  }

  let totalIn=0;
  let totalOut=0;

  data.forEach(tx=>{

    const isCredit=isPositive(tx);
    const amount=Math.abs(Number(tx.amount));

    if(isCredit) totalIn+=amount;
    else totalOut+=amount;

    const sign=isCredit?"+":"-";
    const color=isCredit?"#00e676":"#ff5252";

    const div=document.createElement("div");
    div.className="transaction";
    div.style.cursor="pointer";

    div.innerHTML=`
      <div>
        <strong>${getTitle(tx)}</strong><br>
        <small>${new Date(tx.created_at).toLocaleString()}</small><br>
        ${statusBadge(tx.status)}
      </div>

      <div style="font-weight:700;color:${color}">
        ${sign}${formatMoney(amount)} FCFA
      </div>
    `;

    div.onclick=()=>showTransactionDetail(tx);
    container.appendChild(div);
  });

  renderChart(totalIn,totalOut);
}

/* ====================== CREDIT LOGIC ====================== */

function isPositive(tx){
  const type=tx.type?.toLowerCase()||"";

  return type.includes("deposit")
      || type.includes("refund");
}

/* ====================== TITRE ====================== */

function getTitle(tx){
  const type=tx.type?.toLowerCase()||"";
  const desc=tx.description?.toLowerCase()||"";

  if(type.includes("deposit")) return "Rechargement Mobile Money";
  if(type.includes("withdraw")) return "Retrait Mobile Money";
  if(type.includes("premium")||desc.includes("premium"))
    return "Abonnement Premium MANG";
  if(type.includes("purchase"))
    return tx.description || "Paiement produit";
  if(type.includes("transfer"))
    return "Transfert utilisateur";

  return "Transaction";
}

/* ====================== FORMAT ====================== */

function formatMoney(amount){
  return Number(amount).toLocaleString("fr-FR");
}

/* ====================== BADGE ====================== */

function statusBadge(status){
  if(!status) return badge("Valid√©","#00c853");
  if(status==="pending") return badge("En attente","#ff9800");
  if(status==="failed") return badge("√âchou√©","#ff5252");
  return badge("Valid√©","#00c853");
}

function badge(text,color){
  return `<span style="
    background:${color};
    color:white;
    padding:4px 8px;
    border-radius:6px;
    font-size:11px;">
    ${text}
  </span>`;
}

/* ====================== DETAIL ====================== */

window.showTransactionDetail=function(tx){

  const isCredit=isPositive(tx);
  const amount=Math.abs(Number(tx.amount));
  const sign=isCredit?"+":"-";
  const color=isCredit?"#00e676":"#ff5252";

  const detail=document.getElementById("transactionDetails");

  detail.innerHTML=`
    <h4>${getTitle(tx)}</h4>

    <div style="font-size:22px;font-weight:700;color:${color}">
      ${sign}${formatMoney(amount)} FCFA
    </div>

    <hr>

    <p><strong>Date :</strong><br>
    ${new Date(tx.created_at).toLocaleString()}</p>

    <p><strong>Statut :</strong><br>
    ${tx.status||"Valid√©"}</p>

    <button onclick="downloadReceipt('${tx.id}')"
    style="margin-top:15px;background:#1f4d3a;color:white;padding:10px;border-radius:8px;width:100%">
    T√©l√©charger PDF
    </button>
  `;

  document.getElementById("detailModal").style.display="flex";
}

window.closeDetail=function(){
  document.getElementById("detailModal").style.display="none";
}

/* ====================== CHART ====================== */

function renderChart(totalIn,totalOut){

  const ctx=document.getElementById("walletChart");
  if(!ctx) return;

  if(walletChart) walletChart.destroy();

  walletChart=new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Entr√©es","Sorties"],
      datasets:[{
        data:[totalIn,totalOut],
        backgroundColor:["#00e676","#ff5252"]
      }]
    }
  });
}

/* ====================== PDF RECEIPT ====================== */

window.downloadReceipt = async function(id) {

  // üîπ R√©cup√®re la transaction dans Supabase
  const { data, error } = await supabase
    .from("wallet_transactions")
    .select("*")
    .eq("id", id)
    .single();

  if (error || !data) {
    alert("Transaction introuvable !");
    return;
  }

  try {
    // üîπ Appel de la fonction Edge pour g√©n√©rer le re√ßu PDF
    const response = await fetch(
      "https://czbqmzclcxitxxfydadl.supabase.co/functions/v1/generate-receipt",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          transaction: data
        })
      }
    );

    if (!response.ok) throw new Error("Erreur lors de la g√©n√©ration du re√ßu");

    const result = await response.json();

    if (!result.url) throw new Error("URL du re√ßu introuvable");

    // üî• Ouvre le PDF dans un nouvel onglet
    window.open(result.url, "_blank");

  } catch (err) {
    console.error(err);
    alert("Impossible de g√©n√©rer le re√ßu PDF : " + err.message);
  }
};
loadUser();
</script>
</body>
</html>
