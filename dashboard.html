<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portefeuille - MANG</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

/* HEADER */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
}

.profile{
  display:flex;
  align-items:center;
  gap:12px;
}

.profile-circle{
  width:45px;
  height:45px;
  border-radius:50%;
  background:white;
  color:#1f4d3a;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

.close-btn{
  background:rgba(255,255,255,0.15);
  border:none;
  width:40px;
  height:40px;
  border-radius:50%;
  color:white;
  font-size:18px;
  cursor:pointer;
  transition:0.3s;
}
.close-btn:hover{background:red;}

/* CARD */
.container{padding:20px;}

.card{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

.balance-title{opacity:0.7;font-size:14px;}
.balance{font-size:34px;font-weight:700;margin-top:5px;}

.actions{
  margin-top:20px;
  display:flex;
  gap:15px;
}

button{
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
  flex:1;
}

.deposit{background:#00c853;color:white;}
.deposit:hover{background:#00a844;}

.withdraw{background:#ff5252;color:white;}
.withdraw:hover{background:#e63e3e;}

/* TRANSACTIONS */
.transaction{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.amount.plus{color:#00e676;font-weight:bold;}
.amount.minus{color:#ff5252;font-weight:bold;}

.empty{opacity:0.6;}

/* MODAL */
.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-content{
  background:#ffffff;
  color:#333;
  width:90%;
  max-width:400px;
  padding:25px;
  border-radius:20px;
  animation:pop 0.3s ease;
}

@keyframes pop{
  from{transform:scale(0.8);opacity:0;}
  to{transform:scale(1);opacity:1;}
}

.modal h3{margin-bottom:15px;}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-bottom:15px;
}

.operator{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.operator div{
  flex:1;
  border:2px solid #ddd;
  padding:10px;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  transition:0.3s;
}

.operator div.active{
  border-color:#1f4d3a;
  background:#e8f5e9;
}

.modal button{
  width:100%;
  background:#1f4d3a;
  color:white;
}
  
  .back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}
  .wallet-box {
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

#walletNumber {
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 3px;
  margin-bottom: 10px;
}
  
  .modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: flex-end;
  z-index: 1000;
}

.slide-up {
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-content {
  background: white;
  width: 100%;
  max-width: 450px;
  padding: 20px;
  border-radius: 20px 20px 0 0;
}

.modal-content input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.send-btn {
  padding: 12px 18px;
  background: #1e8e3e;
  color: white;
  border: none;
  border-radius: 10px;
  margin-bottom:25px;
}

.receiver-info {
  font-size: 13px;
  margin-bottom: 10px;
  color: green;
}

.loader {
  border: 4px solid #eee;
  border-top: 4px solid #1e8e3e;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  margin: 10px auto;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.close {
  float: right;
  font-size: 20px;
  cursor: pointer;
}
  #openTransferModal{
    margin-bottom:25px;
  }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="topbar">
  <div class="profile">
    <div class="profile-circle">üë§</div>
    <div>
      <div>Mon Portefeuille</div>
      <small id="userEmail"></small>
    </div>
  </div>
  <div class="back" onclick="window.location.href='profile.html'">‚¨Ö Retour</div>

</div>

<div class="container">

  <div class="card">
    <div class="balance-title">Solde disponible</div>
    <div class="balance"><span id="balance">0</span> FCFA</div>

    <div class="actions">
      <button class="deposit" onclick="openDeposit()">Recharger</button>
      <button class="withdraw" onclick="openWithdraw()">Retirer</button>
    </div>
  </div>

  <!-- MODAL CREATION PIN -->
<div class="modal" id="createPinModal">
  <div class="modal-content">
    <h3>Cr√©er votre PIN de s√©curit√©</h3>
    <p style="font-size:13px;margin-bottom:10px;">
      Ce code sera demand√© pour chaque transfert.
    </p>
    <input type="password" id="newPin" placeholder="PIN √† 4 chiffres" maxlength="4">
    <button onclick="createPin()">Cr√©er PIN</button>
  </div>
</div>
  
  <div class="wallet-box">
  <h3>Mon num√©ro de portefeuille</h3>
  <div id="walletNumber">Chargement...</div>

  <button onclick="copyWalletNumber()">Copier</button>

  </div>
  
 <button id="openTransferModal" class="send-btn">
  üí∏ Envoyer de l'argent
</button>
  
 <!-- MODAL TRANSFERT -->
<div id="transferModal" class="modal">
  <div class="modal-content slide-up">

    <span class="close" onclick="closeTransferModal()">&times;</span>

    <h3>Transf√©rer de l'argent</h3>

    <input type="text" id="receiverNumber" placeholder="Num√©ro du portefeuille" maxlength="10">
    
    <div id="receiverInfo" class="receiver-info"></div>

    <input type="number" id="transferAmount" placeholder="Montant">
    <input type="password" id="transferPin" placeholder="Votre PIN" maxlength="4">

    <button id="confirmTransferBtn" onclick="confirmTransfer()">
      Envoyer
    </button>

    <div id="transferLoader" class="loader" style="display:none;"></div>

  </div>
</div>

  <div class="card">
    <h3>Historique</h3>
    <div style="margin:15px 0;display:flex;gap:10px;flex-wrap:wrap">
  <select id="filterType" onchange="loadTransactions()" style="padding:8px;border-radius:8px;">
    <option value="">Toutes</option>
    <option value="deposit">Rechargement</option>
    <option value="withdraw">Retrait</option>
    <option value="purchase">Achat</option>
    <option value="premium">Premium</option>
    <option value="transfer">Transfert</option>
  </select>
</div>

<canvas id="walletChart" height="120"></canvas>
    <div id="transactions"></div>
  </div>

</div>

 <!-- MODAL -->
<div class="modal" id="paymentModal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>

    <input type="number" id="amountInput" placeholder="Montant (FCFA)">
    <input type="text" id="phoneInput" placeholder="Num√©ro Mobile Money">

    <div class="operator">
      <div onclick="selectOperator(this,'MTN')">üü° MTN</div>
      <div onclick="selectOperator(this,'MOOV')">üîµ Moov</div>
      <div onclick="selectOperator(this,'CELTIS')">üü¢ Celtis</div>
    </div>

    <button onclick="submitTransaction()">Confirmer</button>
  </div>
</div>
<!-- MODAL DETAIL TRANSACTION -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3>D√©tails de la transaction</h3>
    <div id="transactionDetails"></div>
    <button onclick="closeDetail()">Fermer</button>
  </div>
</div>

  
        <script type="module">
      import { supabase } from './supabase.js';

let currentUser = null;
let walletChart = null;

/* ======================
   LOAD USER
===================== */
async function loadUser() {
  try {
    const { data: { user }, error } = await supabase.auth.getUser();

    if (error || !user) {
      location.href = "login.html";
      return;
    }

    currentUser = user;

    const emailEl = document.getElementById("userEmail");
    if (emailEl) emailEl.innerText = user.email;

    const filter = document.getElementById("filterType");
    if (filter) {
      filter.addEventListener("change", loadTransactions);
    }

    await loadWallet();

  } catch (err) {
    console.error("Erreur loadUser:", err);
  }
}

function copyWalletNumber() {
  const el = document.getElementById("walletNumber");
  if (!el) return;

  const number = el.textContent.replace(/\s/g, "");

  if (!number || number === "Non disponible") {
    alert("Num√©ro indisponible");
    return;
  }

  navigator.clipboard.writeText(number)
    .then(() => {
      alert("Num√©ro copi√© !");
    })
    .catch(() => {
      alert("Impossible de copier.");
    });
}

// RENDRE LA FONCTION GLOBALE
window.copyWalletNumber = copyWalletNumber;
  
/* ======================
   LOAD WALLET
===================== */
async function loadWallet() {
  if (!currentUser) return;

  try {
    const { data, error } = await supabase
      .from("profiles")
      .select("wallet_balance, wallet_number, pin")
      .eq("id", currentUser.id)
      .single();

    if (error) throw error;
    if (!data) return;

    // üîê V√©rifier si le PIN existe
    if (!data.pin) {
      const modal = document.getElementById("createPinModal");
      if (modal) modal.style.display = "flex";
      return; // ‚õî Stop ici tant que PIN non cr√©√©
    }

    const balance = data.wallet_balance || 0;
    const walletNumber = data.wallet_number || "";

    // ===== Solde principal =====
    const balanceMain = document.getElementById("balance");
    if (balanceMain) {
      balanceMain.innerText = formatMoney(balance);
    }

    // ===== Solde secondaire =====
    const walletBalanceEl = document.getElementById("walletBalance");
    if (walletBalanceEl) {
      walletBalanceEl.textContent =
        Number(balance).toLocaleString() + " FCFA";
    }

    // ===== Num√©ro portefeuille =====
    const walletNumberEl = document.getElementById("walletNumber");
    if (walletNumberEl) {
      if (walletNumber.length > 0) {
        const formatted = walletNumber.replace(/(\d{2})(?=\d)/g, "$1 ");
        walletNumberEl.textContent = formatted;
      } else {
        walletNumberEl.textContent = "Non disponible";
      }
    }

    await loadTransactions();

  } catch (err) {
    console.error("Erreur loadWallet:", err);
  }
}


/* ======================
   CREATE PIN
===================== */
async function createPin() {

  const pinInput = document.getElementById("newPin");
  if (!pinInput) return;

  const pin = pinInput.value.trim();

  if (pin.length !== 4 || isNaN(pin)) {
    alert("Le PIN doit contenir exactement 4 chiffres");
    return;
  }

  try {
    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase
      .from("profiles")
      .update({ pin: pin })
      .eq("id", user.id);

    if (error) throw error;

    const modal = document.getElementById("createPinModal");
    if (modal) modal.style.display = "none";

    alert("PIN cr√©√© avec succ√®s !");

    // üîÑ Recharger wallet apr√®s cr√©ation
    loadWallet();

  } catch (err) {
    console.error("Erreur cr√©ation PIN:", err);
    alert("Erreur lors de la cr√©ation du PIN");
  }
}

// IMPORTANT si tu utilises type="module"
window.createPin = createPin;


/* ======================
   START
===================== */
document.addEventListener("DOMContentLoaded", loadUser);
/* ======================
LOAD TRANSACTIONS
===================== */
async function loadTransactions() {
  const filter = document.getElementById("filterType")?.value || "";

  let query = supabase
    .from("wallet_transactions")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: false });

  if (filter) query = query.ilike("type", `%${filter}%`);

  const { data, error } = await query;
  const container = document.getElementById("transactions");
  container.innerHTML = "";

  if (error || !data || data.length === 0) {
    container.innerHTML = `<div class="empty">Aucune transaction</div>`;
    renderChart(0, 0);
    return;
  }

  let totalIn = 0;
  let totalOut = 0;

  data.forEach(tx => {
    const isCredit = isPositive(tx);
    const amount = Math.abs(Number(tx.amount));

    if (isCredit) totalIn += amount;
    else totalOut += amount;

    const div = document.createElement("div");
    div.className = "transaction";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <div>
        <strong>${getTitle(tx)}</strong><br>
        <small>${new Date(tx.created_at).toLocaleString()}</small><br>
        ${statusBadge(tx.status)}
      </div>
      <div class="amount ${isCredit ? 'plus' : 'minus'}">
        ${isCredit ? '+' : '-'}${formatMoney(amount)} FCFA
      </div>
    `;

    div.onclick = () => showTransactionDetail(tx);
    container.appendChild(div);
  });

  renderChart(totalIn, totalOut);
}

/* ======================
CREDIT LOGIC
===================== */
function isPositive(tx) {
  const type = tx.type?.toLowerCase() || "";
  return type.includes("deposit") || type.includes("refund");
}

/* ======================
GET TITLE
===================== */
function getTitle(tx) {
  const type = tx.type?.toLowerCase() || "";
  const desc = tx.description?.toLowerCase() || "";

  if (type.includes("deposit")) return "Rechargement Mobile Money";
  if (type.includes("withdraw")) return "Retrait Mobile Money";
  if (type.includes("premium") || desc.includes("premium")) return "Abonnement Premium MANG";
  if (type.includes("purchase")) return tx.description || "Paiement produit";
  if (type.includes("transfer")) return "Transfert utilisateur";
  return "Transaction";
}

/* ======================
FORMAT MONEY
===================== */
function formatMoney(amount) {
  return Number(amount || 0).toLocaleString("fr-FR");
}

/* ======================
STATUS BADGE
===================== */
function statusBadge(status) {
  if (!status) return badge("Valid√©", "#00c853");
  if (status === "pending") return badge("En attente", "#ff9800");
  if (status === "failed") return badge("√âchou√©", "#ff5252");
  return badge("Valid√©", "#00c853");
}
function badge(text, color) {
  return `<span style="background:${color};color:white;padding:4px 8px;border-radius:6px;font-size:11px;">${text}</span>`;
}

/* ======================
DETAIL MODAL
===================== */
function showTransactionDetail(tx) {
  const isCredit = isPositive(tx);
  const amount = Math.abs(Number(tx.amount));
  const sign = isCredit ? "+" : "-";
  const color = isCredit ? "#00e676" : "#ff5252";

  const detail = document.getElementById("transactionDetails");
  detail.innerHTML = `
    <h4>${getTitle(tx)}</h4>
    <div style="font-size:22px;font-weight:700;color:${color}">${sign}${formatMoney(amount)} FCFA</div>
    <hr>
    <p><strong>Date :</strong><br>${new Date(tx.created_at).toLocaleString()}</p>
    <p><strong>Statut :</strong><br>${tx.status || "Valid√©"}</p>
    ${tx.operator ? `<p><strong>Op√©rateur :</strong><br>${tx.operator}</p>` : ""}
    ${tx.phone ? `<p><strong>Num√©ro :</strong><br>${tx.phone}</p>` : ""}
    <p><strong>D√©tail :</strong><br>${getUsage(tx)}</p>
    <button id="downloadPdfBtn" style="margin-top:15px;background:#1f4d3a;color:white;padding:10px;border-radius:8px;width:100%">
      T√©l√©charger PDF
    </button>
  `;
  document.getElementById("detailModal").style.display = "flex";

  document.getElementById("downloadPdfBtn").onclick = () => downloadReceiptPDF(tx.id);
}

window.closeDetail = () => {
  document.getElementById("detailModal").style.display = "none";
};

  function openTransferModal() {
  document.getElementById("transferModal").style.display = "flex";
}

function closeTransferModal() {
  document.getElementById("transferModal").style.display = "none";
  document.getElementById("receiverInfo").innerHTML = "";
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("openTransferModal");
  if (btn) btn.addEventListener("click", openTransferModal);
});

// üîé V√©rifier destinataire automatiquement
document.addEventListener("input", async (e) => {
  if (e.target.id === "receiverNumber") {

    const number = e.target.value.trim();
    if (number.length < 6) return;

    const { data } = await supabase
      .from("profiles")
      .select("email, wallet_number")
      .eq("wallet_number", number)
      .single();

    const info = document.getElementById("receiverInfo");

    if (data) {
      info.innerHTML = "Destinataire : <b>" + data.email + "</b>";
    } else {
      info.innerHTML = "Num√©ro introuvable";
    }
  }
});
  
  async function confirmTransfer() {

  if (!confirm("√ätes-vous s√ªr de vouloir effectuer ce transfert ?")) return;

  await sendMoney();
}
async function sendMoney() {

  const loader = document.getElementById("transferLoader");
  loader.style.display = "block";

  try {

    const receiverNumber = document
      .getElementById("receiverNumber")
      .value.replace(/\s/g, "")
      .trim();

    const amount = parseFloat(
      document.getElementById("transferAmount").value
    );

    const pin = document
      .getElementById("transferPin")
      .value
      .trim();

    if (!receiverNumber || !amount || !pin) {
      throw new Error("Veuillez remplir tous les champs");
    }

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase.rpc("transfer_money", {
      sender_id: user.id,
      receiver_wallet: receiverNumber,
      transfer_amount: amount,
      user_pin: pin
    });

    if (error) throw error;

    alert("Transfert r√©ussi !");

    closeTransferModal();
    loadWallet();

  } catch (err) {
    alert(err.message);
  }

  loader.style.display = "none";
}


window.closeTransferModal = closeTransferModal;
  window.confirmTransfer = confirmTransfer;
window.sendMoney = sendMoney;
/* ======================
USAGE DESCRIPTION
===================== */
function getUsage(tx) {
  const desc = tx.description?.toLowerCase() || "";
  if (tx.type === "deposit") return "Rechargement de votre portefeuille via Mobile Money.";
  if (tx.type === "withdraw") return "Retrait envoy√© vers votre num√©ro Mobile Money.";
  if (tx.type === "premium" || desc.includes("premium")) return "Paiement pour activation de votre abonnement Premium.";
  if (tx.type === "purchase") return tx.description ? `Paiement pour : ${tx.description}` : "Paiement d‚Äôun produit.";
  if (tx.type === "transfer") return "Transfert vers un autre utilisateur.";
  return "Transaction enregistr√©e.";
}

/* ======================
CHART
===================== */
function renderChart(totalIn, totalOut) {
  const ctx = document.getElementById("walletChart");
  if (!ctx) return;
  if (walletChart) walletChart.destroy();

  walletChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Entr√©es", "Sorties"],
      datasets: [{ data: [totalIn, totalOut], backgroundColor: ["#00e676", "#ff5252"] }]
    },
    options: { plugins: { legend: { labels: { color: "white" } } } }
  });
}
async function generateHash(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
}
/* ======================
PDF RECEIPT CLIENT
===================== */
      async function downloadReceiptPDF(id) {
  try {
    const { data: tx, error } = await supabase
      .from("wallet_transactions")
      .select("*")
      .eq("id", id)
      .single();

    if (error || !tx) throw new Error("Transaction introuvable.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const primary = "#0b3d2e";
    const accent = tx.type === "credit" ? "#16a34a" : "#dc2626";

    /* ===== NUM√âRO OFFICIEL ===== */
    const receiptNumber = `MANG-${new Date().getFullYear()}-${String(tx.id).padStart(6, "0")}`;

    /* ===== HASH S√âCURIT√â ===== */
    const securityString = `${receiptNumber}|${tx.amount}|${tx.created_at}`;
    const hash = await generateHash(securityString);

    /* ===== HEADER ===== */
    doc.setFillColor(primary);
    doc.rect(0, 0, 595, 100, "F");

    doc.setTextColor("#ffffff");
    doc.setFontSize(20);
    doc.text("MANG WALLET", 40, 60);

    doc.setFontSize(11);
    doc.text("Re√ßu Financier S√©curis√©", 400, 60);

    /* ===== CARTE BLANCHE ===== */
    doc.setFillColor("#ffffff");
    doc.roundedRect(40, 140, 515, 360, 14, 14, "F");

    doc.setDrawColor(220);
    doc.roundedRect(40, 140, 515, 360, 14, 14);

    /* ===== MONTANT CENTRAL ===== */
    doc.setFontSize(34);
    doc.setTextColor(accent);
    doc.text(
      `${tx.type === "credit" ? "+" : "-"} ${Number(tx.amount).toLocaleString()} FCFA`,
      297,
      220,
      { align: "center" }
    );

    /* ===== BADGE ===== */
    doc.setFillColor(accent);
    doc.roundedRect(240, 235, 120, 30, 8, 8, "F");

    doc.setTextColor("#ffffff");
    doc.setFontSize(12);
    doc.text(tx.type.toUpperCase(), 300, 255, { align: "center" });

    /* ===== INFOS ===== */
    doc.setTextColor("#333");
    doc.setFontSize(12);

    let y = 300;
    const gap = 30;

    doc.text("Num√©ro de re√ßu :", 70, y);
    doc.text(receiptNumber, 230, y);

    doc.text("Transaction ID :", 70, y + gap);
    doc.text(String(tx.id), 230, y + gap);

    doc.text("Date :", 70, y + gap * 2);
    doc.text(new Date(tx.created_at).toLocaleString(), 230, y + gap * 2);

    doc.text("Description :", 70, y + gap * 3);
    doc.text(tx.description || "-", 230, y + gap * 3, { maxWidth: 250 });

    /* ===== QR CODE S√âCURIS√â ===== */
    const qrCanvas = document.createElement("canvas");

    await new Promise(resolve => {
      new QRCode(qrCanvas, {
        text: `${receiptNumber}|HASH:${hash}`,
        width: 110,
        height: 110,
        correctLevel: QRCode.CorrectLevel.H
      });
      setTimeout(resolve, 200);
    });

    const qrData = qrCanvas.toDataURL("image/png");
    doc.addImage(qrData, "PNG", 410, 330, 110, 110);

    /* ===== CACHE OFFICIEL ===== */
    doc.setDrawColor(primary);
    doc.circle(480, 470, 40);
    doc.setFontSize(9);
    doc.setTextColor(primary);
    doc.text("OFFICIEL", 480, 475, { align: "center" });

    /* ===== HASH INVISIBLE ===== */
    doc.setFontSize(6);
    doc.setTextColor("#aaaaaa");
    doc.text(hash, 40, 820);

    /* ===== FOOTER ===== */
    doc.setFontSize(9);
    doc.setTextColor("#777");
    doc.text("Document sign√© num√©riquement par MANG Wallet.", 40, 800);
    doc.text("Toute alt√©ration rend ce document invalide.", 40, 815);

    doc.save(`${receiptNumber}.pdf`);

  } catch (err) {
    console.error(err);
    alert("Erreur g√©n√©ration re√ßu.");
  }
          }
  
          loadUser();
        </script>
</body>
</html>
