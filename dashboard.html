<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portefeuille - MANG</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

/* HEADER */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
}

.profile{
  display:flex;
  align-items:center;
  gap:12px;
}

.profile-circle{
  width:45px;
  height:45px;
  border-radius:50%;
  background:white;
  color:#1f4d3a;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}

.close-btn{
  background:rgba(255,255,255,0.15);
  border:none;
  width:40px;
  height:40px;
  border-radius:50%;
  color:white;
  font-size:18px;
  cursor:pointer;
  transition:0.3s;
}
.close-btn:hover{background:red;}

/* CARD */
.container{padding:20px;}

.card{
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

.balance-title{opacity:0.7;font-size:14px;}
.balance{font-size:34px;font-weight:700;margin-top:5px;}

.actions{
  margin-top:20px;
  display:flex;
  gap:15px;
}

button{
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
  flex:1;
}

.deposit{background:#00c853;color:white;}
.deposit:hover{background:#00a844;}

.withdraw{background:#ff5252;color:white;}
.withdraw:hover{background:#e63e3e;}

/* TRANSACTIONS */
.transaction{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.amount.plus{color:#00e676;font-weight:bold;}
.amount.minus{color:#ff5252;font-weight:bold;}

.empty{opacity:0.6;}

/* MODAL */
.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-content{
  background:#ffffff;
  color:#333;
  width:90%;
  max-width:400px;
  padding:25px;
  border-radius:20px;
  animation:pop 0.3s ease;
}

@keyframes pop{
  from{transform:scale(0.8);opacity:0;}
  to{transform:scale(1);opacity:1;}
}

.modal h3{margin-bottom:15px;}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  margin-bottom:15px;
}

.operator{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.operator div{
  flex:1;
  border:2px solid #ddd;
  padding:10px;
  border-radius:10px;
  text-align:center;
  cursor:pointer;
  transition:0.3s;
}

.operator div.active{
  border-color:#1f4d3a;
  background:#e8f5e9;
}

.modal button{
  width:100%;
  background:#1f4d3a;
  color:white;
}
  
  .back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}
  .wallet-box {
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  margin-bottom:25px;
  box-shadow:0 8px 30px rgba(0,0,0,0.3);
}

#walletNumber {
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 3px;
  margin-bottom: 10px;
}
  
  .modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: flex-end;
  z-index: 1000;
}

.slide-up {
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-content {
  background: white;
  width: 100%;
  max-width: 450px;
  padding: 20px;
  border-radius: 20px 20px 0 0;
}

.modal-content input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.send-btn {
  padding: 12px 18px;
  background: #1e8e3e;
  color: white;
  border: none;
  border-radius: 10px;
  margin-bottom:25px;
}

.receiver-info {
  font-size: 13px;
  margin-bottom: 10px;
  color: green;
}

.loader {
  border: 4px solid #eee;
  border-top: 4px solid #1e8e3e;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  margin: 10px auto;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

.close {
  float: right;
  font-size: 20px;
  cursor: pointer;
}
  #openTransferModal{
    margin-bottom:25px;
  }
  /* ======================
BOUTONS ACTIONS
===================== */
.actions {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin: 20px 0;
}

.actions button {
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.actions .deposit { background: #1f4d3a; }
.actions .deposit:hover { background: #16663d; }

.actions .withdraw { background: #dc2626; }
.actions .withdraw:hover { background: #b71c1c; }

/* ======================
MODALES
===================== */
.modal {
  display: none;
  position: fixed;
  top:0; left:0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  padding: 25px 30px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  text-align: center;
  position: relative;
}

.modal-content input {
  width: 100%;
  padding: 12px 15px;
  margin: 12px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

.modal-content button {
  background: #1f4d3a;
  color: #fff;
  border: none;
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  transition: all 0.3s ease;
}
  
  /* ===== Operator selector ===== */
.operator-select {
  display: flex;
  justify-content: space-around;
  margin: 10px 0;
}
.operator-select label {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}
.operator-select img {
  width: 40px;
  height: 40px;
  margin-bottom: 4px;
}
.operator-select input[type="radio"] {
  display: none;
}
.operator-select input[type="radio"]:checked + img {
  border: 2px solid #1f4d3a;
  border-radius: 50%;
  padding: 2px;
}

.modal-content button:hover {
  background: #16663d;
}

.modal-content .close {
  position: absolute;
  top: 12px;
  right: 15px;
  font-size: 20px;
  color: #777;
  cursor: pointer;
  font-weight: bold;
}

.modal-content .close:hover {
  color: #000;
}

.modal-content h3 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #0b3d2e;
}
  
.back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}

/* Responsive */
@media (max-width: 450px) {
  .modal-content {
    padding: 20px;
    width: 95%;
  }

  .modal-content input,
  .modal-content button {
    font-size: 14px;
    padding: 10px 15px;
  }
}
  
  
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <div class="back" onclick="window.location.href='profile.html'">‚¨Ö Retour</div>

<!-- ================= TOPBAR ================= -->
<div class="topbar">
  <div class="profile">
    <div class="profile-circle">üë§</div>
    <div>
      <div>Mon Portefeuille</div>
      <small id="userEmail"></small>
    </div>
  </div>
  
</div>

<!-- ================= WALLET CONTAINER ================= -->
<div id="walletContainer" style="display:none;">

  <div class="card">
    <div class="balance-title">Solde disponible</div>
    <div class="balance"><span id="balance">0</span></div>

    <div class="actions">
      <button class="deposit" onclick="openDeposit()">Recharger</button>
      <button class="withdraw" onclick="openWithdraw()">Retirer</button>
    </div>
  </div>

  <div class="wallet-box">
    <h3>Mon num√©ro de portefeuille</h3>
    <div id="walletNumber">Chargement...</div>
    <button onclick="copyWalletNumber()">Copier</button>
  </div>

  <button id="openTransferModal" class="send-btn">
    üí∏ Envoyer de l'argent
  </button>


  <!-- ================= TRANSFER MODAL ================= -->
<div class="modal" id="transferModal">
  <div class="modal-content">
    <h3>Envoyer de l'argent</h3>

    <input type="text" id="receiverNumber" placeholder="Num√©ro portefeuille">

    <div id="receiverInfo" style="margin:8px 0; font-size:13px;"></div>

    <input type="number" id="transferAmount" placeholder="Montant">

    <input type="password" id="transferPin" maxlength="4" placeholder="Votre PIN">

    <div id="transferLoader" style="display:none; margin:10px;">
      Traitement...
    </div>

    <button onclick="confirmTransfer()">Envoyer</button>
    <button onclick="closeTransferModal()" style="margin-top:8px; background:#ccc; color:#000;">
      Annuler
    </button>
  </div>
</div>
  
  <div class="card">
  <h3>Historique</h3>
     <div style="margin:15px 0;display:flex;gap:10px;flex-wrap:wrap">
  <select id="filterType" onchange="loadTransactions()" style="padding:8px;border-radius:8px;">
    
    <option value="">Toutes</option>
    <option value="deposit">Rechargement</option>
    <option value="withdraw">Retrait</option>
    <option value="transfer">Transfert</option>
    <option value="purchase">Achat</option>
  </select>
     </div>
  <canvas id="walletChart" height="120"></canvas>

  <div id="transactions"></div>
</div>

<div class="modal" id="detailModal">
  <div class="modal-content">
    <div id="transactionDetails"></div>
    <button onclick="closeDetail()">Fermer</button>
  </div>
</div>
</div>

<!-- ================= PIN VERIFY ================= -->
<div class="modal" id="verifyPinModal">
  <div class="modal-content">
    <h3>Entrer votre PIN</h3>
    <input type="password" id="verifyPinInput" maxlength="4" placeholder="Votre PIN">
    <button onclick="verifyPin()">Valider</button>
  </div>
</div>
        <script type="module">
import { supabase } from './supabase.js';

let currentUser = null;
let currentProfile = null;

/* ================= INIT ================= */

document.addEventListener("DOMContentLoaded", async () => {
  try {
    console.log("DOM charg√©");

    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError) {
      console.error("Erreur supabase.auth.getUser :", userError);
      return;
    }

    if (!user) {
      console.warn("Utilisateur non connect√©, redirection...");
      location.href = "login.html";
      return;
    }

    currentUser = user;
    console.log("Utilisateur connect√© :", currentUser.email);

    // Afficher email
    const emailEl = document.getElementById("userEmail");
    if (emailEl) {
      emailEl.innerText = currentUser.email;
    } else {
      console.warn("Element #userEmail introuvable dans le DOM");
    }

    console.log("Avant checkPinStatus()");
    await checkPinStatus();
    console.log("Apr√®s checkPinStatus()");

    console.log("Avant loadWallet()");
    await loadWallet();
    console.log("Apr√®s loadWallet()");

  } catch (err) {
    console.error("Erreur DOMContentLoaded :", err);
  }
});


/* ================= PIN SYSTEM ================= */
async function checkPinStatus() {
  try {
    console.log("checkPinStatus() d√©marr√©");

    const { data: profile, error } = await supabase
      .from("profiles")
      .select("id, pin")
      .eq("id", currentUser.id)
      .single();

    if (error) {
      console.error("Erreur fetch profile :", error);
      return;
    }

    if (!profile) {
      console.warn("Profil introuvable pour user :", currentUser.id);
      return;
    }

    currentProfile = profile;
    console.log("Profil r√©cup√©r√© :", profile);

    if (!profile.pin) {
      console.log("PIN manquant, affichage modal createPin");
      const createModal = document.getElementById("createPinModal");
      if (createModal) {
        createModal.style.display = "flex";
      } else {
        console.warn("Element #createPinModal introuvable");
      }
    } else {
      console.log("PIN trouv√©, affichage modal verifyPin");
      const verifyModal = document.getElementById("verifyPinModal");
      if (verifyModal) {
        verifyModal.style.display = "flex";
      } else {
        console.warn("Element #verifyPinModal introuvable");
      }
    }

    console.log("checkPinStatus() termin√©");

  } catch (err) {
    console.error("Erreur checkPinStatus :", err);
  }
}
async function createPin() {

  const pin = document.getElementById("newPin").value.trim();

  if (pin.length !== 4 || isNaN(pin)) {
    alert("Le PIN doit contenir 4 chiffres");
    return;
  }

  await supabase
    .from("profiles")
    .update({ pin })
    .eq("id", currentUser.id);

  document.getElementById("createPinModal").style.display = "none";

  unlockWallet();
}

function verifyPin() {

  const enteredPin = document.getElementById("verifyPinInput").value.trim();

  if (enteredPin === currentProfile.pin) {
    document.getElementById("verifyPinModal").style.display = "none";
    unlockWallet();
  } else {
    alert("‚ùå PIN incorrect");
  }
}

function unlockWallet(){
  document.getElementById("walletContainer").style.display = "block";
  loadWallet();
}
// üîπ Charger les informations du wallet
async function loadWallet() {
  try {
    const { data, error } = await supabase
      .from("wallets")
      .select("balance, available_balance, escrow_balance, wallet_number")
      .eq("user_id", currentUser.id)
      .single();

    if (error) throw error;
    if (!data) throw new Error("Wallet introuvable");

    // Afficher le solde disponible
    const balanceEl = document.getElementById("balance");
    if (balanceEl) {
      balanceEl.innerText = Number(data.available_balance).toLocaleString("fr-FR") + " FCFA";
    }

    // Afficher le solde total et l'argent bloqu√© en escrow (optionnel)
    const totalEl = document.getElementById("totalBalance");
    if (totalEl) {
      totalEl.innerText = `Total: ${Number(data.balance).toLocaleString("fr-FR")} FCFA (Escrow: ${Number(data.escrow_balance).toLocaleString("fr-FR")} FCFA)`;
    }

    // Afficher le num√©ro du wallet
    const walletEl = document.getElementById("walletNumber");
    if (walletEl) walletEl.innerText = data.wallet_number || "Non disponible";

    // Charger l'historique des transactions si fonction disponible
    if (typeof loadTransactions === "function") loadTransactions();

  } catch (err) {
    console.error("Erreur lors du chargement du wallet :", err);
    alert(err.message || "Impossible de charger le wallet");
  }
}

// üîπ Copier le num√©ro du wallet
function copyWalletNumber() {
  const el = document.getElementById("walletNumber");
  if (!el) return;

  const number = el.textContent.replace(/\s/g, "");

  if (!number || number === "Non disponible") {
    alert("Num√©ro indisponible");
    return;
  }

  navigator.clipboard.writeText(number)
    .then(() => alert("Num√©ro copi√© !"))
    .catch(() => alert("Impossible de copier le num√©ro"));
}

// üîπ D√©clarer la fonction globalement pour l'HTML
window.copyWalletNumber = copyWalletNumber;

          
 /* ======================
   TRANSFERT D'ARGENT
===================== */

// üîπ Ouvrir le modal
function openTransferModal() {
  const modal = document.getElementById("transferModal");
  if (modal) modal.style.display = "flex";
}

// üîπ Fermer le modal et r√©initialiser les champs
function closeTransferModal() {
  const modal = document.getElementById("transferModal");
  if (modal) modal.style.display = "none";

  const info = document.getElementById("receiverInfo");
  if (info) info.innerHTML = "";

  document.getElementById("receiverNumber").value = "";
  document.getElementById("transferAmount").value = "";
  document.getElementById("transferPin").value = "";
}

// üîπ Bouton pour ouvrir le modal
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("openTransferModal");
  if (btn) btn.addEventListener("click", openTransferModal);
});

// üîé V√©rification automatique du destinataire
document.addEventListener("input", async (e) => {
  if (e.target.id !== "receiverNumber") return;

  const number = e.target.value.replace(/\s/g, "").trim();
  if (number.length < 6) return;

  try {
    // R√©cup√©rer l'utilisateur √† partir du wallet_number
    const { data: walletData } = await supabase
      .from("wallets")
      .select("user_id")
      .eq("wallet_number", number)
      .maybeSingle(); // ‚úÖ use maybeSingle pour √©viter l'erreur

    const info = document.getElementById("receiverInfo");
    if (!info) return;

    if (!walletData) {
      info.innerHTML = "Num√©ro introuvable";
      return;
    }

    // R√©cup√©rer l'email du destinataire
    const { data: profileData } = await supabase
      .from("profiles")
      .select("email")
      .eq("id", walletData.user_id)
      .maybeSingle();

    if (profileData) {
      info.innerHTML = `Destinataire : <b>${profileData.email}</b>`;
    } else {
      info.innerHTML = "Destinataire trouv√©";
    }

  } catch (err) {
    console.error("Erreur v√©rification destinataire :", err);
  }
});

// üîπ Confirmer le transfert
async function confirmTransfer() {
  if (!confirm("√ätes-vous s√ªr de vouloir effectuer ce transfert ?")) return;
  await sendMoney();
}

// üîπ Envoyer l'argent
async function sendMoney() {
  const loader = document.getElementById("transferLoader");
  if (loader) loader.style.display = "block";

  try {
    const receiverNumber = document.getElementById("receiverNumber")?.value.replace(/\s/g, "").trim();
    const amount = parseFloat(document.getElementById("transferAmount")?.value);
    const pin = document.getElementById("transferPin")?.value.trim();

    if (!receiverNumber || !amount || !pin) throw new Error("Veuillez remplir tous les champs");

    // üîπ R√©cup√©rer l'utilisateur connect√©
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) throw new Error("Utilisateur non connect√©");

    // üîπ Appel RPC transfer_money
    const { error: rpcError } = await supabase.rpc("transfer_money", {
      sender_uuid: user.id,
      receiver_wallet_number: receiverNumber,
      transfer_amount: amount,
      user_pin: pin
    });

    if (rpcError) throw rpcError;

    // üîπ Succ√®s
    alert("‚úÖ Transfert r√©ussi !");
    closeTransferModal();
    await loadWallet();
    await loadTransactions(); // recharge les transactions

  } catch (err) {
    alert("‚ùå " + err.message);
    console.error("Erreur transfert :", err);
  } finally {
    if (loader) loader.style.display = "none";
  }
}

// üîπ Export des fonctions pour le HTML
window.openTransferModal = openTransferModal;
window.closeTransferModal = closeTransferModal;
window.confirmTransfer = confirmTransfer;
window.sendMoney = sendMoney;

    
/* ======================
LOAD TRANSACTIONS
====================== */
async function loadTransactions() {
  if (!currentUser) return;

  const filter = document.getElementById("filterType")?.value || "";

  let query = supabase
    .from("wallet_transactions")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: false });

  if (filter) {
    query = query.ilike("transaction_type", `%${filter}%`);
  }

  const { data, error } = await query;

  const container = document.getElementById("transactions");
  container.innerHTML = "";

  if (error || !data || data.length === 0) {
    container.innerHTML = `<div class="empty">Aucune transaction</div>`;
    renderChart(0, 0);
    return;
  }

  let totalIn = 0;
  let totalOut = 0;

  data.forEach(tx => {
    const amount = Number(tx.amount) || 0;
    const isCredit = amount > 0;
    const absAmount = Math.abs(amount);

    if (isCredit) totalIn += absAmount;
    else totalOut += absAmount;

    const div = document.createElement("div");
    div.className = "transaction";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <div>
        <strong>${getTitle(tx)}</strong><br>
        <small>${new Date(tx.created_at).toLocaleString()}</small><br>
        ${statusBadge(tx.status)}
      </div>
      <div class="amount ${isCredit ? "plus" : "minus"}">
        ${isCredit ? "+" : "-"}${formatMoney(absAmount)} FCFA
      </div>
    `;

    div.onclick = () => showTransactionDetail(tx);
    container.appendChild(div);
  });

  renderChart(totalIn, totalOut);
}

/* ======================
GET TITLE
====================== */
function getTitle(tx) {
  const type = tx.transaction_type?.toLowerCase() || "";
  const desc = tx.description?.toLowerCase() || "";

  if (type.includes("deposit")) return "Rechargement Mobile Money";
  if (type.includes("withdraw")) return "Retrait Mobile Money";
  if (type.includes("transfer")) return "Transfert utilisateur";
  if (type.includes("purchase")) return tx.description || "Paiement produit";
  if (type.includes("premium") || desc.includes("premium")) return "Abonnement Premium";

  return "Transaction";
}

/* ======================
FORMAT MONEY
====================== */
function formatMoney(amount) {
  return Number(amount || 0).toLocaleString("fr-FR");
}

/* ======================
STATUS BADGE
====================== */
function statusBadge(status) {
  if (!status || status === "completed") return badge("Valid√©", "#00c853");
  if (status === "pending") return badge("En attente", "#ff9800");
  if (status === "failed") return badge("√âchou√©", "#ff5252");
  return badge("Valid√©", "#00c853");
}

function badge(text, color) {
  return `
    <span style="
      background:${color};
      color:white;
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;">
      ${text}
    </span>
  `;
}

          /* ======================
USAGE DESCRIPTION
===================== */
function getUsage(tx) {
  const desc = tx.description?.toLowerCase() || "";
  if (tx.type === "deposit") return "Rechargement de votre portefeuille via Mobile Money.";
  if (tx.type === "withdraw") return "Retrait envoy√© vers votre num√©ro Mobile Money.";
  if (tx.type === "premium" || desc.includes("premium")) return "Paiement pour activation de votre abonnement Premium.";
  if (tx.type === "purchase") return tx.description ? `Paiement pour : ${tx.description}` : "Paiement d‚Äôun produit.";
  if (tx.type === "transfer") return "Transfert vers un autre utilisateur.";
  return "Transaction enregistr√©e.";
          }
/* ======================
SHOW TRANSACTION DETAIL
====================== */
function showTransactionDetail(tx) {
  const amount = Number(tx.amount) || 0;
  const isCredit = amount > 0;
  const absAmount = Math.abs(amount);
  const sign = isCredit ? "+" : "-";
  const color = isCredit ? "#00e676" : "#ff5252";

  const detail = document.getElementById("transactionDetails");
  if (!detail) return;

  detail.innerHTML = `
    <h4>${getTitle(tx)}</h4>
    <div style="font-size:22px;font-weight:700;color:${color}">
      ${sign}${formatMoney(absAmount)} FCFA
    </div>
    <hr>
    <p><strong>Date :</strong><br>
      ${new Date(tx.created_at).toLocaleString()}
    </p>
    <p><strong>Statut :</strong><br>
      ${tx.status || "Valid√©"}
    </p>
    <p><strong>D√©tail :</strong><br>${getUsage(tx)}</p>
    <button id="downloadPdfBtn" style="margin-top:15px;background:#1f4d3a;color:white;padding:10px;border-radius:8px;width:100%">
      T√©l√©charger PDF
    </button>
  `;

  document.getElementById("detailModal").style.display = "flex";
  document.getElementById("downloadPdfBtn").onclick = () => downloadReceiptPDF(tx.id);
  
}

/* ======================
CLOSE MODAL
====================== */
function closeDetail() {
  document.getElementById("detailModal").style.display = "none";
}

/* ======================
FILTER CHANGE
====================== */
document.addEventListener("DOMContentLoaded", () => {
  const filter = document.getElementById("filterType");
  if (filter) {
    filter.addEventListener("change", loadTransactions);
  }
});
let walletChart = null;

function renderChart(totalIn, totalOut) {
  const canvas = document.getElementById("walletChart");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  if (walletChart) {
    walletChart.destroy();
  }

  walletChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Entr√©es", "Sorties"],
      datasets: [{
        data: [totalIn, totalOut],
        backgroundColor: ["#00e676", "#ff5252"],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: {
            color: "#ffffff"
          }
        }
      }
    }
  });
          }

          

          async function generateHash(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
          }

          

          function loadImageBase64(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = function () {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/png"));
    };
    img.onerror = reject;
    img.src = url;
  });
          }

          /* ======================
PDF RECEIPT CLIENT
===================== */
      async function downloadReceiptPDF(id) {
  try {

    const { data: tx, error } = await supabase
      .from("wallet_transactions")
      .select("*")
      .eq("id", id)
      .single();

    if (error || !tx) throw new Error("Transaction introuvable.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const primary = "#0b3d2e";
    const success = "#16a34a";
    const danger = "#dc2626";

    const isCredit = Number(tx.amount) > 0;
    const accent = isCredit ? success : danger;

    const cleanAmount = Math.abs(Number(tx.amount));

    /* ===== NUM√âRO OFFICIEL ===== */
    const receiptNumber =
      `MANG-${new Date().getFullYear()}-${String(tx.id).padStart(6, "0")}`;

    /* ===== HASH S√âCURIT√â ===== */
    const securityString =
      `${receiptNumber}|${tx.amount}|${tx.created_at}`;
    const hash = await generateHash(securityString);

    /* ===== HEADER FOND ===== */
    doc.setFillColor(primary);
    doc.rect(0, 0, 595, 110, "F");

    /* ===== LOGO ===== */
    const logo = await loadImageBase64("assets/img/logos.png");
    doc.addImage(logo, "PNG", 40, 25, 60, 60);

    doc.setTextColor("#ffffff");
    doc.setFontSize(20);
    doc.text("MANG WALLET", 120, 60);

    doc.setFontSize(11);
    doc.text("Re√ßu Financier Officiel", 420, 60);

    /* ===== CARTE PRINCIPALE ===== */
    doc.setFillColor("#ffffff");
    doc.roundedRect(40, 150, 515, 400, 18, 18, "F");

    doc.setDrawColor(220);
    doc.roundedRect(40, 150, 515, 400, 18, 18);

    /* ===== TITRE ===== */
    doc.setFontSize(14);
    doc.setTextColor("#333");
    doc.text("D√©tails de la transaction", 60, 190);

    /* ===== MONTANT CENTRAL ===== */
    doc.setFontSize(36);
    doc.setTextColor(accent);
    doc.text(
      `${isCredit ? "+" : "-"} ${cleanAmount.toLocaleString()} FCFA`,
      297,
      250,
      { align: "center" }
    );

    /* ===== BADGE TYPE ===== */
    doc.setFillColor(accent);
    doc.roundedRect(230, 270, 135, 30, 10, 10, "F");

    doc.setTextColor("#ffffff");
    doc.setFontSize(12);

    const typeLabel =
      tx.type === "transfer_received" ? "TRANSFERT RE√áU"
      : tx.type === "transfer_sent" ? "TRANSFERT ENVOY√â"
      : tx.type?.toUpperCase() || "TRANSACTION";

    doc.text(typeLabel, 297, 290, { align: "center" });

    /* ===== INFOS ===== */
    doc.setTextColor("#333");
    doc.setFontSize(12);

    let y = 330;
    const gap = 32;

    const infoLine = (label, value, offset) => {
      doc.setFont(undefined, "bold");
      doc.text(label, 70, y + gap * offset);
      doc.setFont(undefined, "normal");
      doc.text(String(value), 230, y + gap * offset);
    };

    infoLine("Num√©ro de re√ßu :", receiptNumber, 0);
    infoLine("Transaction ID :", tx.id, 1);
    infoLine("Date :", new Date(tx.created_at).toLocaleString(), 2);
    infoLine("Description :", tx.description || "-", 3);

    /* ===== QR CODE ===== */
    const qrCanvas = document.createElement("canvas");

    await new Promise(resolve => {
      new QRCode(qrCanvas, {
        text: `${receiptNumber}|HASH:${hash}`,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.H
      });
      setTimeout(resolve, 250);
    });

    const qrData = qrCanvas.toDataURL("image/png");
    doc.addImage(qrData, "PNG", 400, 390, 120, 120);

    /* ===== CACHET OFFICIEL ===== */
    doc.setDrawColor(primary);
    doc.setLineWidth(2);
    doc.circle(470, 520, 45);

    doc.setFontSize(10);
    doc.setTextColor(primary);
    doc.text("CERTIFI√â", 470, 525, { align: "center" });

    /* ===== HASH FOOTER ===== */
    doc.setFontSize(6);
    doc.setTextColor("#aaaaaa");
    doc.text(hash, 40, 830);

    doc.setFontSize(9);
    doc.setTextColor("#777");
    doc.text(
      "Document sign√© √©lectroniquement par MANG Wallet.",
      40,
      800
    );
    doc.text(
      "Toute modification invalide ce re√ßu.",
      40,
      815
    );

    doc.save(`${receiptNumber}.pdf`);

  } catch (err) {
    console.error(err);
    alert("Erreur g√©n√©ration re√ßu.");
  }
          }
          
/* ================= GLOBAL ================= */

window.createPin = createPin;
window.verifyPin = verifyPin;
window.closeDetail = closeDetail;
          

          
</script>
  
</body>
</html>
