
 
 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <title>MANG ‚Äì March√© Agricole Nouvelle G√©n√©ration | Marketplace Agricole </title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description"
        content="MANG ‚Äì March√© Agricole Nouvelle G√©n√©ration est une plateforme agricole moderne qui connecte producteurs et acheteurs sans interm√©diaires dans le monde entier. Achetez et vendez vos produits agricoles facilement.">

  <meta name="keywords"
        content="MANG, march√© agricole, produits agricoles, vente agricole, achat agricole, producteurs agricoles, agriculture B√©nin, marketplace agricole">

  <meta name="author" content="MANG">

  <meta name="robots" content="index, follow">

  <!-- Canonical -->
  <link rel="canonical" href="https://marketplace2026.github.io/MANG---March-Agricole/">

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="C-6hi3GUuSMI3qTAqdRbDvfP2hnkNwJLQj562HhD_PI" />
  <!-- Open Graph -->
  <meta property="og:title" content="MANG ‚Äì March√© Agricole Nouvelle G√©n√©ration">
  <meta property="og:description"
        content="Plateforme moderne qui connecte producteurs et acheteurs agricoles au B√©nin.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://marketplace2026.github.io/MANG---March-Agricole/">
  <meta property="og:image" content="https://marketplace2026.github.io/MANG---March-Agricole/assets/img/logo.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MANG ‚Äì March√© Agricole Nouvelle G√©n√©ration">
  <meta name="twitter:description"
        content="Marketplace agricole innovante pour producteurs et acheteurs.">
  <meta name="twitter:image" content="https://marketplace2026.github.io/MANG---March-Agricole/assets/img/logo.png">

  <!-- Favicon -->
  <link rel="icon" href="assets/img/logo.png" type="image/png">


<style>
/* ===== GLOBAL ===== */
body {
  margin: 0;
  padding: 10px 15px 15px 15px;
  font-family: Arial, sans-serif;
  background: linear-gradient(
  180deg,
  #f3f8f4 0%,
  #ffffff 100%
);
  overflow-x: hidden;
}

/* ===== HEADER ===== */
header.topbar {
  background:
    linear-gradient(rgba(16,42,35,.85),rgba(16,42,35,.92));
  color: white;
  padding: 15px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

header.topbar span#userEmail {
  font-weight: bold;
  display: block;
}

header.topbar .top-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

header.topbar .top-actions button {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 600;
}
#userEmail{font-size:14px; margin-bottom: 8px;background:rgba(255,255,255,0.2);padding:10px 10px;border-radius:20px; height:25px;
           border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
/* SEARCH BAR */
.search-bar{max-width:950px;margin:10px auto 20px;}
#searchInput{width:80%;padding:14px 18px;border-radius:30px;border:1px solid #cbd5e1;font-size:15px;outline:none;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
#searchInput:focus{border-color:#2e8b57;box-shadow:0 4px 18px rgba(46,139,87,0.3);}

/* ===== BOUTIQUES : 2 PAR LIGNE + SCROLL VERTICAL ===== */
.shops-container{
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* 2 boutiques par ligne */
  gap: 15px;
  padding: 10px 15px;

  max-height: calc(100vh - 220px); /* scroll vertical */
  overflow-y: auto;
  overflow-x: hidden;
}

/* Scrollbar vertical */
.shops-container::-webkit-scrollbar{
  width: 8px;
}
.shops-container::-webkit-scrollbar-thumb{
  background: #2e8b57;
  border-radius: 4px;
}

/* Carte boutique */
.shopCard{
  width: 100%;
  height:auto;
  min-height: 280px;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 5px;
  margin-right:20px;
  background: white;
  text-align: center;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.shopCard:hover{
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.shopCard img{
  width: 100%;
  height: auto;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 5px;
}
.shopCard h4{margin-bottom:4px;}
.shopCard small{color:#555;}
.shopCard button{margin-top:8px;padding:6px 12px;border:none;border-radius:8px;background:#3b82f6;color:white;cursor:pointer;}

/* MODAL BOUTIQUE */
#shopViewModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;}
#shopViewContent{background:white;padding:20px;border-radius:10px;width:90%;max-width:600px;height:95%;overflow-y:auto;position:relative;}
#closeShopView{position:absolute;top:10px;right:15px;cursor:pointer;font-size:20px;}
#shopProductsScroll{display:flex;gap:10px;overflow-x:auto;margin:15px 0;}
#shopProductsScroll::-webkit-scrollbar{height:6px;}
#shopProductsScroll::-webkit-scrollbar-thumb{background:#2e8b57;border-radius:3px;}

.productCard {
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  transition: transform 0.2s;
}

.productCard:hover {
  transform: scale(1.03);
}

.productCard img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}

.productCard h5 {
  margin: 5px 0;
  font-size: 1em;
  color: #333;
}

.productCard p {
  margin: 0;
  font-weight: bold;
  color: #007bff;
}
  
 /* ===== WHATSAPP BUTTON ===== */
#contactShopBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:#25D366;
  color:white;
  padding:10px 18px;
  border-radius:999px;
  font-weight:600;
 font-size:17px;
  margin-top:12px;
  text-decoration:none;
  box-shadow:0 8px 20px rgba(37,211,102,.35);
  transition:.2s;
}

.contactShopBtn:hover{
  transform:translateY(-2px);
  opacity:.9;
}
/* CHAT ET MESSAGERIE (inchang√©s) */
.chat-container{position:fixed;top:0;right:-380px;width:360px;height:100%;background:white;border-left:4px solid #2e8b57;transition:0.3s;z-index:1001;display:flex;flex-direction:column;}
.chat-container.open{right:0;}
.chat-header{background:#2e8b57;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.chat-header button{background:none;border:none;color:white;font-size:20px;cursor:pointer;}
.messages-list{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
.message{max-width:75%;padding:10px 14px;border-radius:18px;}
.message.from{background:#ecf0f1;}
.message.to{background:#2e8b57;color:white;align-self:flex-end;}
.input-area{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #ccc;}
#chatInputContainer{display:flex;flex-direction:column;gap:8px;}
#messageInput{flex:1;padding:10px;border-radius:25px;border:1px solid #ccc;font-size:14px;}
#mediaPreview img,#mediaPreview video,#mediaPreview audio{max-width:120px;border-radius:8px;margin-bottom:8px;}
.btn-send,.btn-file,.btn-audio{border:none;color:white;border-radius:50%;width:44px;height:44px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.btn-send{background:linear-gradient(135deg,#3b82f6,#2563eb);}
.btn-file{background:linear-gradient(135deg,#10b981,#047857);}
.btn-audio{background:linear-gradient(135deg,#f59e0b,#b45309);}
.btn-send:hover,.btn-file:hover,.btn-audio:hover{transform:scale(1.1);box-shadow:0 6px 16px rgba(0,0,0,0.3);}
#discussionsPanel{position:fixed;top:0;right:-400px;width:360px;height:100%;background:#fff;box-shadow:-4px 0 12px rgba(0,0,0,0.2);transition:right 0.3s ease;z-index:1000;display:flex;flex-direction:column;}
.messagerie-header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#2e8b57;color:white;}
.messagerie-header .close-btn{cursor:pointer;font-size:18px;}
.tabs button{flex:1;padding:20px;background:#e5e7eb;border:none;cursor:pointer;font-size:22px;}
#tabVente{width:175px;height:50px;}
#tabAchat{width:175px;height:50px;}
.tabs button.active{background:#2e8b57;color:white;height:50px;width:170px;}
.discussion-item{padding:12px;margin:15px;border-radius:10px;background:#f9f9f9;cursor:pointer;}

  .message {
  position: relative;
  padding: 10px 14px;
  border-radius: 18px;
  max-width: 75%;
  word-wrap: break-word;
}

.message.from {
  background: #ecf0f1;
  align-self: flex-start;
}

.message.to {
  background: #2e8b57;
  color: white;
  align-self: flex-end;
}

.message-actions {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity 0.2s;
}

.message.from .message-actions {
  right: -36px;
}

.message.to .message-actions {
  left: -36px;
}

.message:hover .message-actions {
  opacity: 1;
}

.delete-btn {
  background: #f3f4f6;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  cursor: pointer;
  font-size: 15px;
}

.delete-btn:hover {
  background: #fee2e2;
}
#logoutBtn{background: #c0392b;}
  #sellBtn{background:#f39c12;}
  
  /* ===== LIKE ===== */
#shopLikesSection {
  margin-top: 12px;
}

#likeShopBtn {
  background: #4caf50;
  border: none;
  border-radius: 20px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: bold;
}

  /* ================= COMMENTAIRES ================= */
.comments-section {
  background: #f1f2f6;
  padding: 12px;
  border-radius: 10px;
  height: 60vh;
  display: flex;
  flex-direction: column;
}

.comments-section h4 {
  margin: 0 0 6px;
  font-size: 16px;
}

#commentsList {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px;
}

.commentInputWrapper {
  display: flex;
  align-items: center;
  gap: 6px;
}

#commentInput {
  flex: 1;
  height: 34px;
  padding: 4px 12px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 13px;
}

#sendCommentBtn {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  border: none;
  background: #4caf50;
  color: white;
  cursor: pointer;
}
  
#notifOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#notifPanel {
  width: 95%;
  max-width: 420px;
  background: white;
  border-radius: 12px;
  max-height: 80vh;
  overflow-y: auto;
}

.notifHeader {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-bottom:1px solid #ddd;
}

.notifHeader button {
  font-size:20px;
  background:none;
  border:none;
  cursor:pointer;
}
  .notif-btn {
  position: relative;
  background: none;
  border: none;
  font-size: 15px;
  cursor: pointer;
}

#notifCount {
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  font-size: 10px;
  padding: 2px 5px;
  border-radius: 50%;
  display: none;
}
.favorite-shop-btn {
  margin-top: 8px;
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.favorite-shop-btn.active {
  background: #ffe5e5;
  border-color: red;
}
  /* Overlay sombre */
#topShopsOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* Panneau */
#topShopsPanel {
  background: #fff;
  width: 90%;
  max-width: 420px;
  max-height: 80vh;
  border-radius: 16px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

/* Header */
.topShopsHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.topShopsHeader h3 {
  margin: 0;
  font-size: 18px;
}

#closeTopShops {
  background: none;
  border: none;
  font-size: 26px;
  cursor: pointer;
}

/* Scroll contenu */
#topShopsContainer {
  overflow-y: auto;
  padding-right: 4px;
}
/* ===== BARRE FILTRE ===== */
.filterBar {
  display: flex;
  gap: 10px;
  margin: 15px 0;
}

.filterBtn {
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  background: #2e7d32;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

.filterBtn.secondary {
  background: #607d8b;
}

.filterBtn:hover {
  opacity: 0.9;
}

/* ===== MODALE ===== */
.categoryModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 10px;
}

.categoryModal.hidden {
  display: none;
}

.categoryBox {
  background: #fff;
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  border-radius: 16px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* ===== RECHERCHE ===== */
.categorySearch {
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 10px;
  font-size: 14px;
  outline: none;
}

#categoryList {
  flex: 1;
  overflow-y: auto;
}

/* ===== GROUPE ===== */
.categoryGroupTitle {
  font-weight: bold;
  margin: 12px 0 6px;
  font-size: 14px;
  color: #333;
  border-bottom: 1px solid #eee;
  padding-bottom: 4px;
}

/* ===== SOUS CAT√âGORIE ===== */
.categoryItem {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  margin-bottom: 6px;
  cursor: pointer;
  background: #f7f7f7;
  transition: 0.2s;
  font-size: 14px;
}

.categoryItem:hover {
  background: #e8f5e9;
}

.catIcon {
  font-size: 18px;
}

/* ===== ACTIONS ===== */
.categoryActions {
  margin-top: 10px;
}

#closeCategoryBtn {
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
  background: #e53935;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}
/* CONTENEUR BOUTONS HORIZONTAUX */
.topButtons {
  display: flex;
  gap: 10px;               /* espace entre les boutons */
  padding: 10px;
  overflow-x: auto;         /* scroll horizontal si trop large */
  -webkit-overflow-scrolling: touch; /* scroll smooth sur mobile */
  scrollbar-width: thin;    /* Firefox */
}
#nearbyShopsBtn{
  flex: 0 0 auto;          /* emp√™che les boutons de s‚Äô√©tirer */
  padding: 8px 14px;
  border-radius: 999px;
  border: none;
  background-color: #2e8b57;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  white-space: nowrap;      /* emp√™che le texte de passer √† la ligne */
}
  
/* Scrollbar personnalis√©e */
.topButtons::-webkit-scrollbar {
  height: 6px;
}
.topButtons::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,0.2);
  border-radius: 3px;
}

/* BOUTONS */
.topBtn {
  flex: 0 0 auto;          /* emp√™che les boutons de s‚Äô√©tirer */
  padding: 8px 14px;
  border-radius: 999px;
  border: none;
  background-color: #2e8b57;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
  white-space: nowrap;      /* emp√™che le texte de passer √† la ligne */
}

.topBtn.secondary {
  background-color:  #2e7d32;
}

.topBtn:hover {
  filter: brightness(0.9);
}
 /* ===== LIVRAISON BADGE ===== */
.livraison-badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:999px;
  font-size:.89rem;
  font-weight:600;
  margin-top:8px;
}

.livraison-oui{
  background:#dcfce7;
  color:#166534;
}

.livraison-non{
  background:#fee2e2;
  color:#991b1b;
}


 .whatsapp-band{
  background:#dcfce7;
  color:#166534;
  width:170px;
  padding:6px 14px;
  border-radius:999px;
  font-weight:600;
  text-align:center;
 }

 /* ===== FILTRE LIVRAISON ===== */
.filter-livraison {
  position: relative;
}

#livraisonFilterBtn {
  background: #2e8b57;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 600;
}

/* ===== OPTIONS LIVRAISON (CENTR√âES) ===== */
.livraison-options {
  position: fixed; /* üî• cl√© du centrage */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  
  background: white;
  border-radius: 16px;
  box-shadow: 0 15px 40px rgba(0,0,0,.25);
  overflow: hidden;
  z-index: 2000;

  min-width: 260px;
  text-align: center;
}

/* Option */
.livraison-options div {
  padding: 14px 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
}

/* Hover */
.livraison-options div:hover {
  background: #f3f4f6;
}

/* Masqu√© */
.hidden {
  display: none;
}
 #resetFilterBtn{
  background: #2e8b57;
 }



/* LOGO */
.logo-box{
  display:flex;
  align-items:center;
  gap:0px;
}

.logo-box img{
  height:120px;
  width:100%;
 padding: 0px;
}

.productDesc {
  font-size: 0.85rem;
  color: #4caf50;
  margin: 4px 0;
}

.productAvailability {
  font-size: 0.8rem;
  font-weight: 600;
  color: #2e7d32;
  margin: 4px 0;
}

.productPrice {
  margin-top: 6px;
  font-size: 0.95rem;
   }
.user-header-bar{
  display:flex;
  align-items:center;   /* üî• centre verticalement */
  gap:10px;
}

.profile-circle{
  width:50px;
  height:50px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
      margin-bottom: 8px;
  flex-shrink:0; /* emp√™che d√©formation */
}

#userEmail{
  background:rgba(255,255,255,0.15);
  padding:12px 18px;
  border-radius:30px;
  display:flex;
  align-items:center; /* centre le texte */
  font-weight:600;
border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}

 .premium-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  animation: floatBadge 3s ease-in-out infinite;
  transition: transform 0.3s ease;
}

/* Effet l√©ger flottant */
@keyframes floatBadge {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-3px); }
  100% { transform: translateY(0px); }
}

/* Hover effet */
.premium-badge:hover {
  transform: scale(1.1);
}

/* Premium 1 - Bronze */
.bronze {
  background: linear-gradient(45deg, #cd7f32, #a97142);
  animation: floatBadge 3s ease-in-out infinite, glowBronze 2s infinite alternate;
}

@keyframes glowBronze {
  from { box-shadow: 0 0 5px #cd7f32; }
  to { box-shadow: 0 0 15px #cd7f32; }
}

/* Premium 2 - Silver */
.silver {
  background: linear-gradient(45deg, #bdc3c7, #95a5a6);
  animation: floatBadge 3s ease-in-out infinite, glowSilver 1.5s infinite alternate;
}

@keyframes glowSilver {
  from { box-shadow: 0 0 6px #bdc3c7; }
  to { box-shadow: 0 0 20px #ffffff; }
}

/* Premium 3 - Gold */
.gold {
  background: linear-gradient(45deg, #f1c40f, #f39c12);
  overflow: hidden;
  animation: floatBadge 3s ease-in-out infinite, glowGold 1s infinite alternate;
}

@keyframes glowGold {
  from { box-shadow: 0 0 10px #f1c40f; }
  to { box-shadow: 0 0 25px #ffd700; }
}

/* Effet brillant Premium 3 */
.gold::after {
  content: "";
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: rgba(255,255,255,0.4);
  transform: skewX(-25deg);
  animation: shine 2s infinite;
}

@keyframes shine {
  0% { left: -75%; }
  100% { left: 125%; }
}
#messageBtn {
 position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 150px;
  height: 40px;
  padding: 0 18px;
  background: linear-gradient(135deg, #4facfe, #2a6df4);
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
 #notifBtn {

  position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 80px;
  height: 40px;
  padding: 0 18px;
  background: linear-gradient(135deg, #4facfe, #2a6df4);
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}

 #sellBtn {
  position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 80px;
  height: 40px;
  padding: 0 18px;
  background: #4caf50;
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
 #favoritesBtn {

  position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 150px;
  height: 40px;
  padding: 0 10px;
  background: linear-gradient(135deg, #4facfe, #2a6df4);
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
 .shop-products-scroll {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .productCard {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0.5rem;
    width: 180px;
    text-align: center;
    background: #fff;
  }

  .productCard img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
  }

  .productDesc {
    font-size: 0.85rem;
    margin: 0.25rem 0;
  }

  .productAvailability, .productPrice {
    font-size: 0.9rem;
    margin: 0.25rem 0;
  }

  .favoriteProductBtn, .orderBtn {
    margin-top: 0.25rem;
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .orderBtn {
    background-color: #28a745;
    color: white;
  }

  /* MODALES */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }

  .modal-content {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    width: 300px;
    max-width: 90%;
    position: relative;
  }

  .modal-content .close {
    position: absolute;
    top: 8px;
    right: 12px;
    cursor: pointer;
    font-size: 1.2rem;
  }

  .modal-content input, .modal-content textarea {
    width: 100%;
    margin-bottom: 0.5rem;
    padding: 0.4rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
  }

  .modal-content button {
    width: 100%;
    padding: 0.5rem;
    border: none;
    border-radius: 4px;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  .modal-content button:hover {
    opacity: 0.9;
  }
</style>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "MANG ‚Äì March√© Agricole Nouvelle G√©n√©ration",
  "url": "https://marketplace2026.github.io/MANG---March-Agricole/",
  "logo": "https://marketplace2026.github.io/MANG---March-Agricole/assets/img/logo.png",
  "description": "Plateforme agricole moderne qui connecte producteurs et acheteurs au B√©nin.",
  "sameAs": []
}
</script>
 
</head>
<body>

<header class="topbar">

   <!-- LOGO -->
    <div class="logo-box">
      <img src="assets/img/logos.png" alt="MANG - March√© Agricole Nouvelle G√©n√©ration">
      
    </div>
 
<div class="user-header-bar">
  
  <div class="profile-circle" onclick="goProfile()">üë§</div>


  <span id="userEmail"></span>

</div>
  <div class="top-actions">
    <button id="messageBtn">
      üí¨ Messagerie
      <span id="messageBadge"
        style="
          background:red;
          color:white;
          border-radius:50%;
          padding:2px 6px;
          font-size:12px;
          margin-left:6px;
          display:none;
        ">0</span>
    </button>
     <button id="notifBtn" class="notif-btn">
  üîî <span id="notifCount">0</span>
</button>

<div id="notifOverlay" style="display:none;">
  <div id="notifPanel">
    <div class="notifHeader">
      <h3>Notifications</h3>
      <button id="closeNotif">√ó</button>
    </div>
    <div id="notifList"></div>
  </div>
</div>
<!-- Bouton Favoris avec badge -->
<button id="favoritesBtn" style="position:relative;">
  ‚ù§Ô∏è Favoris
  <span id="favoritesBadge" style="
    display:none;
    position:absolute;
    top:-5px;
    right:-5px;
    background:red;
    color:white;
    font-size:12px;
    padding:2px 6px;
    border-radius:50%;
  ">0</span>
</button>

<!-- Modal Favoris -->
<div id="favoritesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:center;">
  <div style="background:#fff; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; border-radius:12px; padding:16px;">
    <h3>‚ù§Ô∏è Favoris</h3>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="btnFavorisBoutiques">Boutiques</button>
      <button id="btnFavorisProduits">Produits</button>
      
    </div>

    <div id="favoritesShopsList"></div>
    <div id="favoritesProductsList" style="display:none;"></div>
    <div id="favoritesList" style="display:none;"></div> <!-- notifications -->

    <button id="closeFavorites" style="margin-top:12px;width:100%;">Fermer</button>
  </div>
</div>
    
  
  
    <button id="sellBtn">Vendre</button>
  </div>
</header>
  
  <!-- CONTENEUR BOUTONS HORIZONTAUX -->
<div class="topButtons">
 <button id="resetFilterBtn" class="topBtn secondary">üîÑ Toutes les boutiques</button>
 
  <button id="topShopsBtn" class="topBtn">üî• Top boutiques</button>
  <button id="filterCategoryBtn" class="topBtn">üìÇ Cat√©gories</button>
   <button id="livraisonFilterBtn">üöö Livraison</button>
  
  
  <button id="nearbyShopsBtn">
  üìç Boutiques proches
</button>
</div>
  

<!-- MODALE CAT√âGORIES -->
<div id="categoryModal" class="categoryModal hidden">
  <div class="categoryBox">

    <input
      type="text"
      id="categorySearch"
      class="categorySearch"
      placeholder="üîç Rechercher une cat√©gorie..."
    >

    <div id="categoryList"></div>

    <div class="categoryActions">
      <button id="closeCategoryBtn">Fermer</button>
    </div>

  </div>
</div>

  <div id="livraisonOptions" class="livraison-options hidden">
    <div data-value="true">üöö Disponible</div>
    <div data-value="false">üì¶ Non disponible</div>
  </div>
</div>

<!-- OVERLAY TOP BOUTIQUES -->
<div id="topShopsOverlay" style="display:none;">
  <div id="topShopsPanel">
    <div class="topShopsHeader">
      <h3>üî• Top 5 Boutiques</h3>
      <button id="closeTopShops">√ó</button>
    </div>
    <div id="topShopsContainer"></div>
  </div>
</div>
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="üîç Rechercher une boutique...">
</div>
 
  <!-- LISTE DES BOUTIQUES -->
<div class="shops-container" id="shopsList">
  <!-- Les boutiques seront inject√©es ici par JS -->
  
</div>
 
<!-- MODAL VUE BOUTIQUE -->
  <div id="shopViewModal">
  <div id="shopViewContent">
    <span id="closeShopView">‚úï</span>
    <h2 id="shopViewName"></h2>
    <p id="shopViewDesc"></p>
    <p><strong>Cat√©gorie:</strong> <span id="shopViewCategory"></span></p>
    <p><strong>Lieu:</strong> <span id="shopViewLocation"></span></p>
      <!-- ===== BADGE LIVRAISON ===== -->
  <div id="shopViewLivraison" style="margin-top:10px;"></div>

   <!-- ===== NUMERO WHATSAPP (BANDE VERTE) ===== -->
  <div id="shopViewWhatsapp" style="margin-top:10px;"></div>
   
   <button id="contactShopBtn">üí¨ Discuter avec la boutique </button>
  
    <p><strong>Produits disponibles</strong></p>
    <div id="shopProductsScroll"></div>
   
    

    <!-- Likes et commentaires -->
    <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">

      <!-- Bouton Like principal -->
      <button id="likeShopBtn" style="
          padding:4px 8px;
          font-size:12px;
          cursor:pointer;
          border:none;
          border-radius:6px;
          background:#e0f7fa;
          color:#007bff;
          font-weight:500;
          display:flex;
          align-items:center;
          gap:4px;
          transition:0.2s;"
          onmouseover="this.style.background='#b2ebf2'" 
          onmouseout="this.style.background='#e0f7fa'">
        üëç J'aime
      </button>

      <!-- Compteur / point cliquable -->
      <div id="likeCountContainer" style="display:flex; align-items:center; gap:4px; cursor:pointer;">
        <span id="likeCount" style="font-size:12px; color:#555;">0</span>
        <span style="
          display:inline-block;
          width:10px;
          height:10px;
          background:#007bff;
          border-radius:50%;
          transition:0.2s;"
          onmouseover="this.style.background='#005bbb'"
          onmouseout="this.style.background='#007bff'">
        </span>
      </div>
    </div>

    <!-- Liste des utilisateurs likant la boutique -->
    <div id="shopLikesList" style="
        position:absolute;
        display:none;
        background:#fff;
        border:1px solid #ddd;
        border-radius:6px;
        box-shadow:0 2px 8px rgba(0,0,0,0.1);
        padding:8px;
        max-height:200px;
        overflow-y:auto;
        font-size:12px;
        z-index:999;">
    </div>

    <div class="comments-section" style="background:#f1f2f6; padding:10px; border-radius:8px;">
      <h4>Commentaires</h4>
      <div id="commentsList" style="height:400px; overflow-y:auto; margin-bottom:5px;"></div>
    <div class="commentInputWrapper">
  <input type="text" id="commentInput" placeholder="√âcrire un commentaire...">
  <button id="sendCommentBtn">‚û§</button>
</div>

    <!-- ‚úÖ Copier lien boutique (MAINTENANT DANS LE MODAL) -->
    <button id="copyLinkBtn" style="
      margin-top:12px;
      padding:8px 12px;
      background:#17a2b8;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      height:30px;
      width:80%;">
      Copier le lien
    </button>

  </div>
</div>
</div>
<!-- Chat et Messagerie restent inchang√©s -->
<div class="chat-container" id="chatContainer">
  <div class="chat-header">
    <span id="chatTitle">Discussion</span>
    <div>
      <button onclick="openShopStats()">üìä</button>
      <button id="deleteChat">üóëÔ∏è</button>
      <button id="closeChat">‚úï</button>
    </div>
  </div>
  <div id="shopStats"
     style="
       display:none;
       padding:12px;
       background:#f7f7f7;
       border-bottom:1px solid #ddd;
       font-size:14px;
     ">
  </div>
  <div id="shopStatsModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:10000;
  justify-content:center;
  align-items:center;
">
  <div style="
    background:#fff;
    padding:16px;
    border-radius:12px;
    width:90%;
    max-width:320px;
  ">
    <h3>üìä Statistiques</h3>
    <div id="shopStatsContent"></div>
    <button onclick="closeShopStats()" style="margin-top:12px;width:100%;">
      Fermer
    </button>
  </div>
</div>
  <div class="messages-list" id="messagesList"></div>
  <div class="input-area">
    <div id="chatInputContainer">
      <div id="mediaPreview"></div>
      <div style="display:flex; gap:8px; align-items:center; width:100%;">
        <button id="fileBtn" class="btn-file">üìé</button>
        <input type="text" id="messageInput" placeholder="√âcris un message...">
        <button id="sendBtn" class="btn-send">‚û§</button>
        <button id="audioBtn" class="btn-audio">üé§</button>
      </div>
      <input type="file" id="fileInput" style="display:none;" accept="image/*,video/*,audio/*">
    </div>
  </div>
</div>

<div id="discussionsPanel">
  <div class="messagerie-header">
    <strong>Messagerie</strong>
    <span class="close-btn" id="closeMessagerie">‚úï</span>
  </div>
  <div class="tabs">
  <button id="tabAchat" class="active">Achat</button>
  <button id="tabVente" >Vente</button>
</div>
<div id="discussionsList"></div>
</div>

<div id="mediaModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10000;">
  <div id="mediaContent" style="max-width:90%; max-height:90%;"></div>
  <span id="closeMediaModal" style="position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer; font-weight:bold;">‚úï</span>
</div>

<!-- CONTENEUR PRODUITS -->
<div id="shopProductsScroll" class="shop-products-scroll"></div>

<!-- ===========================
MODALE COMMANDE
=========================== -->
<div id="orderModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeOrderModal()">&times;</span>
    <h3>Renseignez vos informations de livraison</h3>
    
    <label>Adresse de livraison *</label>
    <input id="orderAddress" type="text" placeholder="Adresse compl√®te">

    <label>T√©l√©phone *</label>
    <input id="orderPhone" type="text" placeholder="Num√©ro de t√©l√©phone">

    <label>Note (optionnelle)</label>
    <textarea id="orderNote" placeholder="Ex: Heure de livraison souhait√©e"></textarea>

    <button id="createOrderBtn">Cr√©er la commande</button>
  </div>
</div>

<!-- ===========================
MODALE PAIEMENT
=========================== -->
<div id="paymentModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closePaymentModal()">&times;</span>
    <h3>Paiement de la commande</h3>
    
    <p>Montant : <strong><span id="paymentAmount">0</span> FCFA</strong></p>
    <p>L‚Äôargent sera bloqu√© en escrow jusqu‚Äô√† livraison.</p>

    <button id="payOrderBtn">Payer maintenant</button>
  </div>
</div>
  
<script type="module">
import { supabase } from './supabase.js';

// ====== UTILISATEUR CONNECT√â + BADGE PREMIUM (MULTI NIVEAUX) ======

let currentUser = null;
let currentProfile = null;

async function loadCurrentUser() {

  const { data, error } = await supabase.auth.getUser();

  if (error || !data.user) {
    location.href = "login.html";
    return;
  }

  currentUser = data.user;

  const emailElement = document.getElementById("userEmail");
  if (!emailElement) return;

  emailElement.textContent = currentUser.email;

  const { data: profile } = await supabase
    .from('profiles')
    .select('premium_level, premium_end')
    .eq('id', currentUser.id)
    .maybeSingle();

  if (!profile) return;

  currentProfile = profile;

  const now = new Date();
  const premiumEnd = profile.premium_end
    ? new Date(profile.premium_end)
    : null;

  let badge = '';

  // ===== PREMIUM ACTIF =====
  if (profile.premium_level && premiumEnd && premiumEnd > now) {

    switch (profile.premium_level) {
      case 'premium1': badge = ' ‚≠ê'; break;
      case 'premium2': badge = ' ‚≠ê‚≠ê'; break;
      case 'premium3': badge = ' ‚≠ê‚≠ê‚≠ê'; break;
    }

  }

  // ===== PREMIUM EXPIR√â =====
  else if (profile.premium_level && premiumEnd && premiumEnd <= now) {

    await supabase
      .from('profiles')
      .update({
        premium_level: null,
        premium_start: null,
        premium_end: null
      })
      .eq('id', currentUser.id);

    badge = '';
  }

  emailElement.textContent = currentUser.email + badge;
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadCurrentUser();
  initNotifications();
});

  // ====== BOUTON VENDRE ======
const sellBtn = document.getElementById("sellBtn");
sellBtn.onclick = () => {
  // Rediriger vers la page vente.html
  location.href = "vente.html";
};
  window.goProfile = function(){
  window.location.href = "profile.html";
 }
  // Mettre √† jour le statut en ligne de l'utilisateur
async function setUserOnline() {
  if (!currentUser) return;
  await supabase
    .from('profiles')
    .update({ last_seen: new Date().toISOString() })
    .eq('id', currentUser.id);
}

// Envoyer la premi√®re fois
setUserOnline();

// Ping toutes les 30 secondes pour garder le statut en ligne
setInterval(setUserOnline, 30000);
  function isUserOnline(lastSeen) {
  if (!lastSeen) return false;
  const diff = (new Date() - new Date(lastSeen)) / 1000; // en secondes
  return diff < 120; // moins de 2 minutes = en ligne
}
// ====== ELEMENTS DOM ======
const shopsList = document.getElementById("shopsList");
const modal = document.getElementById("shopViewModal");
const closeModal = document.getElementById("closeShopView");
const shopViewName = document.getElementById("shopViewName");
const shopViewDesc = document.getElementById("shopViewDesc");
const shopViewCategory = document.getElementById("shopViewCategory");
const shopViewLocation = document.getElementById("shopViewLocation");
const shopProductsScroll = document.getElementById("shopProductsScroll");
const contactShopBtn = document.getElementById("contactShopBtn");
  
  const likeShopBtn = document.getElementById('likeShopBtn');
const likeCountEl = document.getElementById('likeCount');
const shopLikesList = document.getElementById("shopLikesList");
const likeCountContainer = document.getElementById("likeCountContainer");

const commentsList = document.getElementById('commentsList');
const commentInput = document.getElementById('commentInput');
const sendCommentBtn = document.getElementById('sendCommentBtn');

const copyLinkBtn = document.getElementById('copyLinkBtn');



const tabAchat = document.getElementById("tabAchat"); // Achat
const tabVente = document.getElementById("tabVente"); // Vente

const chatContainer = document.getElementById("chatContainer");
const chatTitle = document.getElementById("chatTitle");
const messagesList = document.getElementById("messagesList");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("fileInput");
const audioBtn = document.getElementById("audioBtn");
const mediaPreview = document.getElementById("mediaPreview");
document.addEventListener("DOMContentLoaded", () => {
  updateUnreadBadge();
  
});
// ====== VARIABLES ======
let currentShop = null;
let mediaRecorder = null;
let audioChunks = [];
let pendingFile = null;

const messageBtn = document.getElementById("messageBtn");
const discussionsPanel = document.getElementById("discussionsPanel");
const closeMessagerie = document.getElementById("closeMessagerie");
const discussionsList = document.getElementById("discussionsList");
  
 
// Fermer modal boutique
closeModal.onclick = () => modal.style.display = "none";

// Ouvrir messagerie et mettre √† jour badge
messageBtn.onclick = () => {
  discussionsPanel.style.display = "block";
  discussionsPanel.style.right = "0";

  // üî• FORCER LE REPAINT
  discussionsPanel.offsetHeight;
};
// Fermer messagerie
closeMessagerie.onclick = () => discussionsPanel.style.right = "-400px";

// Fermer chat
document.getElementById("closeChat").onclick = () => chatContainer.classList.remove("open");

  
  
// Changer onglets Achat / Vente
tabAchat.onclick = async () => {
  tabAchat.classList.add("active");
  tabVente.classList.remove("active");
  discussionsList.innerHTML = ""; // vider la liste avant de recharger
  if (currentUser) await loadDiscussionsAchat();
};

tabVente.onclick = async () => {
  tabVente.classList.add("active");
  tabAchat.classList.remove("active");
  discussionsList.innerHTML = ""; // vider la liste avant de recharger
  if (currentUser) await loadDiscussionsVente();
};
  
  const nearbyShopsBtn = document.getElementById("nearbyShopsBtn");
const maxDistance = 15; // km maximum √† afficher

// Fonction calcul distance en km
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // rayon terre en km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Charger boutiques depuis Supabase
async function loadNearbyShops() {
  try {
    const { data: shops, error } = await supabase.from("shops").select("*");
    if (error) throw error;
    if (!shops || shops.length === 0) {
      alert("Aucune boutique trouv√©e");
      return;
    }

    // R√©cup√©rer la position de l'utilisateur
    navigator.geolocation.getCurrentPosition(async pos => {
      const userLat = pos.coords.latitude;
      const userLon = pos.coords.longitude;

      // Filtrer boutiques proches
      const nearby = shops.filter(shop => {
        if (!shop.latitude || !shop.longitude) return false;
        const dist = distanceKm(userLat, userLon, shop.latitude, shop.longitude);
        shop.distance = dist; // stocker distance pour affichage
        return dist <= maxDistance;
      });

      // Trier par proximit√©
      nearby.sort((a,b) => a.distance - b.distance);

      // Affichage
      const shopsList = document.getElementById("shopsList"); // ton container
      shopsList.innerHTML = "";

      if (nearby.length === 0) {
        shopsList.innerHTML = "<p>Aucune boutique √† moins de "+maxDistance+" km</p>";
        return;
      }

      nearby.forEach(shop => {
        const div = document.createElement("div");
        div.className = "shopCard";
        div.innerHTML = `
          <h3>${shop.name}</h3>
          <p>${shop.description || ""}</p>
          <p>Distance : ${shop.distance.toFixed(1)} km</p>
        `;
        shopsList.appendChild(div);
      });

    }, err => {
      alert("Impossible de r√©cup√©rer votre position : " + err.message);
    });

  } catch(err) {
    console.error(err);
    alert("Erreur lors du chargement des boutiques");
  }
}

// √âv√©nement bouton
nearbyShopsBtn.onclick = loadNearbyShops;
  
console.log("‚úÖ JS ACHAT ‚Äì FILTRE CAT√âGORIES INITIALIS√â");

/* ==============================
   CAT√âGORIES
============================== */
const categories = [
  {
    name: "Production v√©g√©tale",
    icon: "üå±",
    color: "#E8F5E9",
    items: [
      "C√©r√©ales & grains",
      "L√©gumes",
      "Fruits",
      "Racines & tubercules",
      "Plantes industrielles",
      "Plantes aromatiques & m√©dicinales"
    ]
  },
  {
    name: "Production animale",
    icon: "üêÑ",
    color: "#FFF3E0",
    items: [
      "Bovins",
      "Ovins & caprins",
      "Porcins",
      "Aviculture",
      "Apiculture",
      "Pisciculture & aquaculture"
    ]
  },
  {
    name: "Transformation agricole",
    icon: "üçØ",
    color: "#FCE4EC",
    items: [
      "Produits c√©r√©aliers transform√©s",
      "Produits fruitiers transform√©s",
      "Produits tubercules transform√©s",
      "Produits animaux transform√©s"
    ]
  },
  {
    name: "Machines & √©quipements agricoles",
    icon: "üöú",
    color: "#E3F2FD",
    items: [
      "Machines lourdes",
      "√âquipements motoris√©s",
      "Outils agricoles",
      "Irrigation & √©nergie",
      "Pi√®ces & maintenance"
    ]
  },
  {
    name: "Intrants agricoles",
    icon: "üåø",
    color: "#E0F2F1",
    items: [
      "Semences & plants",
      "Engrais organiques",
      "Engrais chimiques",
      "Amendements du sol",
      "Produits phytosanitaires"
    ]
  },
  {
    name: "Espaces verts",
    icon: "üå≥",
    color: "#E8F8F5",
    items: [
      "Plantes ornementales",
      "Arbres & arbustes",
      "Gazon & pelouses",
      "Fleurs & p√©pini√®res",
      "Am√©nagement paysager",
      "Entretien des espaces verts",
      "Mat√©riel de jardinage"
    ]
  },
  {
    name: "Services agricoles",
    icon: "üõ†Ô∏è",
    color: "#F3E5F5",
    items: [
      "Labour & pr√©paration du sol",
      "R√©colte & battage",
      "Transport & logistique",
      "Stockage & conservation",
      "Formation & conseil",
      "Commercialisation & export"
    ]
  }
];

/* ==============================
   R√âCUP DOM (SANS DOMContentLoaded)
============================== */
const filterCategoryBtn = document.getElementById("filterCategoryBtn");
const resetFilterBtn    = document.getElementById("resetFilterBtn");
const categoryModal     = document.getElementById("categoryModal");
const categoryList      = document.getElementById("categoryList");
const categorySearch    = document.getElementById("categorySearch");
const closeCategoryBtn  = document.getElementById("closeCategoryBtn");

/* ==============================
   V√âRIFICATION FORC√âE
============================== */
if (!filterCategoryBtn) console.error("‚ùå filterCategoryBtn introuvable");
if (!resetFilterBtn)    console.error("‚ùå resetFilterBtn introuvable");
if (!categoryModal)     console.error("‚ùå categoryModal introuvable");
if (!categoryList)      console.error("‚ùå categoryList introuvable");
if (!categorySearch)    console.error("‚ùå categorySearch introuvable");
if (!closeCategoryBtn)  console.error("‚ùå closeCategoryBtn introuvable");

/* ==============================
   OUVERTURE MODALE
============================== */
filterCategoryBtn.onclick = () => {
  console.log("üìÇ Bouton Cat√©gories cliqu√©");
  categoryModal.classList.remove("hidden");
  categoryModal.style.display = "flex";
  document.body.style.overflow = "hidden";
  categorySearch.value = "";
  renderCategoryList("");
};

/* ==============================
   FERMETURE MODALE
============================== */
function closeCategoryModal() {
  console.log("‚ùå Fermeture modale");
  categoryModal.classList.add("hidden");
  categoryModal.style.display = "none";
  document.body.style.overflow = "auto";
}

closeCategoryBtn.onclick = closeCategoryModal;

categoryModal.onclick = () => closeCategoryModal();

const categoryBox = categoryModal.querySelector(".categoryBox");
if (categoryBox) {
  categoryBox.onclick = e => e.stopPropagation();
}

/* ==============================
   AFFICHAGE DES CAT√âGORIES
============================== */
function renderCategoryList(filter = "") {
  console.log("üìã Render cat√©gories :", filter);
  categoryList.innerHTML = "";

  categories.forEach(group => {
    const title = document.createElement("div");
    title.className = "categoryGroupTitle";
    title.textContent = `${group.icon} ${group.name}`;
    categoryList.appendChild(title);

    group.items.forEach(item => {
      const txt = `${group.name} ${item}`.toLowerCase();
      if (filter && !txt.includes(filter.toLowerCase())) return;

      const div = document.createElement("div");
      div.className = "categoryItem";
      div.style.background = group.color;
      div.innerHTML = `
        <span class="catIcon">${group.icon}</span>
        <span>${item}</span>
      `;

      div.onclick = () => {
        console.log("‚úÖ Filtre :", group.name, item);
        applyCategoryFilter(group.name, item);
        closeCategoryModal();
      };

      categoryList.appendChild(div);
    });
  });
}

/* ==============================
   FILTRAGE DES BOUTIQUES
============================== */
function applyCategoryFilter(mainCategory, subCategory) {
  const shops = document.querySelectorAll(".shopCard");

  shops.forEach(shop => {
    const raw = shop.dataset.category;
    if (!raw) {
      shop.style.display = "none";
      return;
    }

    // üîπ Normalisation
    const text = raw.toLowerCase();

    const main = mainCategory.toLowerCase();
    const sub  = subCategory.toLowerCase();

    // üîπ D√©couper les sous-cat√©gories
    // Exemple : "Agriculture ¬∑ Fruits, L√©gumes"
    const parts = text.split("¬∑");
    const shopMain = parts[0]?.trim() || "";
    const shopSubs = parts[1]
      ? parts[1].split(",").map(s => s.trim())
      : [];

    // üîπ V√©rification
    const match =
      shopMain === main &&
      shopSubs.includes(sub);

    shop.style.display = match ? "block" : "none";
  });
}
/* ==============================
   RESET : TOUTES LES BOUTIQUES
============================== */
resetFilterBtn.onclick = () => {
  console.log("üîÑ Reset total filtres");

  selectedCategory = null;
  livraisonFilter = null;

  loadShops();
};
/* ==============================
   RECHERCHE
============================== */
categorySearch.oninput = () => {
  renderCategoryList(categorySearch.value);
};
    
    
            
    // ===================================
// üîî NOTIFICATIONS SYSTEM (OVERLAY SPA VERSION ‚Äì VERSION FINALE)
// ===================================

let notifChannel = null;

// üîπ Ic√¥nes
function notifIcon(type) {
  switch (type) {
    case "favorite_shop": return "‚≠ê";
    case "favorite_product": return "‚ù§Ô∏è";
    case "comment": return "üí¨";
    case "like": return "üëç";
    case "new_product": return "üÜï";
    case "deleted_product": return "‚ùå";
    default: return "üîî";
  }
}

// üîπ LOAD NOTIFICATIONS
async function loadNotifications() {
  if (!currentUser) return;

  const { data, error } = await supabase
    .from("notif_market")
    .select("*")
    .eq("user_id", currentUser.id)
    .eq("is_deleted", false)
    .order("created_at", { ascending: false })
    .limit(50);

  if (error) {
    console.error("Erreur notifications:", error);
    return;
  }

  const list = document.getElementById("notifList");
  if (!list) return;
  list.innerHTML = "";

  let unreadCount = 0;

  if (!data || data.length === 0) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:#777">Aucune notification</div>`;
    updateNotifBadge(0);
    return;
  }

  data.forEach(n => {
    if (!n.is_read) unreadCount++;

    const item = document.createElement("div");
    item.style = `
      padding:14px;
      border-bottom:1px solid #eee;
      background:${n.is_read ? "#fff" : "#eef6ff"};
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      transition:0.2s;
    `;

    const content = document.createElement("div");
    content.style = "flex:1; display:flex; gap:12px;";
    content.innerHTML = `
      <div style="font-size:22px">${notifIcon(n.type)}</div>
      <div>
        <strong>${n.title}</strong>
        <div style="font-size:14px;color:#555">${n.message}</div>
        <div style="font-size:12px;color:#999">${new Date(n.created_at).toLocaleString()}</div>
      </div>
    `;

    // üî• CLICK NOTIFICATION
    content.addEventListener("click", async () => {
      // Marquer comme lu
      if (!n.is_read) {
        await supabase.from("notif_market").update({ is_read: true }).eq("id", n.id);
        n.is_read = true;
        item.style.background = "#fff";
        updateNotifBadge();
      }

      // Fermer overlay
      const overlay = document.getElementById("notifOverlay");
      if (overlay) overlay.style.display = "none";

      // Redirection SPA
      redirectNotification(n);
    });

    // üîπ DELETE BUTTON
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "üóëÔ∏è";
    deleteBtn.style = `
      background:#e53935;
      border:none;
      color:white;
      padding:5px 8px;
      border-radius:6px;
      cursor:pointer;
    `;
    deleteBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      await supabase.from("notif_market").update({ is_deleted: true }).eq("id", n.id);
      item.remove();
      updateNotifBadge();
    });

    item.appendChild(content);
    item.appendChild(deleteBtn);
    list.appendChild(item);
  });

  updateNotifBadge(unreadCount);
}

// üîπ REDIRECTION (SPA ‚Äì ATTENTE DOM)
async function redirectNotification(n) {
  if (!n || !n.target_type || !n.target_id) return;

  console.log("‚û°Ô∏è Redirection SPA:", n);

  switch (n.target_type) {

    case "shop": {
      const { data: shop, error } = await supabase.from("shops").select("*").eq("id", n.target_id).single();
      if (!shop || error) return console.error("Boutique introuvable");
      await openShop(shop);
      break;
    }

    case "product": {
      const { data: product, error } = await supabase
        .from("shop_products")
        .select("*, shops(*)")
        .eq("id", n.target_id)
        .single();

      if (!product || error) return console.error("Produit introuvable");
      await openShop(product.shops);

      // üîπ Scroll vers le produit une fois inject√©
      const waitForProduct = () => {
        const el = document.querySelector(`.favoriteProductBtn[data-id="${product.id}"]`);
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          el.closest(".productCard").style.boxShadow = "0 0 0 3px #007bff";
          setTimeout(() => el.closest(".productCard").style.boxShadow = "0 6px 18px rgba(0,0,0,0.12)", 2000);
        } else {
          setTimeout(waitForProduct, 200);
        }
      };
      waitForProduct();
      break;
    }

    case "comment": {
      const { data: shop, error } = await supabase.from("shops").select("*").eq("id", n.target_id).single();
      if (!shop || error) return console.error("Boutique introuvable pour commentaire");
      await openShop(shop);

      // üîπ Scroll vers section commentaires
      const waitForComments = () => {
        const section = document.getElementById("commentsSection");
        if (section) section.scrollIntoView({ behavior: "smooth" });
        else setTimeout(waitForComments, 200);
      };
      waitForComments();
      break;
    }

    case "profile":
      if (typeof loadProfile === "function") loadProfile(n.target_id);
      break;

    default:
      console.warn("Type inconnu :", n.target_type);
  }
}

// üîπ BADGE
function updateNotifBadge(count = null) {
  const badge = document.getElementById("notifCount");
  if (!badge) return;

  if (count === null) {
    supabase
      .from("notif_market")
      .select("*", { count: "exact", head: true })
      .eq("user_id", currentUser.id)
      .eq("is_read", false)
      .eq("is_deleted", false)
      .then(({ count }) => {
        badge.textContent = count || 0;
        badge.style.display = count > 0 ? "inline-block" : "none";
      });
  } else {
    badge.textContent = count;
    badge.style.display = count > 0 ? "inline-block" : "none";
  }
}

// üîπ REALTIME
function initNotifRealtime() {
  if (!currentUser || notifChannel) return;

  notifChannel = supabase
    .channel("notif-market")
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "notif_market",
      filter: `user_id=eq.${currentUser.id}`
    }, () => loadNotifications())
    .subscribe();
}

// üîπ UI OVERLAY
function initNotifUI() {
  const btn = document.getElementById("notifBtn");
  const overlay = document.getElementById("notifOverlay");
  const close = document.getElementById("closeNotif");
  if (!btn || !overlay || !close) return;

  btn.onclick = () => { overlay.style.display = "flex"; loadNotifications(); };
  close.onclick = () => overlay.style.display = "none";
  overlay.addEventListener("click", e => { if (e.target === overlay) overlay.style.display = "none"; });
}

// üîπ INIT
function initNotifications() {
  if (!currentUser) return;
  initNotifUI();
  loadNotifications();
  initNotifRealtime();
}

document.addEventListener("DOMContentLoaded", () => initNotifications());
      

  
    const waitForTopBtn = setInterval(() => {
  const topBtn = document.getElementById("topShopsBtn");
  const overlay = document.getElementById("topShopsOverlay");
  const closeBtn = document.getElementById("closeTopShops");
  const container = document.getElementById("topShopsContainer");

  if (!topBtn || !overlay || !closeBtn || !container) return;

  clearInterval(waitForTopBtn);

  console.log("‚úÖ Top boutiques JS attach√©");

  topBtn.onclick = async () => {
    overlay.style.display = "flex";
    container.innerHTML = "<p>Chargement des top boutiques...</p>";

    // 1Ô∏è‚É£ R√©cup√©rer boutiques
    const { data: shops, error: shopErr } = await supabase
      .from("shops")
      .select("*");

    if (shopErr || !shops) {
      console.error(shopErr);
      container.innerHTML = "<p>Erreur chargement boutiques</p>";
      return;
    }

    // 2Ô∏è‚É£ R√©cup√©rer favoris
    const { data: favs, error: favErr } = await supabase
      .from("favorite_shops")
      .select("shop_id");

    if (favErr) {
      console.error(favErr);
      container.innerHTML = "<p>Erreur chargement favoris</p>";
      return;
    }

    // 3Ô∏è‚É£ Comptage global
    const countMap = {};
    favs.forEach(f => {
      countMap[f.shop_id] = (countMap[f.shop_id] || 0) + 1;
    });

    // 4Ô∏è‚É£ Top 5
    const topShops = shops
      .map(s => ({ ...s, favCount: countMap[s.id] || 0 }))
      .sort((a, b) => b.favCount - a.favCount)
      .slice(0, 5);

    container.innerHTML = "";

    if (topShops.length === 0) {
      container.innerHTML = "<p>Aucune boutique suivie</p>";
      return;
    }

    // ‚≠ê utilitaire premium
    const getPremiumStars = (level) => {
      switch (level) {
        case "premium3": return "‚≠ê‚≠ê‚≠ê";
        case "premium2": return "‚≠ê‚≠ê";
        case "premium1": return "‚≠ê";
        default: return "‚Äî";
      }
    };

    // 5Ô∏è‚É£ Affichage cartes
    topShops.forEach((shop, index) => {
      const div = document.createElement("div");
      div.style.cssText = `
        position:relative;
        display:flex;
        gap:30px;
        padding:10px;
        margin-bottom:10px;
        background:#fff;
        border-radius:12px;
        box-shadow:0 4px 10px rgba(0,0,0,0.08);
        cursor:pointer;
        align-items:center;
      `;

      div.innerHTML = `
        <div style="
          position:absolute;
          top:-8px;
          left:-3px;
          width:28px;
          height:28px;
          border-radius:50%;
          background:#e74c3c;
          color:white;
          font-weight:700;
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:14px;
        ">
          ${index + 1}
        </div>

        <img 
          src="${shop.image_url || 'https://via.placeholder.com/80'}"
          style="width:70px;height:70px;border-radius:10px;object-fit:cover;"
        >

        <div style="flex:1;display:flex;flex-direction:column;gap:3px;">
          <strong style="font-size:15px;">${shop.name}</strong>

          <span style="font-size:13px;color:#f1c40f;font-weight:600;">
            Statut : ${getPremiumStars(shop.premium_level)}
          </span>

          <span style="font-size:13px;color:#e74c3c;font-weight:600;">
            ‚ù§Ô∏è ${shop.favCount >= 1000 
              ? (shop.favCount / 1000).toFixed(1) + "k" 
              : shop.favCount
            } abonn√©s
          </span>

          <div style="display:flex;gap:6px;margin-top:4px;">
            <button 
              class="favoriteShopBtn"
              data-shop-id="${shop.id}"
              style="
                padding:4px 8px;
                border-radius:16px;
                border:1px solid #ddd;
                background:white;
                cursor:pointer;
                font-size:13px;
                display:flex;
                align-items:center;
                gap:5px;
              "
            >
              <span class="favIcon">ü§ç</span>
              <span class="favText">Suivre</span>
              <span class="favCount">0</span>
            </button>

            <button
              class="openShopBtn"
              style="
                padding:4px 8px;
                border:none;
                border-radius:8px;
                background:#2e8b57;
                color:white;
                font-size:13px;
                cursor:pointer;
              "
            >
              Ouvrir
            </button>
          </div>
        </div>
      `;

      // Boutons
      div.querySelector(".favoriteShopBtn").onclick = (e) => {
        e.stopPropagation();
        toggleFavoriteShop(shop.id, e.currentTarget);
      };

      div.querySelector(".openShopBtn").onclick = (e) => {
  e.stopPropagation();
  overlay.style.display = "none";
  openShop(shop);
};

      // Init bouton √©tat + compteur
      initFavoriteShop(shop.id, div.querySelector(".favoriteShopBtn"));

      // clic carte = fermer panel puis ouvrir boutique
div.onclick = () => {
  overlay.style.display = "none"; // fermer le panel
  openShop(shop); // ouvrir la boutique
};
      container.appendChild(div);
    });
  };

  // FERMETURE
  closeBtn.onclick = () => {
    overlay.style.display = "none";
  };

  // Click en dehors du panel = fermer
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.style.display = "none";
  };
}, 100);
      
      
let selectedCategory = null;
let livraisonFilter = null;

document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ Page charg√©e ‚Üí chargement boutiques");
  loadShops();
});

const livraisonBtn = document.getElementById("livraisonFilterBtn");
const livraisonOptions = document.getElementById("livraisonOptions");

livraisonBtn.onclick = () => {
  livraisonOptions.classList.toggle("hidden");
};
document.querySelectorAll("#livraisonOptions div").forEach(option => {
  option.onclick = () => {
    livraisonFilter = option.dataset.value === "true";
    livraisonOptions.classList.add("hidden");

    loadShops(); // üî• recharger les boutiques avec filtre
  };
});
  
 
// ====== CHARGER BOUTIQUES (PRO + STATUS PREMIUM) ======
async function loadShops() {

  try {
    let query = supabase
      .from('shops')
      .select('*')
      .order('created_at', { ascending: false });

    // üîπ Filtre cat√©gorie
    if (selectedCategory) {
      query = query.eq('category', selectedCategory);
    }

    // üîπ Filtre livraison
    if (livraisonFilter !== null) {
      query = query.eq('livraison', livraisonFilter);
    }

    const { data: shops, error } = await query;

    if (error) {
      console.error("Erreur loadShops:", error);
      shopsList.innerHTML = "<p style='color:red;'>Erreur chargement boutiques</p>";
      return;
    }

    if (!shops || shops.length === 0) {
      shopsList.innerHTML = "<p>Aucune boutique trouv√©e</p>";
      return;
    }

    // üîπ R√©cup√©rer les profils des propri√©taires
    const ownerIds = shops.map(s => s.owner_id);

    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, username, premium_level')
      .in('id', ownerIds);

    // üîπ Associer boutique + profil
    shops.forEach(shop => {
      const profile = profiles?.find(p => p.id === shop.owner_id);

      shop.ownerUsername = profile?.username || "Utilisateur";
      shop.premium_level = profile?.premium_level || 'free';

      // üîπ Score premium (pour tri)
      switch (shop.premium_level) {
        case 'premium3': shop.premiumScore = 3; break;
        case 'premium2': shop.premiumScore = 2; break;
        case 'premium1': shop.premiumScore = 1; break;
        default: shop.premiumScore = 0;
      }

      // üîπ √âtoiles affich√©es
      switch (shop.premium_level) {
        case 'premium3': shop.stars = '‚≠ê‚≠ê‚≠ê'; break;
        case 'premium2': shop.stars = '‚≠ê‚≠ê'; break;
        case 'premium1': shop.stars = '‚≠ê'; break;
        default: shop.stars = '‚Äî';
      }
    });

    // üîπ Trier par premium d√©croissant
    shops.sort((a, b) => b.premiumScore - a.premiumScore);

    // üîπ Affichage cartes
    shopsList.innerHTML = "";

    shops.forEach(shop => {

      const div = document.createElement("div");
      div.className = "shopCard";

      div.dataset.category = shop.category || "";
      div.dataset.description = shop.description || "";

      // üî• BADGE PREMIUM DYNAMIQUE
      let premiumBadge = "";

      if (shop.premium_level === "premium3") {
        premiumBadge = `<span class="premium-badge gold">ü•á Premium 3</span>`;
      } 
      else if (shop.premium_level === "premium2") {
        premiumBadge = `<span class="premium-badge silver">ü•à Premium 2</span>`;
      } 
      else if (shop.premium_level === "premium1") {
        premiumBadge = `<span class="premium-badge bronze">ü•â Premium 1</span>`;
      }

      div.innerHTML = `
        <div style="position:relative;">
          <img src="${shop.image_url || 'https://via.placeholder.com/300x160'}" 
               alt="${shop.name}" 
               style="width:100%;height:160px;object-fit:cover;">

          ${premiumBadge}
        </div>

        <div style="padding:12px; display:flex; flex-direction:column; gap:4px;">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#2c3e50;">
            ${shop.name}
          </h3>

          <span style="color:#555;font-size:15px;">
            Propri√©taire : ${shop.ownerUsername}
          </span>

          <span style="color:#f1c40f;font-weight:600;font-size:15px;">
            Statut : ${shop.stars}
          </span>

          <p style="color:#777;font-size:15px;min-height:40px;line-height:1.3;">
            ${shop.description || ""}
          </p>

          <div style="display:flex; flex-direction:column; gap:8px;">

            <button class="favoriteShopBtn"
              data-shop-id="${shop.id}"
              style="
                padding:4px 8px;
                font-size:12px;
                cursor:pointer;
                border:none;
                border-radius:6px;
                background:#e0f7fa;
                color:#007bff;
                font-weight:500;
                display:flex;
                align-items:center;
                gap:4px;
                transition:0.2s;"
              onmouseover="this.style.background='#b2ebf2'" 
              onmouseout="this.style.background='#e0f7fa'">

              <span class="favIcon">ü§ç</span>
              <span class="favText">Suivre</span>
              <span class="favCount">0</span>
            </button>

            <button class="openShopBtn"
              style="
                padding:8px;
                border:none;
                border-radius:10px;
                background:green;
                color:white;
                font-weight:600;
                cursor:pointer;
                transition:0.2s;
                width:100%;">
              Ouvrir la boutique
            </button>

          </div>
        </div>
      `;

      
      const favBtn = div.querySelector(".favoriteShopBtn");

favBtn.onclick = () => toggleFavoriteShop(shop.id, favBtn);

// Initialiser l‚Äô√©tat (d√©j√† suivi ou non)
initFavoriteShop(shop.id, favBtn);
      
      // Bouton hover
      const btn = div.querySelector(".openShopBtn");
      btn.onmouseover = () => btn.style.background = "#27ae60";
      btn.onmouseout = () => btn.style.background = "#2e8b57";

      // Carte hover lift
      div.onmouseover = () => div.style.transform = "translateY(-4px)";
      div.onmouseout = () => div.style.transform = "translateY(0)";
      div.style.transition = "0.25s";
      div.style.boxShadow = "0 6px 18px rgba(0,0,0,0.12)";
      div.style.borderRadius = "12px";
      div.style.background = "#fff";
      div.style.overflow = "hidden";

      // Click ouvrir boutique
      div.querySelector(".openShopBtn").onclick = () => openShop(shop);

      shopsList.appendChild(div);
    });

  } catch(err) {
    console.error("Erreur inattendue loadShops:", err);
    shopsList.innerHTML = "<p style='color:red;'>Erreur inattendue lors du chargement</p>";
  }
}
  
  // üîπ Formater le compteur
function formatCount(count) {
  if (!count) return "0";
  if (count >= 1000) return (count / 1000).toFixed(1) + "k";
  return count.toString();
}

// üîπ Initialiser le bouton favori pour une boutique
async function initFavoriteShop(shopId, btn) {
  if (!currentUser) return;

  const icon = btn.querySelector(".favIcon");
  const text = btn.querySelector(".favText");
  const countSpan = btn.querySelector(".favCount");

  // 1Ô∏è‚É£ V√©rifier si currentUser suit la boutique
  const { data: myFav } = await supabase
    .from("favorite_shops")
    .select("id")
    .eq("shop_id", shopId)
    .eq("user_id", currentUser.id)
    .maybeSingle();

  if (myFav) {
    icon.textContent = "‚ù§Ô∏è";
    text.textContent = "Abonn√©s";
    btn.classList.add("active");
  } else {
    icon.textContent = "ü§ç";
    text.textContent = "Suivre";
    btn.classList.remove("active");
  }

  // 2Ô∏è‚É£ Charger le compteur global
  await updateShopFavoriteCount(shopId, btn);
}

// üîπ Mettre √† jour le compteur global d‚Äôune boutique
async function updateShopFavoriteCount(shopId, btn) {
  const countSpan = btn.querySelector(".favCount");
  if (!countSpan) return;

  const { data: favs, error } = await supabase
    .from("favorite_shops")
    .select("id", { count: "exact" })
    .eq("shop_id", shopId);

  if (error) {
    console.error("Erreur compteur favoris:", error);
    countSpan.textContent = "0";
    return;
  }

  const total = favs?.length || 0;
  countSpan.textContent = formatCount(total);
}

// üîπ Ajouter ou retirer des favoris (toggle)

  

  async function toggleFavoriteShop(shopId, btn) {
  if (!currentUser) {
    alert("Connecte-toi pour suivre une boutique");
    return;
  }

  const icon = btn.querySelector(".favIcon");
  const text = btn.querySelector(".favText");

  // üîé r√©cup√©rer la boutique
  const { data: shop, error: shopError } = await supabase
    .from("shops")
    .select("owner_id, name")
    .eq("id", shopId)
    .single();

  if (shopError || !shop) {
    console.error("Erreur boutique :", shopError);
    return;
  }

  // üîç v√©rifier si d√©j√† suivi
  const { data: existing } = await supabase
    .from("favorite_shops")
    .select("id")
    .eq("shop_id", shopId)
    .eq("user_id", currentUser.id)
    .maybeSingle();

  if (existing) {
    // ‚ùå UNFOLLOW
    await supabase
      .from("favorite_shops")
      .delete()
      .eq("id", existing.id);

    icon.textContent = "ü§ç";
    text.textContent = "Suivre";
    btn.classList.remove("active");

  } else {
    // ‚úÖ FOLLOW
    await supabase
      .from("favorite_shops")
      .insert({
        shop_id: shopId,
        user_id: currentUser.id
      });

    icon.textContent = "‚ù§Ô∏è";
    text.textContent = "Abonn√©s";
    btn.classList.add("active");

    // üîî Notification simple (si ce n‚Äôest pas sa propre boutique)
    if (shop.owner_id && shop.owner_id !== currentUser.id) {
      // r√©cup√©rer le username de l‚Äôutilisateur qui suit
      const { data: userData } = await supabase
        .from("profiles")
        .select("username")
        .eq("id", currentUser.id)
        .maybeSingle();

      const followerName = userData?.username || "Quelqu‚Äôun";

      await supabase.from("notif_market").insert({
        user_id: shop.owner_id,        // destinataire
        actor_id: currentUser.id,      // celui qui agit
        type: "favorite_shop",
        title: "‚≠ê Nouvelle boutique suivie",
        message: `${followerName} a commenc√© √† suivre votre boutique "${shop.name}"`,
        link: `/shop.html?id=${shopId}`, // version simple comme avant
        is_read: false
      });
    }
  }

  // üîÑ mettre √† jour le compteur global (affich√© sur le bouton)
  await updateShopFavoriteCount(shopId, btn);
}
// ===================== INITIALISATION BOUTONS FAVORIS SUR LA PAGE =====================
function setupFavoriteShopButtons() {
  document.querySelectorAll(".favoriteShopBtn").forEach(btn => {
    const shopId = btn.dataset.shopId;
    if (!shopId) return;

    // Initialiser √©tat + compteur
    initFavoriteShop(shopId, btn);

    // Clic toggle
    btn.onclick = () => toggleFavoriteShop(shopId, btn);
  });
}

// ===================== NOTIFICATION TEMPS R√âEL (OPTIONNEL) =====================
function initFavoriteShopRealtime() {
  supabase
    .channel("public:favorite_shops")
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "favorite_shops" },
      payload => {
        // Met √† jour le compteur pour tous les boutons correspondants
        const shopId = payload.new.shop_id;
        document.querySelectorAll(`.favoriteShopBtn[data-shop-id='${shopId}']`).forEach(btn => {
          updateShopFavoriteCount(shopId, btn);
        });
      }
    )
    .on(
      "postgres_changes",
      { event: "DELETE", schema: "public", table: "favorite_shops" },
      payload => {
        const shopId = payload.old.shop_id;
        document.querySelectorAll(`.favoriteShopBtn[data-shop-id='${shopId}']`).forEach(btn => {
          updateShopFavoriteCount(shopId, btn);
        });
      }
    )
    .subscribe();
}
      // ===================== OUVRIR UNE BOUTIQUE =====================
async function openShop(shop) {
  try {
    if (!shop) return;
    currentShop = shop;

    // ================= AFFICHAGE MODAL =================
    modal.style.display = "flex";
    shopViewName.textContent = shop.name || "Nom boutique";
    shopViewDesc.textContent = shop.description || "-";
    shopViewCategory.textContent = shop.category || "-";
    shopViewLocation.textContent = shop.location || "-";

    // ================= LIVRAISON BADGE =================
    const livraisonDiv = document.getElementById("shopViewLivraison");
    if (shop.livraison === true) {
      livraisonDiv.innerHTML = `
        <span class="livraison-badge livraison-oui">
          üöö Livraison disponible
        </span>
      `;
    } else {
      livraisonDiv.innerHTML = `
        <span class="livraison-badge livraison-non">
          üì¶ Livraison non disponible
        </span>
      `;
    }

    // ================= WHATSAPP NUMERO (BANDE VERTE) =================
    const whatsappDiv = document.getElementById("shopViewWhatsapp");
    if (shop.whatsapp) {
      const phone = shop.whatsapp.replace(/\s+/g, '');
      whatsappDiv.innerHTML = `
        <div class="whatsapp-band">
          üìû ${phone}
        </div>
      `;
    } else {
      whatsappDiv.innerHTML = "";
    }
function formatAvailability(value) {
  const map = {
    now: "‚úÖ Disponible maintenant",
    "1_week": "‚è≥ Disponible dans 1 semaine",
    "2_weeks": "‚è≥ Disponible dans 2 semaines",
    "1_month": "üìÖ Disponible dans 1 mois",
    "2_months": "üìÖ Disponible dans 2 mois",
    "3_months": "üìÖ Disponible dans 3 mois",
    "6_months": "üìÖ Disponible dans 6 mois",
    "1_year": "üìÜ Disponible dans 1 an"
  };
  return map[value] || "‚è≥ Indisponible";
}


   // ==============================
// VARIABLES GLOBALES
// ==============================
let currentProduct = null;
let currentOrderId = null;
let isProcessing = false;

// ==============================
// MODALES
// ==============================
function openOrderModal() {
  document.getElementById("orderModal").style.display = "flex";
}

function closeOrderModal() {
  document.getElementById("orderModal").style.display = "none";
}

function openPaymentModal(orderId, amount) {
  if (!orderId) return;
  currentOrderId = orderId;
  document.getElementById("paymentAmount").textContent = amount;
  document.getElementById("paymentModal").style.display = "flex";
}

function closePaymentModal() {
  document.getElementById("paymentModal").style.display = "none";
}

// Fermer modale si clic en dehors
window.addEventListener("click", (event) => {
  if (event.target.id === "orderModal") closeOrderModal();
  if (event.target.id === "paymentModal") closePaymentModal();
});

// ==============================
// BOUTON COMMANDER
// ==============================
document.getElementById("shopProductsScroll").addEventListener("click", (e) => {
  const btn = e.target.closest(".orderBtn");
  if (!btn) return;

  const sellerId = btn.dataset.sellerId?.trim();
  const productId = btn.dataset.productId?.trim();
  const amount = parseFloat(btn.dataset.amount);

  if (!sellerId || !productId || isNaN(amount) || amount <= 0) {
    return alert("Impossible de commander : informations produit invalides.");
  }

  currentProduct = { sellerId, productId, amount };
  openOrderModal();
});

// ==============================
// CREER COMMANDE
// ==============================
document.getElementById("createOrderBtn").addEventListener("click", async () => {
  if (isProcessing) return;
  if (!currentProduct) return alert("Produit invalide");

  const address = document.getElementById("orderAddress").value.trim();
  const phone = document.getElementById("orderPhone").value.trim();
  const note = document.getElementById("orderNote").value.trim();

  if (!address || !phone) {
    return alert("Adresse et t√©l√©phone requis");
  }

  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) return alert("Utilisateur non connect√©");

  isProcessing = true;

  try {
    // 1Ô∏è‚É£ Cr√©e la commande via RPC
    const { data, error } = await supabase.rpc("create_order", {
      p_buyer: user.id,
      p_seller: currentProduct.sellerId,
      p_product: currentProduct.productId,
      p_amount: currentProduct.amount,
      p_address: address,
      p_phone: phone,
      p_note: note
    });

    if (error) throw error;
    if (!data) throw new Error("Commande non cr√©√©e");

    const orderId = data;
    currentOrderId = orderId;

    console.log("Commande cr√©√©e ID :", orderId);

    // 2Ô∏è‚É£ Cr√©e la transaction initiale dans wallet_transactions
    const { error: txError } = await supabase
      .from("wallet_transactions")
      .insert([{
        user_id: user.id,
        order_id: orderId,
        amount: currentProduct.amount,
        transaction_type: "escrow", // ‚úÖ type valide
        status: "pending"           // ‚úÖ status valide
      }]);

    if (txError) throw txError;

    closeOrderModal();
    alert("Commande cr√©√©e ! Cliquez sur Payer maintenant.");
    openPaymentModal(orderId, currentProduct.amount);

  } catch (err) {
    console.error(err);
    alert(err.message || "Erreur cr√©ation commande");
  }

  isProcessing = false;
});

// ==============================
// PAYER COMMANDE (VERSION PRO)
// ==============================
document.getElementById("payOrderBtn").addEventListener("click", async () => {

  if (isProcessing) return;
  if (!currentOrderId) return alert("Commande invalide");

  isProcessing = true;

  try {

    const { error } = await supabase.rpc("pay_order", {
      p_order_id: currentOrderId
    });

    if (error) throw error;

    closePaymentModal();
    alert("Paiement effectu√© avec succ√®s !");

    if (typeof loadWallet === "function") {
      await loadWallet();
    }

  } catch (err) {
    console.error(err);
    alert(err.message || "Erreur lors du paiement");
  }

  isProcessing = false;
});
// ================= CHARGER PRODUITS =================
let query = supabase
  .from('shop_products')
  .select('*')
  .eq('shop_id', shop.id)
  .order('created_at', { ascending: false });

// üîπ Si ouverture depuis favoris
if (shop.fromFavorites && currentUser) {
  const { data: favData, error: favError } = await supabase
    .from('favorite_products')
    .select('product_id')
    .eq('user_id', currentUser.id);

  if (!favError && favData && favData.length > 0) {
    const favIds = favData.map(f => f.product_id);
    query = query.in('id', favIds);
  } else {
    shopProductsScroll.innerHTML = "<p>Aucun produit suivi dans cette boutique.</p>";
    return;
  }
}

const { data: products, error: prodError } = await query;

shopProductsScroll.innerHTML = "";

if (prodError) {
  shopProductsScroll.innerHTML = "<p style='color:red;'>Erreur chargement produits</p>";
} else if (!products || products.length === 0) {
  shopProductsScroll.innerHTML = "<p>Aucun produit disponible</p>";
} else {
  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "productCard";

    div.innerHTML = `
      <img src="${p.image_url || 'https://via.placeholder.com/150'}" alt="${p.name || 'Produit'}">
      <h5>${p.name || 'Produit'}</h5>
      ${p.description ? `<p class="productDesc">${p.description}</p>` : ""}
      <p class="productAvailability">${formatAvailability(p.availability)}</p>
      <p class="productPrice"><strong>${p.price || '-'} FCFA</strong></p>
      <button class="favoriteProductBtn" data-id="${p.id}">ü§ç</button>

      <!-- Commander -->
      <button class="orderBtn"
              data-seller-id="${p.owner_id || ''}"
              data-product-id="${p.id || ''}"
              data-amount="${p.price || 0}">
        Commander
      </button>
    `;

    shopProductsScroll.appendChild(div);
  });

 

// üîπ Initialiser favoris produits
      document.querySelectorAll(".favoriteProductBtn").forEach(btn => {
        const productId = btn.dataset.id;

        initFavoriteProduct(productId, btn);

        btn.onclick = async (e) => {
          e.stopPropagation();
          await toggleFavoriteProduct(productId, btn);
        };
      });
    }

    // ================= LIKES & COMMENTAIRES =================
    await loadShopLikes();
    await loadShopComments();

  } catch (err) {
    console.error("Erreur openShop :", err);
    shopProductsScroll.innerHTML =
      "<p style='color:red;'>Erreur chargement boutique</p>";
  }
}


// ===================== FONCTIONS FAVORIS PRODUITS =====================
async function toggleFavoriteProduct(productId, btn, productOwnerId) {
  if (!currentUser) {
    alert("Connecte-toi pour suivre un produit");
    return;
  }

  const { data: existing } = await supabase
    .from("favorite_products")
    .select("id")
    .eq("product_id", productId)
    .eq("user_id", currentUser.id)
    .maybeSingle();

  if (existing) {
    // ‚ùå RETIRER FAVORI
    await supabase
      .from("favorite_products")
      .delete()
      .eq("id", existing.id);

    btn.textContent = "ü§ç";
    btn.classList.remove("active");

  } else {
    // ‚úÖ AJOUTER FAVORI
    await supabase
      .from("favorite_products")
      .insert({
        product_id: productId,
        user_id: currentUser.id
      });

    btn.textContent = "‚ù§Ô∏è";
    btn.classList.add("active");

    // üîî NOTIFICATION FAVORI PRODUIT (AVEC NOM)
    if (productOwnerId && productOwnerId !== currentUser.id) {

      const actorName = currentUser.username || "Un utilisateur";

      await supabase.from("notif_market").insert({
        user_id: productOwnerId,       // destinataire
        actor_id: currentUser.id,      // celui qui agit
        type: "favorite_product",
        title: "‚ù§Ô∏è Produit suivi",
        message: `${actorName} a ajout√© votre produit en favori`,
        link: `/product?id=${productId}`,
        is_read: false
      });
    }
  }
}
async function initFavoriteProduct(productId, btn) {
  if (!currentUser) return;

  const { data } = await supabase
    .from("favorite_products")
    .select("id")
    .eq("product_id", productId)
    .eq("user_id", currentUser.id)
    .maybeSingle();

  if (data) {
    btn.textContent = "‚ù§Ô∏è";
    btn.classList.add("active");
  } else {
    btn.textContent = "ü§ç";
    btn.classList.remove("active");
  }
}


// üîπ R√âF√âRENCES
const favoritesBtn = document.getElementById("favoritesBtn");
const favoritesModal = document.getElementById("favoritesModal");
const closeFavorites = document.getElementById("closeFavorites");
const btnFavorisBoutiques = document.getElementById("btnFavorisBoutiques");
const btnFavorisProduits = document.getElementById("btnFavorisProduits");
const favoritesShopsList = document.getElementById("favoritesShopsList");
const favoritesProductsList = document.getElementById("favoritesProductsList");

// ===================== BOUTON FAVORIS =====================
favoritesBtn.onclick = async () => {
  favoritesModal.style.display = "flex";
  await loadFavoriteNotifications();  // Charge toutes notifications
  updateFavoritesBadge();
};

closeFavorites.onclick = () => {
  favoritesModal.style.display = "none";
};

// ===================== ONGLET BOUTIQUES =====================
btnFavorisBoutiques.onclick = () => loadFavoriteShops();

// ===================== ONGLET PRODUITS =====================
btnFavorisProduits.onclick = () => loadFavoriteProducts();

// ===================== CHARGER BOUTIQUES FAVORIS =====================
async function loadFavoriteShops() {
  favoritesShopsList.style.display = "block";
  favoritesProductsList.style.display = "none";
  favoritesShopsList.innerHTML = "<p>Chargement...</p>";

  if (!currentUser || !currentUser.id) {
    favoritesShopsList.innerHTML = "<p>Utilisateur non connect√©.</p>";
    return;
  }

  const { data: favs, error: favError } = await supabase
    .from("favorite_shops")
    .select("shop_id")
    .eq("user_id", currentUser.id);

  if (favError) {
    favoritesShopsList.innerHTML = "<p>Erreur chargement favoris.</p>";
    console.error(favError);
    return;
  }

  if (!favs || favs.length === 0) {
    favoritesShopsList.innerHTML = "<p>Aucune boutique suivie.</p>";
    return;
  }

  const shopIds = favs.map(f => f.shop_id);

  const { data: shops, error: shopError } = await supabase
    .from("shops")
    .select("*")
    .in("id", shopIds);

  if (shopError) {
    favoritesShopsList.innerHTML = "<p>Erreur chargement boutiques.</p>";
    console.error(shopError);
    return;
  }

  favoritesShopsList.innerHTML = "";

  shops.forEach(shop => {
    const div = document.createElement("div");
    div.style.cssText = `
      display:flex;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #eee;
      cursor:pointer;
    `;

    div.innerHTML = `
      <img src="${shop.image_url || 'https://via.placeholder.com/80'}"
           style="width:80px;height:60px;border-radius:8px;object-fit:cover;">
      <div>
        <strong>${shop.name}</strong>
        <p style="font-size:14px;color:#666;">${shop.description || ""}</p>
      </div>
    `;

    div.onclick = async () => {
      favoritesModal.style.display = "none";
      await openShop(shop); // Utilise ta fonction existante
    };

    favoritesShopsList.appendChild(div);
  });
}

// ===================== CHARGER PRODUITS FAVORIS =====================
async function loadFavoriteProducts() {
  favoritesProductsList.style.display = "block";
  favoritesShopsList.style.display = "none";
  favoritesProductsList.innerHTML = "<p>Chargement...</p>";

  if (!currentUser || !currentUser.id) {
    favoritesProductsList.innerHTML = "<p>Utilisateur non connect√©.</p>";
    return;
  }

  // üîπ 1Ô∏è‚É£ R√©cup√©rer les produits favoris
  const { data: favData, error: favError } = await supabase
    .from("favorite_products")
    .select("product_id")
    .eq("user_id", currentUser.id);

  if (favError) {
    favoritesProductsList.innerHTML = "<p>Erreur chargement produits.</p>";
    console.error(favError);
    return;
  }

  if (!favData || favData.length === 0) {
    favoritesProductsList.innerHTML = "<p>Aucun produit suivi.</p>";
    return;
  }

  const productIds = favData.map(f => f.product_id);

  // üîπ 2Ô∏è‚É£ R√©cup√©rer les infos des produits
  const { data: products, error: prodError } = await supabase
    .from("shop_products")
    .select("*")
    .in("id", productIds)
    .order("created_at", { ascending: false });

  if (prodError) {
    favoritesProductsList.innerHTML = "<p>Erreur chargement produits.</p>";
    console.error(prodError);
    return;
  }

  if (!products || products.length === 0) {
    favoritesProductsList.innerHTML = "<p>Aucun produit suivi.</p>";
    return;
  }

  favoritesProductsList.innerHTML = "";

  // üîπ 3Ô∏è‚É£ Afficher les produits et g√©rer clic
  for (const p of products) {
    const div = document.createElement("div");
    div.style.cssText = `
      display:flex;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #eee;
      cursor:pointer;
    `;

    div.innerHTML = `
      <img src="${p.image_url || 'https://via.placeholder.com/80'}"
           style="width:80px;height:60px;border-radius:8px;object-fit:cover;">
      <div>
        <strong>${p.name}</strong>
        <p style="color:#2e8b57;font-weight:600;">${p.price || "-"} FCFA</p>
      </div>
    `;

    div.onclick = async () => {
      favoritesModal.style.display = "none";

            // üîπ R√©cup√©rer la boutique compl√®te du produit
      const { data: shopData, error: shopError } = await supabase
        .from("shops")
        .select("*")
        .eq("id", p.shop_id)
        .single();

      if (shopError || !shopData) {
        alert("Impossible de charger la boutique de ce produit.");
        console.error(shopError);
        return;
      }

      // üîπ Ouvrir la boutique avec toutes les infos
      await openShop(shopData);
    };

    favoritesProductsList.appendChild(div);
  }
}

// ===== COPIER LE LIEN =====
copyLinkBtn.onclick = () => {
  navigator.clipboard.writeText(window.location.href)
    .then(() => alert("Lien copi√© !"))
    .catch(err => alert("Erreur copie lien : " + err));
};


// ===== GESTION LIKE / UNLIKE =====
async function loadShopLikes() {
  if (!currentShop) return;

  try {
    const { data: likes, error } = await supabase
      .from('shop_likes')
      .select('user_id, user:profiles(username)')
      .eq('shop_id', currentShop.id);

    if (error) { console.error("Erreur loadShopLikes:", error); return; }

    const count = likes?.length || 0;
    likeCountEl.textContent = count;

    const userLiked = likes?.some(l => l.user_id === currentUser?.id);
    likeShopBtn.style.opacity = userLiked ? 0.6 : 1;

    if (likes && likes.length > 0) {
      shopLikesList.innerHTML = likes
        .map(l => `<div style="padding:2px 4px;">${l.user?.username || 'Anonyme'}</div>`)
        .join('');
    } else {
      shopLikesList.innerHTML = "<div style='padding:2px 4px;'>Aucun like</div>";
    }

  } catch (err) {
    console.error("Erreur loadShopLikes:", err);
  }
}

// =====================
// Like / Unlike au clic sur le bouton üëç
// =====================
likeShopBtn.onclick = async (e) => {
  e.stopPropagation();

  if (!currentUser || !currentShop) return;

  try {
    const { data: existing } = await supabase
      .from('shop_likes')
      .select('*')
      .eq('shop_id', currentShop.id)
      .eq('user_id', currentUser.id);

    if (existing && existing.length > 0) {
      // ‚ùå UNLIKE
      const { error } = await supabase
        .from('shop_likes')
        .delete()
        .eq('shop_id', currentShop.id)
        .eq('user_id', currentUser.id);

      if (error) { console.error(error); return; }

      // üîÑ Mettre √† jour notif existante si n√©cessaire
      if (currentShop.owner_id && currentShop.owner_id !== currentUser.id) {
        const { data: existingNotif } = await supabase
          .from("notif_market")
          .select("id, actors_count")
          .eq("user_id", currentShop.owner_id)
          .eq("type", "shop_like")
          .eq("link", `/shop?id=${currentShop.id}`)
          .eq("is_read", false)
          .maybeSingle();

        if (existingNotif) {
          const newCount = (existingNotif.actors_count || 1) - 1;
          if (newCount > 0) {
            const newMessage =
              newCount === 1
                ? `1 personne aime votre boutique "${currentShop.name}"`
                : `${newCount} personnes aiment votre boutique "${currentShop.name}"`;

            await supabase
              .from("notif_market")
              .update({ actors_count: newCount, message: newMessage })
              .eq("id", existingNotif.id);
          } else {
            // Supprimer la notif si plus personne ne like
            await supabase
              .from("notif_market")
              .delete()
              .eq("id", existingNotif.id);
          }
        }
      }

    } else {
      // ‚úÖ LIKE
      const { error } = await supabase
        .from('shop_likes')
        .insert({ shop_id: currentShop.id, user_id: currentUser.id });

      if (error) { console.error(error); return; }

      // üîî Notification regroup√©e
      if (currentShop.owner_id && currentShop.owner_id !== currentUser.id) {
        // R√©cup√©rer le nom de l‚Äôutilisateur
        const { data: userProfile } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', currentUser.id)
          .maybeSingle();

        const likerName = userProfile?.username || "Quelqu‚Äôun";

        // Chercher une notif similaire non lue
        const { data: existingNotif } = await supabase
          .from("notif_market")
          .select("id, actors_count")
          .eq("user_id", currentShop.owner_id)
          .eq("type", "shop_like")
          .eq("link", `/shop?id=${currentShop.id}`)
          .eq("is_read", false)
          .maybeSingle();

        if (existingNotif) {
          const newCount = (existingNotif.actors_count || 1) + 1;
          const newMessage =
            newCount === 2
              ? `${likerName} et 1 autre personne aiment votre boutique "${currentShop.name}"`
              : `${likerName} et ${newCount - 1} autres personnes aiment votre boutique "${currentShop.name}"`;

          await supabase
            .from("notif_market")
            .update({ actors_count: newCount, message: newMessage })
            .eq("id", existingNotif.id);

        } else {
          // Nouvelle notif
          await supabase.from("notif_market").insert({
            user_id: currentShop.owner_id,
            actor_id: currentUser.id,
            type: "shop_like",
            title: "‚ù§Ô∏è Nouveau like",
            message: `${likerName} aime votre boutique "${currentShop.name}"`,
            link: `/shop?id=${currentShop.id}`,
            actors_count: 1,
            is_read: false
          });
        }
      }
    }

    await loadShopLikes();

  } catch (err) {
    console.error("Erreur likeShopBtn:", err);
  }
};
// =====================
// Afficher la liste des utilisateurs qui ont lik√©
// =====================
likeCountContainer.onclick = (e) => {
  e.stopPropagation();
  shopLikesList.style.display =
    shopLikesList.style.display === 'block' ? 'none' : 'block';

  const rect = likeShopBtn.getBoundingClientRect();
  shopLikesList.style.top = `${rect.bottom + window.scrollY + 6}px`;
  shopLikesList.style.left = `${rect.left + window.scrollX}px`;
};

// =====================
// Initialisation
// =====================
loadShopLikes();
  // =====================
// Charger les commentaires et replies
// =====================
async function loadShopComments(scrollToId = null) {
  if (!currentShop) return;

  try {
    const { data, error } = await supabase
      .from('shop_comments')
      .select('id, content, user_id, parent_id, created_at, user:profiles(username)')
      .eq('shop_id', currentShop.id)
      .order('created_at', { ascending: true });

    commentsList.innerHTML = "";

    if (error) {
      console.error("Erreur chargement commentaires :", error);
      commentsList.innerHTML = "<p style='color:red;'>Erreur chargement commentaires</p>";
      return;
    }

    if (!data || data.length === 0) {
      commentsList.innerHTML = "<p>Aucun commentaire</p>";
      return;
    }

    function renderComment(c, parentEl, level = 0) {
      const div = document.createElement('div');
      div.id = `comment-${c.id}`;
      div.style.marginLeft = `${level * 20}px`;
      div.style.padding = "4px 6px";
      div.style.borderBottom = "1px solid #eee";

      const date = new Date(c.created_at).toLocaleString();

      div.innerHTML = `
  <div style="
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:6px;
    ">
    <strong style="font-size:14px; color:#222;">${c.user?.username || "Anonyme"}</strong>
    <span style="font-size:11px; color:#888;">${date}</span>
  </div>
  <p style="margin:6px 0; font-size:13px; line-height:1.4; color:#333;">${c.content}</p>
  <div style="
      display:flex; 
      gap:8px; 
      margin-top:4px; 
      margin-bottom:6px;
    ">
    <button class="replyBtn" style="
        padding:4px 8px; 
        font-size:12px; 
        cursor:pointer; 
        border:none; 
        border-radius:6px; 
        background:#f0f0f0; 
        transition:0.2s;"
        onmouseover="this.style.background='#dce4ff'" onmouseout="this.style.background='#f0f0f0'">
      R√©pondre
    </button>
  <button class="likeCommentBtn" style="
      padding:4px 8px;
      font-size:12px;
      cursor:pointer;
      border:none;
      border-radius:6px;
      background:#e0f7fa;
      color:#007bff;
      font-weight: normal;
      display:flex;
      align-items:center;
      gap:4px;
      transition:0.2s;"
      onmouseover="this.style.background='#b2ebf2'" 
      onmouseout="this.style.background='#e0f7fa'">
    üëç  <span class="likeCount">0</span>
  </button>

    ${c.user_id === currentUser?.id 
      ? `<button class="deleteCommentBtn" style="
            padding:4px 8px; 
            font-size:12px; 
            cursor:pointer; 
            border:none; 
            border-radius:6px; 
            background:#e53935;
            color:white;
            transition:0.2s;"
            onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#e53935'">
          Supprimer
        </button>` 
      : '' }
    ${c.user_id === currentUser?.id 
      ? `<button class="editCommentBtn" style="
            padding:4px 8px; 
            font-size:12px; 
            cursor:pointer; 
            border:none; 
            border-radius:6px; 
            background:#f0f0f0;
            transition:0.2s;"
            onmouseover="this.style.background='#dce4ff'" onmouseout="this.style.background='#f0f0f0'">
          ‚úèÔ∏è Modifier
        </button>` 
      : '' }
  </div>
  <div class="repliesContainer" style="
      margin-left:20px;
      border-left:2px solid #eee;
      padding-left:10px;
  "></div>
`;

      parentEl.appendChild(div);

     // ===== MODIFIER COMMENTAIRE =====
const editBtn = div.querySelector('.editCommentBtn');
if (editBtn) {
  editBtn.onclick = () => {
    const p = div.querySelector('p');
    const originalText = p.textContent;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.style.width = '100%';
    input.style.padding = '4px';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Sauvegarder';
    saveBtn.style.marginTop = '4px';

    p.replaceWith(input);
    div.appendChild(saveBtn);
    editBtn.disabled = true;

    saveBtn.onclick = async () => {
      const newText = input.value.trim();
      if (!newText) return;

      const { error } = await supabase
        .from('shop_comments')
        .update({ content: newText })
        .eq('id', c.id)
        .eq('user_id', currentUser.id);

      if (error) {
        alert("Erreur modification");
        console.error(error);
        return;
      }

      loadShopComments();
    };
  };
}
      

      // ===== R√©pondre =====
      const replyBtn = div.querySelector('.replyBtn');
      replyBtn.onclick = () => {
        const input = document.createElement('input');
        input.placeholder = "√âcrire une r√©ponse...";
        const sendBtn = document.createElement('button');
        sendBtn.textContent = "Envoyer";

        div.appendChild(input);
        div.appendChild(sendBtn);
        replyBtn.disabled = true;

        sendBtn.onclick = async () => {
          const text = input.value.trim();
          if (!text) return;

          const { data: inserted, error } = await supabase
            .from('shop_comments')
            .insert({
              shop_id: currentShop.id,
              user_id: currentUser.id,
              content: text,
              parent_id: c.id
            })
            .select()
            .single();

          if (error) return console.error(error);

          // üîî NOTIFICATION UNIFI√âE (REPLY)
if (c.user_id !== currentUser.id) {
  // R√©cup√©rer le username de l‚Äôutilisateur qui r√©pond
  const { data: userProfile } = await supabase
    .from('profiles')
    .select('username')
    .eq('id', currentUser.id)
    .maybeSingle();

  const replierName = userProfile?.username || "Quelqu‚Äôun";

  await supabase.from("notif_market").insert({
    user_id: c.user_id,           // destinataire : celui qui a comment√©
    actor_id: currentUser.id,     // celui qui agit
    type: "reply",
    title: "Nouvelle r√©ponse üí¨",
    message: `${replierName} a r√©pondu √† votre commentaire`,
    link: `/shop.html?id=${currentShop.id}#comment-${inserted.id}`,
    is_read: false
  });
}

loadShopComments(inserted.id);
        };
      };
  // ===== Supprimer =====
      const delBtn = div.querySelector('.deleteCommentBtn');
      if (delBtn) {
        delBtn.onclick = async () => {
          if (!confirm("Supprimer ce commentaire ?")) return;
          const { error } = await supabase.from('shop_comments').delete().eq('id', c.id);
          if (error) { alert("Erreur suppression"); console.error(error); return; }
          loadShopComments();
        };
 }
      // ===== Likes =====
      const likeBtn = div.querySelector('.likeCommentBtn');
      loadCommentLikes(c.id, likeBtn);
      likeBtn.onclick = () => toggleCommentLike(c.id, likeBtn);

      // ===== Replies =====
      const replies = data.filter(x => x.parent_id === c.id);
      const container = div.querySelector('.repliesContainer');
      replies.forEach(r => renderComment(r, container, level + 1));
    }

    data.filter(c => !c.parent_id).forEach(c => renderComment(c, commentsList));

    if (scrollToId) {
      setTimeout(() => {
        const el = document.getElementById(`comment-${scrollToId}`);
        if (el) el.scrollIntoView({ behavior: "smooth" });
      }, 200);
    }

  } catch (e) {
    console.error(e);
  }
}

// =====================
// Envoyer commentaire principal
// =====================
sendCommentBtn.onclick = async () => {
  if (!currentShop || !currentUser) return;

  const content = commentInput.value.trim();
  if (!content) return;

  const { data: inserted, error } = await supabase
    .from("shop_comments")
    .insert({
      shop_id: currentShop.id,
      user_id: currentUser.id,
      content
    })
    .select()
    .single();

  if (error) return console.error(error);

  // üîî NOTIFICATION UNIFI√âE (COMMENTAIRE)
if (currentShop.owner_id !== currentUser.id) {
  // R√©cup√©rer le username de l‚Äôutilisateur qui commente
  const { data: userProfile } = await supabase
    .from('profiles')
    .select('username')
    .eq('id', currentUser.id)
    .maybeSingle();

  const commenterName = userProfile?.username || "Quelqu‚Äôun";

  await supabase.from("notif_market").insert({
    user_id: currentShop.owner_id,
    actor_id: currentUser.id,
    type: "comment",
    title: "Nouveau commentaire üí¨",
    message: `${commenterName} a comment√© votre boutique`,
    link: `/shop.html?id=${currentShop.id}#comment-${inserted.id}`,
    is_read: false
  });
}

commentInput.value = "";
loadShopComments(inserted.id);
};

// =====================
// Likes commentaire (inchang√©)
// =====================
async function loadCommentLikes(commentId, btn) {
  const { data } = await supabase
    .from("comment_likes")
    .select("*")
    .eq("comment_id", commentId);

  btn.querySelector(".likeCount").textContent = data?.length || 0;
}

async function toggleCommentLike(commentId, btn) {
  if (!currentUser) return;

  // V√©rifier si d√©j√† lik√©
  const { data } = await supabase
    .from("comment_likes")
    .select("*")
    .eq("comment_id", commentId)
    .eq("user_id", currentUser.id);

  if (data.length) {
    // ‚ùå UNLIKE
    await supabase.from("comment_likes").delete().eq("id", data[0].id);

  } else {
    // ‚úÖ LIKE
    await supabase.from("comment_likes").insert({
      comment_id: commentId,
      user_id: currentUser.id
    });

    // üîî NOTIFICATION (si ce n‚Äôest pas son propre commentaire)
    const { data: comment } = await supabase
      .from("shop_comments")
      .select("user_id, shop_id")
      .eq("id", commentId)
      .maybeSingle();

    if (comment && comment.user_id !== currentUser.id) {
      // R√©cup√©rer le username de celui qui like
      const { data: userProfile } = await supabase
        .from("profiles")
        .select("username")
        .eq("id", currentUser.id)
        .maybeSingle();

      const likerName = userProfile?.username || "Quelqu‚Äôun";

      await supabase.from("notif_market").insert({
        user_id: comment.user_id,         // destinataire : auteur du commentaire
        actor_id: currentUser.id,         // celui qui agit
        type: "comment_like",
        title: "‚ù§Ô∏è Nouveau like sur votre commentaire",
        message: `${likerName} a aim√© votre commentaire`,
        link: `/shop.html?id=${comment.shop_id}#comment-${commentId}`,
        is_read: false
      });
    }
  }

  // üîÑ Mettre √† jour le nombre de likes affich√©
  loadCommentLikes(commentId, btn);
}

    

              
async function loadShopStats(shopId) {
  if (!shopId) return;

  // total messages
  const { count: totalCount } = await supabase
    .from("messages_shop")
    .select("*", { count: "exact", head: true })
    .eq("shop_id", shopId);

  // messages non lus re√ßus par MOI
  const { count: unreadCount } = await supabase
    .from("messages_shop")
    .select("*", { count: "exact", head: true })
    .eq("shop_id", shopId)
    .eq("to_user", currentUser.id)
    .or(`read_by.is.null,read_by.not.cs.{${currentUser.id}}`);

  const statsDiv = document.getElementById("shopStats");

  statsDiv.innerHTML = `
    <strong>üìä Statistiques</strong><br>
    Total messages : ${totalCount || 0}<br>
    Messages non lus : ${unreadCount || 0}
  <div style="margin-top:6px; font-size:12px; color:#666;">
  Derni√®re mise √† jour : ${new Date().toLocaleTimeString()}
</div>
  `;

  statsDiv.style.display = "block";
}
  window.openShopStats = function () {
  const statsDiv = document.getElementById("shopStats");

  if (!currentShop) return;

  if (statsDiv.style.display === "block") {
    statsDiv.style.display = "none";
    return;
  }

  loadShopStats(currentShop.id);
};
// ====== CONTACTER BOUTIQUE ======
contactShopBtn.onclick = async () => {
  if (!currentShop) return alert("Aucune boutique s√©lectionn√©e");
  chatContainer.classList.add("open");
  chatTitle.textContent = `Boutique: ${currentShop.name}`;
  await loadMessagesShop();
  loadshops();
};
  
  const searchInput = document.getElementById("searchInput");

// Fonction pour filtrer boutiques
searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();

  // Parcourir toutes les cartes de boutique
  const shopCards = shopsList.querySelectorAll(".shopCard");
  shopCards.forEach(card => {
    const name = card.querySelector("h4")?.textContent.toLowerCase() || "";
    const category = card.querySelector("small")?.textContent.toLowerCase() || "";
    const desc = card.dataset.description?.toLowerCase() || "";

    if (name.includes(query) || category.includes(query) || desc.includes(query)) {
      card.style.display = "block";
    } else {
      card.style.display = "none";
    }
  });
});
// ====== ENVOI MESSAGE ======
sendBtn.onclick = async () => {
  const text = messageInput.value.trim();
  if (!text && !pendingFile) return;
  await sendMessageShop(text, pendingFile);
  messageInput.value = "";
  mediaPreview.innerHTML = "";
  pendingFile = null;
};

fileBtn.onclick = () => fileInput.click();
fileInput.onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  pendingFile = file;
  mediaPreview.innerHTML = "";
  if (file.type.startsWith("image/")) {
    const img = document.createElement("img"); img.src = URL.createObjectURL(file); mediaPreview.appendChild(img);
  } else if (file.type.startsWith("video/")) {
    const video = document.createElement("video"); video.controls = true; video.src = URL.createObjectURL(file); mediaPreview.appendChild(video);
  } else if (file.type.startsWith("audio/")) {
    const audio = document.createElement("audio"); audio.controls = true; audio.src = URL.createObjectURL(file); mediaPreview.appendChild(audio);
  }
};

// Bouton audio
audioBtn.onclick = async () => {
  // Si d√©j√† en enregistrement
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop(); // stoppe l'enregistrement
    audioBtn.textContent = "üé§"; // reset bouton
    return;
  }

  // Demande l'acc√®s au micro
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const fileName = `audio_${Date.now()}.webm`;

      // Envoi dans Supabase Storage
      const { data, error } = await supabase.storage
        .from("messages_shop_files")
        .upload(fileName, blob);

      if (error) return console.error("Erreur upload audio :", error);

      // R√©cup√©rer l'URL publique
      const url = supabase.storage
        .from("messages_shop_files")
        .getPublicUrl(fileName).data.publicUrl;

      // Cr√©er le message audio
      const { error: insertError } = await supabase
        .from("messages_shop")
        .insert({
          shop_id: currentShop.id,
          from_user: currentUser.id,
          to_user: currentShop.owner_id || null,
          audio_url: fileName, // on garde le nom pour r√©cup√©rer depuis storage
          created_at: new Date().toISOString()
        });

      if (insertError) return console.error("Erreur envoi audio :", insertError);

      // Recharger les messages
      await loadMessagesShop();
    };

    mediaRecorder.start();
    audioBtn.textContent = "‚èπÔ∏è"; // changement visuel du bouton
  } catch (err) {
    console.error("Erreur acc√®s micro :", err);
    alert("Impossible d'acc√©der au micro. V√©rifie les permissions.");
  }
};

// ====== ENVOI AU SERVEUR ======
async function sendMessageShop(text, file) {
  if (!currentShop) return alert("Aucune boutique s√©lectionn√©e");

  let insertData = {
    shop_id: currentShop.id,
    from_user: currentUser.id,
    to_user: currentShop.owner_id,
    message: text || null,
    is_read: false
  };

  if (file) {
    const fileExt = file.type.split('/')[1] || 'webm';
    const filePath = `messages_shop/${currentUser.id}_${Date.now()}.${fileExt}`;

    const { data: uploaded, error: uploadError } = await supabase
      .storage
      .from('messages_shop_files')
      .upload(filePath, file, {
        contentType: file.type,
        upsert: false
      });

    if (uploadError) {
      console.error("Upload √©chou√© :", uploadError.message);
      alert("Erreur lors de l‚Äôenvoi du fichier");
      return;
    }

    if (!file.name) insertData.audio_url = uploaded.path;
    else if (file.type.startsWith("image/")) insertData.image_url = uploaded.path;
    else if (file.type.startsWith("video/")) insertData.video_url = uploaded.path;

    insertData.message = file.name ? null : "[Audio]";
  }

  const { error } = await supabase.from('messages_shop').insert([insertData]);
  if (error) { console.error(error); return; }

  await loadMessagesShop();
}


  async function openShopChat(shop) {
  currentShop = shop;

  await markMessagesAsRead(); // ‚úÖ ici
  await loadMessagesShop();   // ensuite affichage
}
 async function markMessagesAsRead() {
  if (!currentShop || !currentUser) return;

  const { error } = await supabase
    .from("messages_shop")
    .update({ is_read: true })
    .eq("shop_id", currentShop.id)
    .eq("to_user", currentUser.id)
    .eq("is_read", false);

  if (error) {
    console.error("Erreur markMessagesAsRead:", error);
  }
}
  async function updateUnreadBadge() {
  if (!currentUser) return;

  const { data, error } = await supabase
    .from("messages_shop")
    .select("id")
    .eq("to_user", currentUser.id)
    .eq("is_read", false)
    .or(`deleted_by.is.null,deleted_by.not.cs.{${currentUser.id}}`);

  if (error) {
    console.error("Erreur updateUnreadBadge:", error);
    return;
  }

  const badge = document.getElementById("messageBadge");
  const count = data.length;

  if (count > 0) {
    badge.textContent = count;
    badge.style.display = "inline-block";
  } else {
    badge.style.display = "none";
  }
}
  async function getUnreadCountForShop(shopId) {
  const { data, error } = await supabase
    .from("messages_shop")
    .select("id")
    .eq("shop_id", shopId)
    .eq("to_user", currentUser.id)
    .eq("is_read", false)
    .or(`deleted_by.is.null,deleted_by.not.cs.{${currentUser.id}}`);

  if (error) {
    console.error("Erreur unread count:", error);
    return 0;
  }

  return data.length;
}
  // Pour g√©rer le message actuellement s√©lectionn√© pour une r√©action
let currentMsgForReaction = null;

// ===== EMOJI PICKER (CORRIG√â) =====
let emojiPicker = document.getElementById("emojiPicker");

if (!emojiPicker) {
  emojiPicker = document.createElement("div");
  emojiPicker.id = "emojiPicker";

  // Styles
  emojiPicker.style.position = "absolute";
  emojiPicker.style.display = "none";
  emojiPicker.style.background = "#fff";
  emojiPicker.style.border = "1px solid #ccc";
  emojiPicker.style.borderRadius = "12px";
  emojiPicker.style.padding = "15px";
  emojiPicker.style.boxShadow = "0 2px 12px rgba(0,0,0,0.2)";
  emojiPicker.style.zIndex = "5";
  emojiPicker.style.gap = "6px";
  emojiPicker.style.flexWrap = "wrap";
  emojiPicker.style.flexDirection = "row";
  emojiPicker.style.fontSize = "20px";
  emojiPicker.style.cursor = "pointer";
  emojiPicker.style.userSelect = "none";
  emojiPicker.style.display = "flex";

  // Position DANS le chat
  emojiPicker.style.bottom = "10px";
  emojiPicker.style.left = "0px";
  emojiPicker.style.width = "320px";

  // Emojis
  ["üëç","‚ù§Ô∏è","üòÇ","üòÆ","üò¢","üëè","üéâ","üò°"].forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.style.padding = "6px";
    span.onclick = () => {
      const input = document.getElementById("messageInput");
      input.value += e;
      input.focus();
    };
    emojiPicker.appendChild(span);
  });

  // üî¥ IMPORTANT : on l‚Äôattache AU CHAT, PAS AU BODY
  const chatContainer = document.getElementById("chatContainer");
  chatContainer.appendChild(emojiPicker);
}

// Click sur emoji pour l'ajouter au message
emojiPicker.querySelectorAll("span").forEach(span => {
  span.onclick = async () => {
    if (!currentMsgForReaction) return;
    const emoji = span.textContent;

    let newReactions = currentMsgForReaction.reactions || {};
    // 1 emoji max par utilisateur
    if (!newReactions[emoji]) newReactions[emoji] = [currentUser.id];
    else if (!newReactions[emoji].includes(currentUser.id)) newReactions[emoji].push(currentUser.id);

    await supabase.from("messages_shop")
      .update({ reactions: newReactions })
      .eq("id", currentMsgForReaction.id);

    emojiPicker.style.display = "none";
    currentMsgForReaction = null;

    await loadMessagesShop();
  };
});

// Clic en dehors pour cacher le picker
document.addEventListener("click", (e) => {
  if (!emojiPicker.contains(e.target)) {
    emojiPicker.style.display = "none";
    currentMsgForReaction = null;
  }
});
  
  async function loadMessagesShop() {
  if (!currentShop || !currentUser) return;

  // üî¥ 0Ô∏è‚É£ MARQUER LES MESSAGES COMME LUS
  await markMessagesAsRead();

  // üî¥ 1Ô∏è‚É£ METTRE √Ä JOUR LE BADGE IMM√âDIATEMENT
  await updateUnreadBadge();

  // 1Ô∏è‚É£ Charger les messages
  const { data: messages, error } = await supabase
    .from("messages_shop")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: true });

  if (error) {
    console.error("Erreur loadMessagesShop:", error);
    return;
  }

  // 2Ô∏è‚É£ Filtrer les messages supprim√©s pour l'utilisateur
  const visibleMessages = messages.filter(
    m => !m.deleted_by || !m.deleted_by.includes(currentUser.id)
  );

  // 3Ô∏è‚É£ Nettoyer l'affichage
  messagesList.innerHTML = "";

  // 4Ô∏è‚É£ Afficher les messages
  visibleMessages.forEach(msg => {
    const div = document.createElement("div");
    div.className = "message " + (msg.from_user === currentUser.id ? "to" : "from");
    div.style.position = "relative";
    div.style.marginBottom = "8px";

    // ---- contenu ----
    if (msg.message) {
      div.textContent = msg.message;
    } 
    else if (msg.image_url) {
      const url = supabase.storage.from('messages_shop_files').getPublicUrl(msg.image_url).data.publicUrl;
      div.innerHTML = `<img src="${url}" style="max-width:100%; border-radius:8px; cursor:pointer;">`;
      div.querySelector("img").onclick = () => {
          mediaContent.innerHTML = `<img src="${url}" style="max-width:100%; max-height:100%;">`;
          mediaModal.style.display = "flex";
      };
    } 
    else if (msg.video_url) {
  const url = supabase.storage.from('messages_shop_files').getPublicUrl(msg.video_url).data.publicUrl;
  
  const videoEl = document.createElement("video");
      videoEl.src = url;
      videoEl.controls = true;
      videoEl.style.maxWidth = "100%";
      videoEl.style.borderRadius = "8px";
      videoEl.style.cursor = "pointer";

      videoEl.onclick = () => {
        mediaContent.innerHTML = `<video src="${url}" controls autoplay style="max-width:90vw; max-height:90vh;"></video>`;
        mediaModal.style.display = "flex";
      };

      div.appendChild(videoEl);
    }
    else if (msg.audio_url) {
      const url = supabase.storage.from('messages_shop_files').getPublicUrl(msg.audio_url).data.publicUrl;
      div.innerHTML = `<audio controls src="${url}"></audio>`;
    } 
    else if (msg.file_url) {
      const url = supabase.storage.from('messages_shop_files').getPublicUrl(msg.file_url).data.publicUrl;
      const fileName = msg.file_name || "Fichier";
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px; background:#f4f4f4; padding:6px 10px; border-radius:6px;">
          <span>üìÑ</span>
          <a href="${url}" target="_blank" style="text-decoration:none; color:#333;">${fileName}</a>
        </div>
      `;
    }
// ======= CONTENEUR HEURE =======
const timeContainer = document.createElement("div");
timeContainer.style.display = "flex";
timeContainer.style.justifyContent = "flex-end"; // aligner √† droite
timeContainer.style.marginTop = "4px";
timeContainer.style.fontSize = "12px";
timeContainer.style.color = "#555";

// Heure
const date = new Date(msg.created_at);
const hours = date.getHours().toString().padStart(2, "0");
const minutes = date.getMinutes().toString().padStart(2, "0");
timeContainer.textContent = `${hours}:${minutes}`;

// Ajouter au message
div.appendChild(timeContainer);
    // ===== STATUT VU / NON VU (UNIQUEMENT POUR MES MESSAGES) =====
if (msg.from_user === currentUser.id) {
  const seen = document.createElement("div");
  seen.textContent = msg.is_read ? "‚úì‚úì Vu" : "‚úì";

  seen.style.fontSize = "11px";
  seen.style.color = "#fff"; // BLANC
  seen.style.opacity = "0.8";
  seen.style.marginTop = "4px";
  seen.style.textAlign = "right";

  // optionnel : meilleure lisibilit√©
  seen.style.textShadow = "0 1px 2px rgba(0,0,0,0.6)";

  div.appendChild(seen);
}
    // ---- bouton supprimer ----
    const actions = document.createElement("div");
    actions.className = "message-actions";
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-btn";
    deleteBtn.textContent = "üóëÔ∏è";
    deleteBtn.onclick = async (e) => { e.stopPropagation(); await deleteMessage(msg.id); };
    actions.appendChild(deleteBtn);
    div.appendChild(actions);

    // ---- r√©actions existantes ----
    if (msg.reactions && Object.keys(msg.reactions).length > 0) {
      const reactionsDiv = document.createElement("div");
      reactionsDiv.style.display = "flex";
      reactionsDiv.style.gap = "6px";
      reactionsDiv.style.marginTop = "6px";
      reactionsDiv.style.fontSize = "14px";
      Object.entries(msg.reactions).forEach(([emoji, users]) => {
        if (!Array.isArray(users) || users.length === 0) return;
        const span = document.createElement("span");
        span.textContent = `${emoji} ${users.length}`;
        span.style.background = "#f1f1f1";
        span.style.padding = "2px 6px";
        span.style.borderRadius = "12px";
        span.style.fontSize = "13px";
        reactionsDiv.appendChild(span);
      });
      div.appendChild(reactionsDiv);
    }

    // ---- appui long pour emoji picker ----
    if (msg.from_user !== currentUser.id) {
      let timer = null;
      div.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        timer = setTimeout(() => {
          currentMsgForReaction = msg;
          const rect = div.getBoundingClientRect();
          let top = rect.bottom + window.scrollY + 8;
          if (top + emojiPicker.offsetHeight > window.scrollY + window.innerHeight) {
            top = rect.top + window.scrollY - emojiPicker.offsetHeight - 8;
          }
          emojiPicker.style.top = `${top}px`;
          emojiPicker.style.left = `${rect.left + window.scrollX}px`;
          emojiPicker.style.display = "flex";
        }, 600);
      });
      div.addEventListener("pointerup", () => clearTimeout(timer));
      div.addEventListener("pointerleave", () => clearTimeout(timer));
      div.addEventListener("pointercancel", () => clearTimeout(timer));
    }

    messagesList.appendChild(div);
  });

  // 5Ô∏è‚É£ scroll en bas
  setTimeout(() => { messagesList.scrollTop = messagesList.scrollHeight; }, 100);
}
  async function getShopStats(shopId) {
  const { data: messages, error } = await supabase
    .from("messages_shop")
    .select("*")
    .eq("shop_id", shopId);

  if (error) {
    console.error("Erreur stats boutique :", error);
    return null;
  }

  const visibleMessages = messages.filter(
    m => !m.deleted_by || !m.deleted_by.includes(currentUser.id)
  );

  const stats = {
    total: visibleMessages.length,
    sent: visibleMessages.filter(m => m.from_user === currentUser.id).length,
    received: visibleMessages.filter(m => m.to_user === currentUser.id).length,
    images: visibleMessages.filter(m => m.image_url).length,
    videos: visibleMessages.filter(m => m.video_url).length,
    audios: visibleMessages.filter(m => m.audio_url).length,
    files: visibleMessages.filter(m => m.file_url).length,
    lastMessageAt: null
  };

  if (visibleMessages.length > 0) {
    stats.lastMessageAt =
      visibleMessages[visibleMessages.length - 1].created_at;
  }

  return stats;
}
  function closeShopStats() {
  document.getElementById("shopStatsModal").style.display = "none";
}

async function openShopStats() {
  if (!currentShop) return;

  const stats = await getShopStats(currentShop.id);
  if (!stats) return;

  const div = document.getElementById("shopStatsContent");

  div.innerHTML = `
    <p>üì© Total messages : <strong>${stats.total}</strong></p>
    <p>üì§ Envoy√©s : <strong>${stats.sent}</strong></p>
    <p>üì• Re√ßus : <strong>${stats.received}</strong></p>
    <p>üñºÔ∏è Images : <strong>${stats.images}</strong></p>
    <p>üé• Vid√©os : <strong>${stats.videos}</strong></p>
    <p>üé§ Audios : <strong>${stats.audios}</strong></p>
    <p>üìé Fichiers : <strong>${stats.files}</strong></p>
    <p>‚è±Ô∏è Dernier message : <strong>
      ${stats.lastMessageAt
        ? new Date(stats.lastMessageAt).toLocaleString()
        : "‚Äî"}
    </strong></p>
  `;

  document.getElementById("shopStatsModal").style.display = "flex";
}
  const mediaModal = document.getElementById("mediaModal");
const mediaContent = document.getElementById("mediaContent");
const closeMediaModal = document.getElementById("closeMediaModal");

closeMediaModal.onclick = () => {
    mediaModal.style.display = "none";
    mediaContent.innerHTML = "";
};

// Fermer au clic en dehors
mediaModal.addEventListener("click", (e) => {
    if (e.target === mediaModal) {
        mediaModal.style.display = "none";
        mediaContent.innerHTML = "";
    }
});
async function deleteMessage(messageId) {
  const ok = confirm("Supprimer ce message ?");
  if (!ok) return;

  // R√©cup√©rer le message
  const { data: msg, error } = await supabase
    .from("messages_shop")
    .select("deleted_by, shop_id")
    .eq("id", messageId)
    .single();

  if (error) { console.error(error); return; }

  // Ajouter l'utilisateur dans deleted_by
  const newDeletedBy = msg.deleted_by ? [...msg.deleted_by, currentUser.id] : [currentUser.id];

  const { error: updateError } = await supabase
    .from("messages_shop")
    .update({ deleted_by: newDeletedBy })
    .eq("id", messageId);

  if (updateError) { console.error(updateError); return; }

  // Recharger la discussion
  await loadMessagesShop();

  // V√©rifier si tous les messages sont supprim√©s ‚Üí enlever discussion
  const { data: remainingMessages } = await supabase
    .from("messages_shop")
    .select("id")
    .eq("shop_id", msg.shop_id)
    .or(`deleted_by.is.null,deleted_by.not.cs.{${currentUser.id}}`);

  if (!remainingMessages || remainingMessages.length === 0) {
    await loadDiscussionsAchat();
    await loadDiscussionsVente();
  }

  updateUnreadBadge();
}
async function loadDiscussionsAchat() {
  const { data, error } = await supabase
    .from('messages_shop')
    .select('shop_id, message, image_url, video_url, audio_url, from_user, to_user, created_at, shops(name)')
    .eq('from_user', currentUser.id)
    .or(`deleted_by.is.null,deleted_by.not.cs.{${currentUser.id}}`)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }

  discussionsList.innerHTML = "";

  const filteredData = data.filter(msg => msg.message || msg.image_url || msg.video_url || msg.audio_url);

  const grouped = {};
  filteredData.forEach(msg => {
    if (!grouped[msg.shop_id]) grouped[msg.shop_id] = [];
    grouped[msg.shop_id].push(msg);
  });

  for (const [shopId, msgs] of Object.entries(grouped)) {
    const lastMsg = msgs[msgs.length - 1];

    // V√©rifier si la discussion existe d√©j√†
    const existingDiv = document.querySelector(`.discussion-item[data-shop-id='${shopId}']`);
    if (existingDiv) {
      // Mettre √† jour le preview du dernier message
      const previewSpan = existingDiv.querySelector("small");
      if (previewSpan) {
        let preview = lastMsg.message 
          ? lastMsg.message.slice(0, 30) + (lastMsg.message.length > 30 ? "‚Ä¶" : "")
          : lastMsg.image_url ? "[Image]" 
          : lastMsg.video_url ? "[Vid√©o]" 
          : lastMsg.audio_url ? "[Audio]" 
          : "";
        previewSpan.textContent = preview;
      }
      continue; // ne pas cr√©er de nouveau div
    }

    // r√©cup√©rer username et last_seen du propri√©taire
    const { data: ownerProfile } = await supabase
      .from('profiles')
      .select('username, last_seen')
      .eq('id', lastMsg.to_user)
      .single();

    const ownerUsername = ownerProfile?.username || "Propri√©taire";
    const isOnline = ownerProfile?.last_seen 
      ? ((new Date() - new Date(ownerProfile.last_seen)) / 1000) < 120 
      : false;

    let preview = lastMsg.message 
      ? lastMsg.message.slice(0, 30) + (lastMsg.message.length > 30 ? "‚Ä¶" : "")
      : lastMsg.image_url ? "[Image]" 
      : lastMsg.video_url ? "[Vid√©o]" 
      : lastMsg.audio_url ? "[Audio]" 
      : "";

    const div = document.createElement('div');
    div.className = "discussion-item";
    div.dataset.shopId = shopId;

    const nameSpan = document.createElement("span");
    nameSpan.innerHTML = `<strong>${ownerUsername}</strong> ¬∑ ${lastMsg.shops?.name || "Boutique inconnue"}`;

    const onlineIndicator = document.createElement("span");
    onlineIndicator.style.display = "inline-block";
    onlineIndicator.style.width = "10px";
    onlineIndicator.style.height = "10px";
    onlineIndicator.style.borderRadius = "50%";
    onlineIndicator.style.marginLeft = "6px";
    onlineIndicator.style.background = isOnline ? "green" : "gray";
    nameSpan.appendChild(onlineIndicator);

    const previewSpan = document.createElement("small");
    previewSpan.textContent = preview;
    previewSpan.style.display = "block";

    div.appendChild(nameSpan);
    div.appendChild(previewSpan);

    div.onclick = async () => {
      currentShop = { id: lastMsg.shop_id, name: lastMsg.shops?.name, owner_id: lastMsg.to_user };
      chatContainer.classList.add("open");
      chatTitle.textContent = `Boutique: ${currentShop.name}`;
      await loadMessagesShop();
    };

    discussionsList.appendChild(div);
  }
}
  
      async function loadDiscussionsVente() {
  const { data, error } = await supabase
    .from('messages_shop')
    .select('shop_id, message, image_url, video_url, audio_url, from_user, to_user, created_at, is_read, shops(name)')
    .eq('to_user', currentUser.id)
    .or(`deleted_by.is.null,deleted_by.not.cs.{${currentUser.id}}`)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }

  discussionsList.innerHTML = "";

  const filteredData = data.filter(msg => msg.message || msg.image_url || msg.video_url || msg.audio_url);

  const grouped = {};
  filteredData.forEach(msg => {
    if (!grouped[msg.shop_id]) grouped[msg.shop_id] = [];
    grouped[msg.shop_id].push(msg);
  });

  for (const [shopId, msgs] of Object.entries(grouped)) {
    const lastMsg = msgs[msgs.length - 1];

    // V√©rifier si la discussion existe d√©j√†
    const existingDiv = document.querySelector(`.discussion-item[data-shop-id='${shopId}']`);
    if (existingDiv) {
      // Mettre √† jour le preview et badge non lu
      const previewSpan = existingDiv.querySelector("small");
      if (previewSpan) {
        let preview = lastMsg.message 
          ? lastMsg.message.slice(0, 30) + (lastMsg.message.length > 30 ? "‚Ä¶" : "")
          : lastMsg.image_url ? "[Image]" 
          : lastMsg.video_url ? "[Vid√©o]" 
          : lastMsg.audio_url ? "[Audio]" 
          : "";
        previewSpan.textContent = preview;
      }

      const nameSpan = existingDiv.querySelector("span");
      const unreadCount = msgs.filter(m => !m.is_read).length;
      let badge = nameSpan.querySelector(".unread-badge");
      if (!badge && unreadCount > 0) {
        badge = document.createElement("span");
        badge.className = "unread-badge";
        nameSpan.appendChild(badge);
      }
      if (badge) {
        badge.textContent = unreadCount;
        badge.style.background = "red";
        badge.style.color = "white";
        badge.style.borderRadius = "50%";
        badge.style.padding = "2px 6px";
        badge.style.fontSize = "12px";
        badge.style.marginLeft = "8px";
      }
      continue; // ne pas cr√©er de nouveau div
    }

    const { data: senderProfile } = await supabase
      .from('profiles')
      .select('username, last_seen')
      .eq('id', lastMsg.from_user)
      .single();

    const senderUsername = senderProfile?.username || "Utilisateur";
    const isOnline = senderProfile?.last_seen 
      ? ((new Date() - new Date(senderProfile.last_seen)) / 1000) < 120 
      : false;

    let preview = lastMsg.message 
      ? lastMsg.message.slice(0, 30) + (lastMsg.message.length > 30 ? "‚Ä¶" : "")
      : lastMsg.image_url ? "[Image]" 
      : lastMsg.video_url ? "[Vid√©o]" 
      : lastMsg.audio_url ? "[Audio]" 
      : "";

    const div = document.createElement('div');
    div.className = "discussion-item";
    div.dataset.shopId = shopId;

    const nameSpan = document.createElement("span");
    nameSpan.innerHTML = `<strong>${senderUsername}</strong> ¬∑ ${lastMsg.shops?.name || "Boutique inconnue"}`;

    const onlineIndicator = document.createElement("span");
    onlineIndicator.style.display = "inline-block";
    onlineIndicator.style.width = "10px";
    onlineIndicator.style.height = "10px";
    onlineIndicator.style.borderRadius = "50%";
    onlineIndicator.style.marginLeft = "6px";
    onlineIndicator.style.background = isOnline ? "green" : "gray";
    nameSpan.appendChild(onlineIndicator);

    const unreadCount = msgs.filter(m => !m.is_read).length;
    if (unreadCount > 0) {
      const badge = document.createElement("span");
      badge.className = "unread-badge";
      badge.textContent = unreadCount;
      badge.style.background = "red";
      badge.style.color = "white";
      badge.style.borderRadius = "50%";
      badge.style.padding = "2px 6px";
      badge.style.fontSize = "12px";
      badge.style.marginLeft = "8px";
      nameSpan.appendChild(badge);
    }

    const previewSpan = document.createElement("small");
    previewSpan.textContent = preview;
    previewSpan.style.display = "block";

    div.appendChild(nameSpan);
    div.appendChild(previewSpan);

    div.onclick = async () => {
      currentShop = { id: lastMsg.shop_id, name: lastMsg.shops?.name, owner_id: lastMsg.from_user };
      chatContainer.classList.add("open");
      chatTitle.textContent = `Boutique: ${currentShop.name}`;
      await loadMessagesShop();
    };

    discussionsList.appendChild(div);
  }
}
  
// ====== SUPPRIMER DISCUSSION ======
async function deleteCurrentDiscussion() {
  if (!currentShop || !currentUser) {
    alert("Aucune discussion s√©lectionn√©e");
    return;
  }

  const ok = confirm("Supprimer toute la discussion ?");
  if (!ok) return;

  // 1Ô∏è‚É£ R√©cup√©rer les messages NON d√©j√† supprim√©s par l'utilisateur
  const { data: messages, error } = await supabase
    .from("messages_shop")
    .select("id, deleted_by")
    .eq("shop_id", currentShop.id)
    .not("deleted_by", "cs", `{${currentUser.id}}`);

  if (error) {
    console.error(error);
    alert("Erreur r√©cup√©ration messages");
    return;
  }

  if (!messages || messages.length === 0) {
    console.log("Aucun message √† supprimer");
  }

  // 2Ô∏è‚É£ Marquer chaque message comme supprim√© pour l'utilisateur
  for (const msg of messages) {
    const deletedBy = Array.isArray(msg.deleted_by)
      ? [...new Set([...msg.deleted_by, currentUser.id])]
      : [currentUser.id];

    const { error: updateError } = await supabase
      .from("messages_shop")
      .update({ deleted_by: deletedBy })
      .eq("id", msg.id);

    if (updateError) {
      console.error("Erreur update:", updateError);
    }
  }

  // 3Ô∏è‚É£ Nettoyage UI
  chatContainer.classList.remove("open");
  messagesList.innerHTML = "";
  currentShop = null;

  // 4Ô∏è‚É£ Recharger listes + badge
  await loadDiscussionsAchat();
  await loadDiscussionsVente();
  await updateUnreadBadge();

  console.log("‚úÖ Discussion supprim√©e d√©finitivement pour l'utilisateur");
}

deleteChat.onclick = deleteCurrentDiscussion;
  
  // ====== REALTIME : NOUVEAUX MESSAGES ======
const messagesChannel = supabase
  .channel('messages-shop-realtime')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'messages_shop'
    },
    async (payload) => {
      const newMsg = payload.new;

      // ‚ùå ignorer ses propres messages
      if (newMsg.from_user === currentUser.id) return;

      // ‚úÖ Si on est DANS la discussion ouverte
      if (currentShop && newMsg.shop_id === currentShop.id) {
        await loadMessagesShop();      // afficher le message
        await markMessagesAsRead();    // le marquer lu
      } 
      // ‚úÖ Sinon ‚Üí badge
      else {
        await updateUnreadBadge();
      }
    }
  )
  .subscribe();

// ====== INIT ======
await loadShops();  // maj correct de la casse
await updateUnreadBadge();
await loadDiscussionsAchat();
  
</script>

</body>
</html>
