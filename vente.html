
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Online Shop ‚Äì Sell Live Marketplace</title>

<meta name="description" content="Discover this online shop on Sell Live. View products, prices, and contact the shop owner directly via WhatsApp.">

<meta name="keywords" content="online shop, boutique en ligne, marketplace shop, seller shop, ecommerce store">

<meta name="robots" content="index, follow">

<link rel="canonical" href="https://fiacre06.github.io/Sell-live/shop.html">

<!-- Open Graph -->
<meta property="og:title" content="Online Shop ‚Äì Sell Live">
<meta property="og:description" content="Visit this shop on Sell Live and contact the owner directly via WhatsApp.">
<meta property="og:url" content="https://fiacre06.github.io/Sell-live/shop.html">
<meta property="og:type" content="website">
<meta property="og:image" content="https://fiacre06.github.io/Sell-live/assets/preview.png">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Online Shop ‚Äì Sell Live">
<meta name="twitter:description" content="Discover shops and products on Sell Live marketplace.">
<style>
/* ===== BODY ===== */
  body {
  margin: 0;
  padding: 10px 15px 15px 15px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(
  180deg,
  #f3f8f4 0%,
  #ffffff 100%
);
  color: #333;
  }

/* ===== HEADER ===== */
header.topbar {
  background:
    linear-gradient(rgba(16,42,35,.85),rgba(16,42,35,.92));
  color: white;
  padding: 15px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

header.topbar span#userName {
  font-weight: bold;
  display: block;
}

header.topbar .top-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

header.topbar .top-actions button {
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 600;
}
#userName{font-size:14px; margin-bottom: 8px;background:rgba(255,255,255,0.2);padding:10px 10px;border-radius:20px; height:25px;}
  
#goToAchat { position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 80px;
  height: 40px;
  padding: 0 18px;
  background: #4caf50;
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
#goToAchat:hover { background: #e67e22; }
.logout { background: #c0392b; }
.logout:hover { background: #e74c3c; }

/* ===== BOUTIQUES ===== */
.container {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.container::-webkit-scrollbar {
  height: 8px;
}
.container::-webkit-scrollbar-thumb {
  background: #2e8b57;
  border-radius: 10px;
}

/* Carte boutique */
.shopCard {
  background: #fff;
  min-width: 220px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  text-align: center;
}

.shopCard:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.shopCard img {
  width: 100%;
  height: 140px;
  object-fit: cover;
}

.shopCard h4 {
  margin: 10px 0 5px;
  font-size: 18px;
}

.shopCard small {
  color: #777;
  margin-bottom: 10px;
}

.shopCard button {
  margin: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: #2e8b57;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

.shopCard button:hover { background: #27ae60; }

/* ===== MODAL ===== */
#shopFullModal {
  position: fixed;
  top: 0; left: -12px;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 1000;
  overflow-y: auto;
  padding: 30px 15px;
}

#shopFullModal .modal-content {
  background: #fff;
  border-radius: 12px;
  max-width: 600px;
  margin: auto;
  padding: 20px;
  position: relative;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
}

#shopFullModal span#closeShopFullModal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #333;
}

#shopFullModal input, #shopFullModal textarea {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1em;
}

#shopFullModal button.addBtn {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
  background: #2e8b57;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

#shopFullModal button.addBtn:hover {
  background: #27ae60;
}

/* ===== PRODUITS DANS BOUTIQUE ===== */
#productsContainer {
  display: flex;
  gap: 15px;
  overflow-x: auto;
  padding: 10px 0;
}

#productsContainer::-webkit-scrollbar {
  height: 6px;
}

#productsContainer::-webkit-scrollbar-thumb {
  background: #2e8b57;
  border-radius: 10px;
}

.productCard {
  background: #fff;
  min-width: 180px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  overflow: hidden;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 10px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.productCard:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}

.productCard img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}

/* Responsive */
@media (max-width:600px) {
  .shopCard, .productCard { min-width: 150px; }
  header.topbar span#userName { font-size: 14px; }
}
  #createShopBtn{background:#4caf50; width:200px; border-radius:20px; color:#fff; font-size: 15px; height:50px;}
  
  
  .premium-sidebar{
  position:fixed;
  top:0;
  right:-400px;
  width:330px;
  height:100%;
  background:#fff;
  box-shadow:-5px 0 15px rgba(0,0,0,0.2);
  transition:0.3s;
  padding:20px;
  z-index:9999;
  overflow-y:auto;
}

.premium-sidebar.active{
  right:0;
}

.close-btn{
  font-size:25px;
  cursor:pointer;
  float:right;
}

.premium-card{
  background:#f9f9f9;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
  text-align:center;
}

.premium-card button{
  background:#ff9800;
  border:none;
  padding:8px 15px;
  color:#fff;
  border-radius:5px;
  cursor:pointer;
}

  /* ===== MODALE ===== */
.categoryModal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 10px;
}

.categoryModal.hidden {
  display: none;
}

.categoryBox {
  background: #fff;
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  border-radius: 16px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* ===== RECHERCHE ===== */
.categorySearch {
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  margin-bottom: 10px;
  font-size: 14px;
  outline: none;
  transition: 0.2s;
}

.categorySearch:focus {
  border-color: #2e7d32;
  box-shadow: 0 0 5px rgba(46, 125, 50, 0.4);
}

/* ===== LISTE ===== */
#categoryList {
  flex: 1;
  overflow-y: auto;
  padding-right: 4px;
}

/* ===== GROUPE ===== */
.categoryGroupTitle {
  font-weight: bold;
  margin: 10px 0 6px;
  font-size: 14px;
  color: #333;
  border-bottom: 1px solid #eee;
  padding-bottom: 4px;
}

/* ===== CARTE DE SOUS-CAT√âGORIE ===== */
.categoryItem {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
  background: #f9f9f9;
  user-select: none;
  border: 2px solid transparent;
}

.categoryItem:hover {
  transform: scale(1.02);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
}

.categoryItem.selected {
  border-color: #2e7d32;
  background: #e8f5e9;
}

/* CHECKBOX DEVANT LE TEXTE */
.categoryItem input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #2e7d32;
  flex-shrink: 0;
  pointer-events: none; /* pour que le clic sur la carte suffise */
}

/* IC√îNE DEVANT LE TEXTE */
.catIcon {
  font-size: 18px;
  flex-shrink: 0;
}

/* TEXTE DE LA CAT√âGORIE */
.categoryItem span.text {
  flex: 1;
  color: #333;
  font-weight: 500;
  overflow-wrap: anywhere;
}

/* ===== BOUTONS ===== */
.categoryActions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

#closeCategoryBtn,
#validateCategoryBtn {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
  font-size: 14px;
}

/* BOUTON FERMER */
#closeCategoryBtn {
  background: #e53935;
  color: #fff;
}

#closeCategoryBtn:hover {
  background: #d32f2f;
}

/* BOUTON VALIDER */
#validateCategoryBtn {
  background: #2e7d32;
  color: #fff;
}

#validateCategoryBtn:hover {
  background: #27632a;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
  .categoryBox {
    padding: 12px;
  }

  .categoryItem {
    padding: 6px 8px;
    font-size: 13px;
    gap: 6px;
  }

  .categorySearch {
    font-size: 13px;
    padding: 8px 10px;
  }

  #closeCategoryBtn,
  #validateCategoryBtn {
    font-size: 13px;
    padding: 8px;
  }
}
  
/* ================== CREATE SHOP SECTION ================== */
#createShopSection{
  background:#ffffff;
  max-width:520px;
  margin:40px auto;
  padding:28px;
  border-radius:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* ===== TITRE ===== */
#createShopSection h3{
  margin:0 0 10px;
  font-size:1.5rem;
  color:#2e8b57;
  text-align:center;
}

/* ===== INPUTS / TEXTAREA ===== */
#createShopSection input,
#createShopSection textarea{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  font-size:.95rem;
  outline:none;
  transition:.2s;
  background:#f9fafb;
}

#createShopSection textarea{
  min-height:90px;
  resize:vertical;
}

/* Focus */
#createShopSection input:focus,
#createShopSection textarea:focus{
  border-color:#2e8b57;
  background:#ffffff;
  box-shadow:0 0 0 3px rgba(46,139,87,.12);
}

/* ===== CATEGORY INPUT ===== */
#shopCategory{
  cursor:pointer;
  background:#f0fdf4;
  border:1px dashed #2e8b57;
  font-weight:600;
  color:#166534;
}

/* ===== LOCATION ===== */
#shopLocation{
  background:#f9fafb;
}

/* ===== LIVRAISON CHECKBOX ===== */
#createShopSection label{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:600;
  color:#374151;
  background:#f0fdf4;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid #bbf7d0;
  cursor:pointer;
}

#createShopSection input[type="checkbox"]{
  width:18px;
  height:18px;
  accent-color:#2e8b57;
}

/* ===== WHATSAPP INPUT ===== */
#whatsapp{
  border:1px solid #25D366;
  background:#f0fdf4;
  font-weight:500;
}

/* ===== IMAGE INPUT ===== */
#shopImage{
  padding:10px;
  background:#f9fafb;
  border:1px dashed #d1d5db;
  cursor:pointer;
}

/* ===== SUBMIT BUTTON ===== */
#submitShopBtn{
  margin-top:10px;
  padding:15px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#2e8b57,#3cb371);
  color:white;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  transition:.25s;
  box-shadow:0 10px 25px rgba(46,139,87,.35);
}

#submitShopBtn:hover{
  transform:translateY(-2px);
  opacity:.95;
}

#submitShopBtn:active{
  transform:scale(.97);
  }
  /* ================== MOBILE ================== */
@media(max-width:480px){
  #createShopSection{
    padding:20px;
  }
  }

  
/* LOGO */
.logo-box{
  display:flex;
  align-items:center;
  gap:0px;
}

.logo-box img{
  height:120px;
  width:100%;
 padding: 0px;
}

  /* ============================= */
/* üõí SECTION PRODUITS BOUTIQUE */
/* ============================= */

#shopProductsSection {
  background: #f9fbfa;
  padding: 16px;
  border-radius: 16px;
}

/* ===== TITRE ===== */
#shopProductsTitle {
  font-size: 1.3rem;
  margin-bottom: 12px;
  color: #1b5e20;
  font-weight: 700;
}

/* ============================= */
/* ‚ûï FORMULAIRE AJOUT PRODUIT */
/* ============================= */

.cardForm {
  background: #ffffff;
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

/* INPUTS & SELECT */
.cardForm input,
.cardForm textarea,
.cardForm select {
  width: 100%;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1.5px solid #e0e0e0;
  font-size: 0.95rem;
  transition: all 0.2s ease;
  outline: none;
}

.cardForm textarea {
  resize: none;
}

/* FOCUS */
.cardForm input:focus,
.cardForm textarea:focus,
.cardForm select:focus {
  border-color: #2e7d32;
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.15);
}

/* FILE INPUT */
.cardForm input[type="file"] {
  padding: 8px;
  background: #f5f5f5;
}

/* ============================= */
/* ‚ûï BOUTON AJOUT PRODUIT */
/* ============================= */

.addBtn {
  background: linear-gradient(135deg, #2e7d32, #43a047);
  color: #fff;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.addBtn:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(46, 125, 50, 0.35);
}

.addBtn:active {
  transform: scale(0.98);
}

/* ============================= */
/* üìã LISTE DES PRODUITS */
/* ============================= */

.productsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 14px;
}

/* ===== CARTE PRODUIT ===== */
.productCard {
  background: #ffffff;
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.productCard:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 22px rgba(0, 0, 0, 0.1);
}

/* IMAGE PRODUIT */
.productCard img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 10px;
}

/* NOM */
.productCard h4 {
  font-size: 1rem;
  margin: 6px 0 2px;
  color: #263238;
}

/* DESCRIPTION */
.productCard p {
  font-size: 0.85rem;
  color: #616161;
}

/* PRIX */
.productCard strong {
  margin-top: 4px;
  color: #1b5e20;
  font-size: 1rem;
}

/* BOUTON SUPPRESSION */
.deleteProductBtn {
  border: none;
  border-radius: 10px;
  padding: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 6px;
  transition: opacity 0.2s ease;
}

.deleteProductBtn:hover {
  opacity: 0.85;
}

/* ============================= */
/* üì± RESPONSIVE */
/* ============================= */

@media (max-width: 480px) {
  #shopProductsTitle {
    font-size: 1.15rem;
  }


  /* ===== COMPTEUR DE PI√àCES STYLE PI√àCE ===== */
.user-coins {
  position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 70px;
  height: 40px;
  padding: 0 18px;
  background: linear-gradient(145deg, #ffd700, #ffb700);
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}

/* Effet hover dynamique */
.user-coins:hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.25),
    0 6px 18px rgba(0,0,0,0.25);
  background: linear-gradient(145deg, #ffe34d, #ffc107);
}

/* Ic√¥ne de pi√®ce */
.user-coins .coin-icon {
  font-size: 22px;
  display: inline-block;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  animation: bounceCoin 1.2s infinite alternate;
}

/* Animation l√©g√®re de la pi√®ce */
@keyframes bounceCoin {
  0% { transform: translateY(0); }
  50% { transform: translateY(-2px); }
  100% { transform: translateY(0); }
}

/* Nombre de pi√®ces */
.user-coins .coin-text {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* Petit reflet sur la pi√®ce */
.user-coins::before {
  content: "";
  position: absolute;
  width: 60%;
  height: 30%;
  top: 5px;
  left: 15%;
  background: rgba(255,255,255,0.35);
  border-radius: 50%;
  pointer-events: none;
  transform: rotate(-25deg);
}

/* Optionnel : effet ‚Äúclic‚Äù sur pi√®ce */
.user-coins:active {
  transform: scale(0.97);
  box-shadow:
    inset 0 -2px 0 rgba(0,0,0,0.2),
    0 3px 8px rgba(0,0,0,0.15);
}

/* ===== MODALE RECHARGE PI√àCES ===== */
#coinsModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.45);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

#coinsModal > div {
  background: #ffffff;
  padding: 25px 20px;
  border-radius: 20px;
  width: 360px;
  max-width: 95%;
  text-align: center;
  box-shadow: 0 16px 40px rgba(0,0,0,0.15);
  position: relative;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  0% { transform: translateY(-30px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}

#coinsModal h3 {
  margin-bottom: 12px;
  font-size: 22px;
  font-weight: 700;
  color: #222;
}

#coinsModal p {
  margin-bottom: 20px;
  font-size: 14px;
  color: #555;
}

/* ===== BOUTONS ACHAT ===== */
.buyCoinsBtn {
  display: inline-block;
  padding: 12px 20px;
  margin: 8px 6px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  color: #fff;
  cursor: pointer;
  box-shadow: 0 6px 12px rgba(0,0,0,0.12);
  transition: all 0.2s ease;
  min-width: 110px;
}

.buyCoinsBtn:hover {
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 8px 16px rgba(0,0,0,0.18);
}

.buyCoinsBtn:active {
  transform: scale(0.97);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Couleurs pro selon niveau */
.buyCoinsBtn[data-coins="5"] { background: #43a047; }    /* vert */
.buyCoinsBtn[data-coins="10"] { background: #1e88e5; }   /* bleu */
.buyCoinsBtn[data-coins="20"] { background: #f57c00; }   /* orange */
.buyCoinsBtn[data-coins="50"] { background: #8e24aa; }   /* violet */

/* Bouton fermer modal */
#closeCoinsModal {
  width: 100%;
  margin-top: 15px;
  padding: 12px;
  background-color: #e53935;
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

#closeCoinsModal:hover {
  background-color: #d32f2f;
                               }
  .productCard img {
    height: 120px;
  }
#premiumMenuBtn {
    position: relative; /* pour le reflet */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 80px;
  height: 40px;
  padding: 0 18px;
  background:#ff9800;
  border-radius: 50px;
  font-weight: 700;
  font-size: 16px;
  color: #fff;
  box-shadow:
    inset 0 -3px 0 rgba(0,0,0,0.2),
    0 4px 12px rgba(0,0,0,0.2);
  border: 2px solid #ffeb3b;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  transition: all 0.25s ease;
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="topbar">
  <!-- LOGO -->
    <div class="logo-box">
      <img src="assets/img/logos.png" alt="MANG - March√© Agricole Nouvelle G√©n√©ration">
    </div>
  <div id="userHeader">
  <span id="userName">Connect√© : NomUtilisateur</span>
</div>
  <div id="premiumCounter" style="color:orange; font-weight:bold;"></div>
  
  <div class="top-actions">
    <button id="goToAchat">Acheter</button>
    <button id="premiumMenuBtn" class="premiumHeaderBtn">Premium</button>


    <!-- Compteur de pi√®ces cliquable -->
<div class="user-coins" id="userCoinsBtn">
  <span class="coin-icon">üí∞</span>
  <span class="coin-text">0</span>
</div>
    
  </div>

  
<!-- Modal recharge pi√®ces -->
<div id="coinsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:300px; max-width:90%;">
    <h3>Recharger des pi√®ces</h3>
    <p>5 pi√®ces = 100 FCFA</p>

    <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
      <button class="buyCoinsBtn" data-coins="5" data-price="100" style="padding:8px; background:#4CAF50; color:#fff; border:none; border-radius:6px;">Acheter 5 pi√®ces (100 FCFA)</button>
      <button class="buyCoinsBtn" data-coins="10" data-price="200" style="padding:8px; background:#2196F3; color:#fff; border:none; border-radius:6px;">Acheter 10 pi√®ces (200 FCFA)</button>
      <button class="buyCoinsBtn" data-coins="20" data-price="350" style="padding:8px; background:#FF9800; color:#fff; border:none; border-radius:6px;">Acheter 20 pi√®ces (350 FCFA)</button>
      <button class="buyCoinsBtn" data-coins="50" data-price="950" style="padding:8px; background:#9C27B0; color:#fff; border:none; border-radius:6px;">Acheter 50 pi√®ces (950 FCFA)</button>
    </div>

    <button id="closeCoinsModal" style="width:100%; padding:8px; margin-top:10px; background:#e53935; color:#fff; border:none; border-radius:6px;">Fermer</button>
  </div>
</div>
</header>
<!-- ===== SIDEBAR PREMIUM ===== -->
<div id="premiumSidebar" class="premium-sidebar">
  <span id="closePremiumSidebar" class="close-btn">&times;</span>

  <h3>üöÄ Devenir Premium</h3>
  <p>Augmentez la visibilit√© de votre boutique et vos ventes !</p>

  <div class="premium-cards">

    <div class="premium-card" data-level="premium1" data-price="1000">
      <h4>Premium 1 ‚≠ê</h4>
      <p>Jusqu'√† 20 produits<br>Boutique affich√©e plus haut</p>
      <button class="premiumBtn">Payer 1 000 FCFA / mois</button>
    </div>

    <div class="premium-card" data-level="premium2" data-price="2000">
      <h4>Premium 2 ‚≠ê‚≠ê</h4>
      <p>Jusqu'√† 30 produits<br>Boutique prioritaire</p>
      <button class="premiumBtn">Payer 2 000 FCFA / mois</button>
    </div>

    <div class="premium-card" data-level="premium3" data-price="3000">
      <h4>Premium 3 ‚≠ê‚≠ê‚≠ê</h4>
      <p>Nombre illimit√© de produits<br>Boutique toujours en haut</p>
      <button class="premiumBtn">Payer 3 000 FCFA / mois</button>
    </div>

  </div>
</div>
  
<!-- ===== MES BOUTIQUES ===== -->
<h3>Mes boutiques</h3>
<div class="container" id="myShops"></div>
<button id="createShopBtn" class="addBtn">üè™ Prendre une boutique</button>

<!-- ===== MODAL BOUTIQUE + PRODUITS ===== -->
<div id="shopFullModal">
  <div class="modal-content">
    <span id="closeShopFullModal">&times;</span>

    <!-- ===== CR√âER UNE BOUTIQUE ===== -->
<div id="createShopSection">
  <h3>Cr√©er une boutique</h3>

  <input
    id="shopName"
    placeholder="Nom de la boutique"
    required
  >

  <textarea
    id="shopDesc"
    placeholder="Description"
  ></textarea>

 <!-- Champ cat√©gorie -->
<input
  id="shopCategory"
  placeholder="Choisir une cat√©gorie"
  readonly
/>

<!-- MODALE CAT√âGORIES -->
<div id="categoryModal" class="categoryModal hidden">
  <div class="categoryBox">
    
    <input
      type="text"
      id="categorySearch"
      placeholder="üîç Rechercher une sous-cat√©gorie..."
      class="categorySearch"
    />

    <div id="categoryList"></div>

    <div class="categoryActions">
      <button type="button" id="validateCategoryBtn">Valider</button>
      
      <button type="button" id="closeCategoryBtn">Fermer</button>
    </div>

  </div>
</div>
  <input
    id="shopLocation"
    placeholder="Lieu"
  >

 <!-- Livraison -->
<label style="display:block;margin-top:10px;">
  <input type="checkbox" id="livraison">
  üöö Livraison disponible
</label>

<!-- WhatsApp -->
<input
  type="tel"
  id="whatsapp"
  placeholder="Num√©ro WhatsApp (ex: +229XXXXXXXX)"
  style="width:100%;margin-top:10px;"
>
  
  <input type="hidden" id="latitude">
<input type="hidden" id="longitude">

  <input
    type="file"
    id="shopImage"
    accept="image/*"
  >

  <button
    id="submitShopBtn"
    class="addBtn"
  >
    Cr√©er la boutique
  </button>
</div>

    <!-- ============================= -->
<!-- üõí PRODUITS DE LA BOUTIQUE -->
<!-- ============================= -->
<div id="shopProductsSection" style="display:none; margin-top:20px;">

  <h3 id="shopProductsTitle">Produits de la boutique</h3>

  <!-- ‚ûï FORMULAIRE AJOUT PRODUIT -->
  <div id="addProductForm" class="cardForm">

    <input
      type="text"
      id="productName"
      placeholder="Nom du produit"
      required
    >

    <textarea
      id="productDesc"
      placeholder="Description du produit"
      rows="3"
    ></textarea>

    <input
      type="number"
      id="productPrice"
      placeholder="Prix en FCFA"
      min="0"
      required
    >

    <!-- üì¶ DISPONIBILIT√â -->
    <select id="productAvailability">
      <option value="now">‚úÖ Disponible maintenant</option>
      <option value="1_week">‚è≥ Dans 1 semaine</option>
      <option value="2_weeks">‚è≥ Dans 2 semaines</option>
      <option value="1_month">üìÖ Dans 1 mois</option>
      <option value="2_months">üìÖ Dans 2 mois</option>
      <option value="3_months">üìÖ Dans 3 mois</option>
      <option value="6_months">üìÖ Dans 6 mois</option>
      <option value="1_year">üìÜ Dans 1 an</option>
    </select>

    <!-- üñºÔ∏è IMAGE PRODUIT -->
    <input
      type="file"
      id="productImage"
      accept="image/*"
    >

    <button
      id="submitProductBtn"
      class="addBtn"
      type="button"
    >
      ‚ûï Ajouter le produit
    </button>

  </div>

  <!-- üìã LISTE DES PRODUITS -->
  <div id="productsContainer" class="productsGrid"></div>

</div>
<script type="module">
import { supabase } from './supabase.js';

let currentUser = null;
let currentProfile = null;
let currentShop = null;

// ===== ELEMENTS DOM =====
const myShopsContainer = document.getElementById("myShops");
document.addEventListener('DOMContentLoaded', () => {
  const shopFullModal = document.getElementById('shopFullModal');
  const closeBtn = document.getElementById('closeShopFullModal');

  if (!shopFullModal || !closeBtn) {
    console.error("‚ùå Modal ou bouton fermer introuvable");
    return;
  }

  // Clique sur X
  closeBtn.addEventListener('click', () => {
    shopFullModal.style.display = "none";
  });

  // Optionnel : fermer si on clique √† l‚Äôext√©rieur du modal
  window.addEventListener('click', (e) => {
    if (e.target === shopFullModal) {
      shopFullModal.style.display = "none";
    }
  });
});
  document.getElementById('createShopBtn').onclick = () => {
  shopFullModal.style.display = "block";
  createShopSection.style.display = "block";
  shopProductsSection.style.display = "none";
};
const createShopSection = document.getElementById("createShopSection");
const shopProductsSection = document.getElementById("shopProductsSection");
const shopProductsTitle = document.getElementById("shopProductsTitle");

const shopName = document.getElementById("shopName");
const shopDesc = document.getElementById("shopDesc");
const shopCategory = document.getElementById("shopCategory");
const shopLocation = document.getElementById("shopLocation");
const shopImage = document.getElementById("shopImage");
const submitShopBtn = document.getElementById("submitShopBtn");

const productName = document.getElementById("productName");
const productDesc = document.getElementById("productDesc");
const productPrice = document.getElementById("productPrice");
const productImage = document.getElementById("productImage");
const submitProductBtn = document.getElementById("submitProductBtn");

const userNameEl = document.getElementById('userName');

// ===== LIMITES PRODUITS SELON PREMIUM =====
const shopProductLimits = {
  free: 10,
  premium1: 20,
  premium2: 30,
  premium3: Infinity
};

// ===== LOGIN & PROFIL =====
  
  async function loadCurrentUser() {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    location.href = "login.html";
    return;
  }
  currentUser = user;

  // üîπ R√©cup√©rer le profil (coins, premium)
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select('*, coins, premium_start, premium_level')
    .eq('id', currentUser.id)
    .single();

  if (profileError || !profile) {
    console.error("Erreur chargement profil :", profileError);
    return;
  }
  currentProfile = profile;

  // üîπ Mettre √† jour le compteur de pi√®ces
  const coinsElement = document.querySelector(".coin-text");
  if (coinsElement) {
    coinsElement.textContent = Number(profile.coins || 0).toString().padStart(2, "0");
  }

  // üîπ R√©cup√©rer le solde wallet
  const { data: walletData } = await supabase
    .from("wallets")
    .select("balance, available_balance")
    .eq("user_id", currentUser.id)
    .single();

  if (walletData) {
    const walletText = document.getElementById("walletBalance");
    if (walletText) {
      walletText.textContent = Number(walletData.available_balance || 0).toLocaleString() + " FCFA";
    }
  }

  // üîπ V√©rifier expiration premium (30 jours)
  if (currentProfile.premium_start) {
    const start = new Date(currentProfile.premium_start);
    const now = new Date();
    const diffDays = Math.floor((now - start) / (1000 * 60 * 60 * 24));
    if (diffDays >= 30) {
      await supabase.from('profiles').update({
        premium_level: 'free',
        premium_start: null
      }).eq('id', currentUser.id);
      currentProfile.premium_level = 'free';
    }
  }

  // üîπ Mettre √† jour UI
  renderUserIdentity();
  loadMyShops();
  }
// ===== AFFICHAGE EMAIL + BADGES PREMIUM =====
function renderUserIdentity() {
  let stars = "";
  switch(currentProfile?.premium_level) {
    case "premium1": stars = "‚≠ê"; break;
    case "premium2": stars = "‚≠ê‚≠ê"; break;
    case "premium3": stars = "‚≠ê‚≠ê‚≠ê"; break;
  }

  userNameEl.innerHTML = `
    ${currentProfile?.username || currentUser.email}
    <span style="color:gold">${stars}</span>
  `;
}
 
   // Redirection du bouton "Acheter"
  document.getElementById('goToAchat').addEventListener('click', () => {
    window.location.href = 'index.html';
  });

  
    /* ======================
   GESTION DES COINS ET ACHAT
===================== */

async function updateCoins(newCoins) {
  try {
    newCoins = Number(newCoins);
    if (isNaN(newCoins) || newCoins < 0) throw new Error("Nombre de pi√®ces invalide");

    // üîπ Mettre √† jour localement
    currentProfile.coins = newCoins;

    // üîπ Mettre √† jour le badge frontend
    const coinsElement = document.getElementById("userCoins");
    if (coinsElement) coinsElement.textContent = newCoins;

    // üîπ Mettre √† jour dans Supabase (table profiles)
    const { error } = await supabase
      .from("profiles")
      .update({ coins: newCoins })
      .eq("id", currentUser.id);

    if (error) throw error;

    console.log(`‚úÖ Coins mis √† jour : ${newCoins}`);
  } catch (err) {
    console.error("Erreur mise √† jour coins :", err);
    alert("‚ùå Impossible de mettre √† jour vos pi√®ces, v√©rifiez la console");
  }
}

// ===== S√©lection des √©l√©ments =====
const userCoinsBtn = document.getElementById("userCoinsBtn");
const coinsModal = document.getElementById("coinsModal");
const closeCoinsModal = document.getElementById("closeCoinsModal");
const coinsText = document.querySelector(".user-coins .coin-text");
const walletText = document.getElementById("walletBalance"); 

// ===== Ouvrir/fermer la modale =====
if (userCoinsBtn) userCoinsBtn.addEventListener("click", () => {
  coinsModal.style.display = "flex";
  document.body.style.overflow = "hidden";
});

if (closeCoinsModal) closeCoinsModal.addEventListener("click", () => {
  coinsModal.style.display = "none";
  document.body.style.overflow = "auto";
});

// ===== Fonction pour mettre √† jour coins et wallet =====
async function updateCoinsAndWallet(newCoins, newWallet) {
  try {
    newCoins = Number(newCoins);
    newWallet = Number(newWallet);

    if (isNaN(newCoins) || newCoins < 0) throw new Error("Nombre de pi√®ces invalide");
    if (isNaN(newWallet) || newWallet < 0) throw new Error("Solde wallet invalide");

    // üîπ Mise √† jour locale
    currentProfile.coins = newCoins;

    // üîπ Mise √† jour du front-end
    if (coinsText) coinsText.textContent = newCoins.toString().padStart(2, "0");
    if (walletText) walletText.textContent = newWallet.toLocaleString() + " FCFA";

    // üîπ Mise √† jour Supabase
    // coins => profiles, wallet => wallets
    const [{ error: coinsError }, { error: walletError }] = await Promise.all([
      supabase.from("profiles").update({ coins: newCoins }).eq("id", currentUser.id),
      supabase.from("wallets").update({ balance: newWallet, available_balance: newWallet }).eq("user_id", currentUser.id)
    ]);

    if (coinsError) throw coinsError;
    if (walletError) throw walletError;

    console.log(`‚úÖ Coins et wallet mis √† jour : ${newCoins} pi√®ces, ${newWallet} FCFA`);
  } catch (err) {
    console.error("Erreur mise √† jour coins/wallet :", err);
    alert("‚ùå Impossible de mettre √† jour vos pi√®ces ou votre solde");
  }
}

// ===== Achat de pi√®ces depuis modal =====
document.querySelectorAll(".buyCoinsBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const coinsToBuy = Number(btn.dataset.coins);
    const priceFCFA = Number(btn.dataset.price);

    if (!currentUser) return alert("Utilisateur non connect√©");

    try {
      // üîπ R√©cup√©rer le wallet
      const { data: walletData, error: walletError } = await supabase
        .from("wallets")
        .select("balance, available_balance")
        .eq("user_id", currentUser.id)
        .single();

      if (walletError || !walletData) throw walletError || new Error("Wallet introuvable");

      const wallet = Number(walletData.balance || 0);
      const coins = Number(currentProfile.coins || 0);

      if (!confirm(`Confirmer l'achat de ${coinsToBuy} pi√®ces pour ${priceFCFA} FCFA ?`)) return;

      if (wallet < priceFCFA) {
        return alert(`‚ùå Solde wallet insuffisant !\nVotre solde : ${wallet.toLocaleString()} FCFA`);
      }

      // üîπ Calcul des nouveaux montants
      const newCoins = coins + coinsToBuy;
      const newWallet = wallet - priceFCFA;

      // üîπ Mettre √† jour wallet et profiles
      await updateCoinsAndWallet(newCoins, newWallet);

      // üîπ Ajouter transaction historique
      const { error: txError } = await supabase
        .from("wallet_transactions")
        .insert({
          user_id: currentUser.id,
          amount: -priceFCFA, // d√©bit
          transaction_type: "purchase_coins",
          description: `${coinsToBuy} pi√®ces achet√©es`,
          status: "success",
          created_at: new Date().toISOString()
        });

      if (txError) console.warn("Erreur transaction historique :", txError);

      alert(`‚úÖ Achat r√©ussi ! Vous avez maintenant ${newCoins} pi√®ces et ${newWallet} FCFA`);
      
      // üîπ Fermer modal
      if (coinsModal) {
        coinsModal.style.display = "none";
        document.body.style.overflow = "auto";
      }

    } catch (err) {
      console.error("Erreur achat pi√®ces :", err);
      alert("‚ùå Une erreur est survenue lors de l'achat");
    }
  });
});
    
  // ===============================
// INPUTS CACH√âS (d√©j√† dans ton HTML)
// <input type="hidden" id="latitude">
// <input type="hidden" id="longitude">
// Bouton existant : createShopBtn
// ===============================


// üîπ Fonction pour r√©cup√©rer la position de l'utilisateur
function getUserLocation() {
  return new Promise((resolve, reject) => {

    if (!navigator.geolocation) {
      reject("La g√©olocalisation n'est pas support√©e");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        resolve({
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        });
      },
      (error) => {
        reject(error.message);
      }
    );
  });
}


// üîπ TON BOUTON EXISTANT (NE PAS EN CR√âER UN AUTRE)
document.getElementById("createShopBtn").addEventListener("click", async () => {

  const shopName = document.getElementById("shopName").value;
  const latitudeInput = document.getElementById("latitude");
  const longitudeInput = document.getElementById("longitude");

  if (!shopName) {
    alert("‚ö†Ô∏è Le nom de la boutique est obligatoire");
    return;
  }

  // üîê R√©cup√©rer l'utilisateur connect√©
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    alert("‚ö†Ô∏è Tu dois √™tre connect√© pour cr√©er une boutique");
    return;
  }

  // üåç Tentative de r√©cup√©ration de la position
  try {
    const location = await getUserLocation();
    latitudeInput.value = location.latitude;
    longitudeInput.value = location.longitude;
  } catch (err) {
    console.warn("Localisation refus√©e :", err);
    // üëâ On continue quand m√™me (comme Facebook)
  }

  // üíæ ENREGISTREMENT DE LA BOUTIQUE (TON INSERT NORMAL)
  try {
    const { error } = await supabase
      .from("shops")
      .insert([{
        name: shopName,
        owner_id: user.id,
        latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
        longitude: longitudeInput.value ? parseFloat(longitudeInput.value) : null
      }]);

    if (error) throw error;

    alert("‚úÖ Boutique cr√©√©e avec succ√®s !");
    
    // Reset
    latitudeInput.value = "";
    longitudeInput.value = "";

  } catch (error) {
    console.error(error);
    alert("‚ùå Erreur lors de la cr√©ation de la boutique");
  }
});

   // ===== CREER BOUTIQUE =====

  submitShopBtn.onclick = async () => {
  const name = shopName.value.trim();
  if (!name) {
    alert("Nom obligatoire");
    return;
  }

  if (!selectedShopCategory) {
    alert("Veuillez choisir une cat√©gorie");
    return;
  }

  // üîπ V√©rifier si l'utilisateur a assez de pi√®ces
  const cost = 10; // 10 pi√®ces pour cr√©er une boutique
  if ((currentProfile.coins || 35) < cost) {
    alert("‚ö†Ô∏è Vous n'avez pas assez de pi√®ces pour cr√©er une boutique");
    return;
  }

  // üîπ NOUVEAU : r√©cup√©ration livraison & whatsapp
  const livraison = document.getElementById("livraison")?.checked || false;
  const whatsapp = document.getElementById("whatsapp")?.value.trim() || null;

  let imageUrl = null;
  const file = shopImage.files[0];

  if (file) {
    const compressedFile = await compressImage(file, 900, 0.7);
    const fileName = `shop_${currentUser.id}_${Date.now()}.jpg`;

    const { error: uploadError } = await supabase.storage
      .from("shops")
      .upload(fileName, compressedFile, {
        contentType: "image/jpeg"
      });

    if (uploadError) {
      alert(uploadError.message);
      return;
    }

    imageUrl = supabase.storage
      .from("shops")
      .getPublicUrl(fileName).data.publicUrl;
  }

  // üîπ INSERT COMPLET AVEC LIVRAISON & WHATSAPP
  const { error } = await supabase
    .from("shops")
    .insert({
      owner_id: currentUser.id,
      name,
      description: shopDesc.value,
      category: selectedShopCategory,
      location: shopLocation.value,
      image_url: imageUrl,
      livraison: livraison,
      whatsapp: whatsapp,
      premium_level: currentProfile?.premium_level || "free"
    });

  if (error) {
    alert(error.message);
    return;
  }

  // üîπ D√©duire les pi√®ces et mettre √† jour le frontend & Supabase
  currentProfile.coins = (currentProfile.coins || 35) - cost;

  await supabase
    .from("profiles")
    .update({ coins: currentProfile.coins })
    .eq("id", currentUser.id);

  const coinsElement = document.getElementById("userCoins");
  if (coinsElement) coinsElement.textContent = currentProfile.coins;

  alert(`‚úÖ Boutique cr√©√©e ! Il vous reste ${currentProfile.coins} pi√®ces`);

  // üîÑ RESET FORMULAIRE
  shopName.value = "";
  shopDesc.value = "";
  shopCategoryInput.value = "";
  shopLocation.value = "";
  shopImage.value = "";
  if (document.getElementById("livraison")) {
    document.getElementById("livraison").checked = false;
  }
  if (document.getElementById("whatsapp")) {
    document.getElementById("whatsapp").value = "";
  }
  selectedShopCategory = null;

  shopFullModal.style.display = "none";
  loadMyShops();
};
  let selectedShopCategory = null;
let selectedMainCategory = null;
let selectedSubCategories = [];

/* ===== CAT√âGORIES ===== */
const categories = [
  {
    name: "Production v√©g√©tale",
    icon: "üå±",
    color: "#E8F5E9",
    items: [
      "C√©r√©ales & grains",
      "L√©gumes",
      "Fruits",
      "Racines & tubercules",
      "Plantes industrielles",
      "Plantes aromatiques & m√©dicinales"
    ]
  },
  {
    name: "Production animale",
    icon: "üêÑ",
    color: "#FFF3E0",
    items: [
      "Bovins",
      "Ovins & caprins",
      "Porcins",
      "Aviculture",
      "Apiculture",
      "Pisciculture & aquaculture"
    ]
  },
  {
    name: "Transformation agricole",
    icon: "üçØ",
    color: "#FCE4EC",
    items: [
      "Produits c√©r√©aliers transform√©s",
      "Produits fruitiers transform√©s",
      "Produits tubercules transform√©s",
      "Produits animaux transform√©s"
    ]
  },
  {
    name: "Machines & √©quipements agricoles",
    icon: "üöú",
    color: "#E3F2FD",
    items: [
      "Machines lourdes",
      "√âquipements motoris√©s",
      "Outils agricoles",
      "Irrigation & √©nergie",
      "Pi√®ces & maintenance"
    ]
  },
  {
    name: "Intrants agricoles",
    icon: "üåø",
    color: "#E0F2F1",
    items: [
      "Semences & plants",
      "Engrais organiques",
      "Engrais chimiques",
      "Amendements du sol",
      "Produits phytosanitaires"
    ]
  },
  {
    name: "Espaces verts",
    icon: "üå≥",
    color: "#E8F8F5",
    items: [
      "Plantes ornementales",
      "Arbres & arbustes",
      "Gazon & pelouses",
      "Fleurs & p√©pini√®res",
      "Am√©nagement paysager",
      "Entretien des espaces verts",
      "Mat√©riel de jardinage"
    ]
  },
  {
    name: "Services agricoles",
    icon: "üõ†Ô∏è",
    color: "#F3E5F5",
    items: [
      "Labour & pr√©paration du sol",
      "R√©colte & battage",
      "Transport & logistique",
      "Stockage & conservation",
      "Formation & conseil",
      "Commercialisation & export"
    ]
  }
];

/* ===== ELEMENTS DOM ===== */
const modal = document.getElementById("categoryModal");
const list = document.getElementById("categoryList");
const searchInput = document.getElementById("categorySearch");
const shopCategoryInput = document.getElementById("shopCategory");
const closeBtn = document.getElementById("closeCategoryBtn");
const validateBtn = document.getElementById("validateCategoryBtn");

/* ===== OUVRIR MODALE ===== */
shopCategoryInput.addEventListener("click", () => {
  modal.classList.remove("hidden");
  document.body.style.overflow = "hidden";
  searchInput.value = "";
  renderCategories("");
});

/* ===== FERMER MODALE ===== */
function closeCategoryModal() {
  modal.classList.add("hidden");
  document.body.style.overflow = "auto";
}

closeBtn.addEventListener("click", closeCategoryModal);
modal.addEventListener("click", closeCategoryModal);
modal.querySelector(".categoryBox").addEventListener("click", e => e.stopPropagation());

/* ===== AFFICHER CAT√âGORIES ===== */
function renderCategories(filter = "") {
  list.innerHTML = "";

  categories.forEach(group => {
    const groupTitle = document.createElement("div");
    groupTitle.className = "categoryGroupTitle";
    groupTitle.innerHTML = `${group.icon} ${group.name}`;
    list.appendChild(groupTitle);

    group.items.forEach(item => {
      const fullName = `${group.name} ¬∑ ${item}`;
      if (filter && !fullName.toLowerCase().includes(filter.toLowerCase())) return;

      const div = document.createElement("div");
      div.className = "categoryItem";
      div.style.background = group.color;
      div.innerHTML = `
        <span class="catIcon">${group.icon}</span>
        <span class="text">${item}</span>
      `;

      // Marquer comme s√©lectionn√© si d√©j√† choisi
      if (selectedSubCategories.includes(item)) {
        div.classList.add("selected");
      }

      div.onclick = () => {
        if (selectedMainCategory && selectedMainCategory !== group.name) {
          selectedSubCategories = [];
        }
        selectedMainCategory = group.name;

        if (selectedSubCategories.includes(item)) {
          selectedSubCategories = selectedSubCategories.filter(i => i !== item);
          div.classList.remove("selected");
        } else {
          selectedSubCategories.push(item);
          div.classList.add("selected");
        }
      };

      list.appendChild(div);
    });
  });
}

/* ===== RECHERCHE ===== */
searchInput.addEventListener("input", () => {
  renderCategories(searchInput.value);
});

/* ===== BOUTON VALIDER EXISTANT ===== */
validateBtn.addEventListener("click", (e) => {
  e.stopPropagation();

  if (!selectedMainCategory || selectedSubCategories.length === 0) {
    alert("Choisis au moins une sous-cat√©gorie");
    return;
  }

  selectedShopCategory =
    `${selectedMainCategory} ¬∑ ${selectedSubCategories.join(", ")}`;

  shopCategoryInput.value = selectedShopCategory;
  closeCategoryModal();
});
  
    
  // ====== PREMIUM SYSTEM ULTRA PRO FINAL (COLS: premium_level / premium_start / premium_end) ======

document.addEventListener('DOMContentLoaded', async () => {

  const premiumMenuBtn = document.getElementById('premiumMenuBtn');
  const closePremiumSidebar = document.getElementById('closePremiumSidebar');
  const premiumSidebar = document.getElementById('premiumSidebar');
  const userNameEl = document.getElementById('userName');
  const premiumCounterEl = document.getElementById('premiumCounter');

  if (!premiumMenuBtn || !closePremiumSidebar || !premiumSidebar || !userNameEl) {
    console.error("‚ùå √âl√©ments Premium manquants");
    return;
  }

  // ==============================
  // 1Ô∏è‚É£ RECUP USER
  // ==============================
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  const currentUser = user;

  // ==============================
  // 2Ô∏è‚É£ CHARGEMENT PROFIL
  // ==============================
  const { data: profile, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();

  if (error || !profile) {
    console.error("Erreur profil");
    return;
  }

  const now = new Date();
  const expiry = profile.premium_end ? new Date(profile.premium_end) : null;
  let premiumActive = false;

  // ==============================
  // 3Ô∏è‚É£ VERIFICATION EXPIRATION
  // ==============================
  if (profile.premium_level && expiry && expiry > now) {

    premiumActive = true;

    const diffTime = expiry - now;
    const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (premiumCounterEl) {
      premiumCounterEl.innerHTML = `‚è≥ ${daysLeft} jour(s) restant(s)`;
    }

    let stars = '';
    switch(profile.premium_level){
      case 'premium1': stars = '‚≠ê'; break;
      case 'premium2': stars = '‚≠ê‚≠ê'; break;
      case 'premium3': stars = '‚≠ê‚≠ê‚≠ê'; break;
    }

    userNameEl.innerHTML = (profile.username || currentUser.email) + 
                           `<span style="color:gold"> ${stars}</span>`;
  } 
  // ==============================
  // 4Ô∏è‚É£ SUPPRESSION SI EXPIR√â
  // ==============================
  else if (profile.premium_level && expiry && expiry <= now) {
    await supabase
      .from('profiles')
      .update({
        premium_level: null,
        premium_start: null,
        premium_end: null
      })
      .eq('id', currentUser.id);

    if (premiumCounterEl) premiumCounterEl.innerHTML = "";
    userNameEl.innerHTML = profile.username || currentUser.email;
  } 
  else {
    userNameEl.innerHTML = profile.username || currentUser.email;
  }

  // ==============================
  // 5Ô∏è‚É£ SIDEBAR OPEN / CLOSE
  // ==============================
  premiumMenuBtn.addEventListener('click', () => {
    premiumSidebar.classList.add('active');
  });

  closePremiumSidebar.addEventListener('click', () => {
    premiumSidebar.classList.remove('active');
  });


  // ==============================
// 6Ô∏è‚É£ ACHAT PREMIUM (version wallets)
// ==============================
document.querySelectorAll('.premiumBtn').forEach(btn => {
  btn.addEventListener('click', async (e) => {

    const card = e.target.closest('.premium-card');
    if (!card) return;

    const level = card.dataset.level;
    const price = parseInt(card.dataset.price);

    if (premiumActive) {
      alert("‚ö†Ô∏è Vous avez d√©j√† un Premium actif.");
      return;
    }

    // üî• R√©cup√©ration du wallet
    const { data: wallet, error: walletError } = await supabase
      .from('wallets')
      .select('*')
      .eq('user_id', currentUser.id)
      .single();

    if (walletError || !wallet) {
      alert("Portefeuille introuvable.");
      return;
    }

    const currentBalance = wallet.available_balance || 0;

    if (currentBalance < price) {
      alert("‚ùå Solde insuffisant.");
      return;
    }

    if (!confirm(`Confirmer paiement ${price} FCFA pour ${level} (30 jours) ?`)) return;

    const startDate = new Date();
    const expiryDate = new Date();
    expiryDate.setDate(startDate.getDate() + 30);

    // üî• D√©duction wallet
    const { error: walletUpdateError } = await supabase
      .from('wallets')
      .update({
        balance: wallet.balance - price,
        available_balance: wallet.available_balance - price,
        updated_at: new Date()
      })
      .eq('user_id', currentUser.id);

    if (walletUpdateError) {
      alert("Erreur d√©bit wallet.");
      return;
    }

    // üî• Mise √† jour profil premium
    const { error: profileError } = await supabase
      .from('profiles')
      .update({
        premium_level: level,
        premium_start: startDate,
        premium_end: expiryDate
      })
      .eq('id', currentUser.id);

    if (profileError) {
      alert("Erreur activation premium.");
      return;
    }

    // üî• Transaction wallet
    await supabase.from('wallet_transactions').insert({
      user_id: currentUser.id,
      amount: -price,
      type: "premium_payment",
      description: `Paiement ${level}`,
      created_at: new Date()
    });

    // üî• Historique premium
    await supabase.from('premium_history').insert({
      user_id: currentUser.id,
      level: level,
      amount: price,
      start_date: startDate,
      expiry_date: expiryDate,
      created_at: new Date()
    });

    alert(`üéâ Premium activ√© jusqu‚Äôau ${expiryDate.toLocaleDateString()}`);
    location.reload();
  });
});
    });
  // ===== COMPRESSION IMAGE AVANT UPLOAD =====
async function compressImage(file, maxWidth = 800, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;
    reader.onerror = reject;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(
        blob => resolve(blob),
        "image/jpeg",
        quality
      );
    };

    reader.readAsDataURL(file);
  });
}
// ===== CHARGER MES BOUTIQUES =====
async function loadMyShops() {
  if (!currentUser) return;

  const { data: shops, error } = await supabase
    .from("shops")
    .select("*")
    .eq("owner_id", currentUser.id)
    .order("created_at", { ascending: false });

  myShopsContainer.innerHTML = "";

  if (error) {
    console.error("‚ùå Erreur chargement boutiques :", error);
    myShopsContainer.innerHTML = "<p style='color:red;'>Erreur chargement boutiques</p>";
    return;
  }

  if (!shops || shops.length === 0) {
    myShopsContainer.innerHTML = "<p>Aucune boutique</p>";
    return;
  }

  shops.forEach(shop => {
    const div = document.createElement("div");
    div.className = "shopCard";

    // ‚≠ê Badge premium
    let stars = "";
    if (shop.premium_level === "premium1") stars = "‚≠ê";
    if (shop.premium_level === "premium2") stars = "‚≠ê‚≠ê";
    if (shop.premium_level === "premium3") stars = "‚≠ê‚≠ê‚≠ê";

    div.innerHTML = `
      ${shop.image_url ? `<img src="${shop.image_url}" alt="${shop.name}">` : ""}

      <h4>
        ${shop.name}
        <span style="color:gold;">${stars}</span>
      </h4>

      <small>${shop.category || ""}</small>

      <div style="display:flex; flex-direction:column; gap:6px; margin-top:5px;">
        <button class="openShopBtn addBtn">Ouvrir</button>

        <button class="publicBtn" style="background:#2196F3;color:#fff;">
          Voir vitrine
        </button>

        <button class="deleteShopBtn" style="background:#e53935;color:#fff;">
          Supprimer
        </button>
      </div>
    `;

    /* ===== OUVRIR BOUTIQUE ===== */
    div.querySelector(".openShopBtn").onclick = () => {
      openShop(shop);
    };

    /* ===== VITRINE PUBLIQUE ===== */
    div.querySelector(".publicBtn").onclick = () => {
      window.open(`shop.html?id=${shop.id}`, "_blank");
    };
    /* ===== SUPPRIMER BOUTIQUE (DB + STORAGE) ===== */
div.querySelector(".deleteShopBtn").onclick = async () => {
  if (!confirm("‚ö†Ô∏è Supprimer cette boutique et tous ses produits ?")) return;

  try {
    // üß† Sauvegarder infos boutique AVANT suppression
    const deletedShopInfo = { id: shop.id, name: shop.name };

    /* üî• 1. R√©cup√©rer les produits */
    const { data: products } = await supabase
      .from("shop_products")
      .select("image_url")
      .eq("shop_id", shop.id);

    /* üî• 2. Supprimer images produits */
    if (products && products.length > 0) {
      const productFiles = products
        .filter(p => p.image_url)
        .map(p => p.image_url.split("/").pop());

      if (productFiles.length > 0) {
        await supabase.storage
          .from("products")
          .remove(productFiles);
      }
    }

    /* üî• 3. Supprimer image boutique */
    if (shop.image_url) {
      const shopFile = shop.image_url.split("/").pop();
      await supabase.storage
        .from("shops")
        .remove([shopFile]);
    }

    /* üî• 4. Supprimer la boutique */
    const { error: deleteError } = await supabase
      .from("shops")
      .delete()
      .eq("id", shop.id);

    if (deleteError) {
      console.error(deleteError);
      alert("Erreur suppression boutique");
      return;
    }

    /* üîî Notification suppression boutique */
    await supabase
      .from("notif_market")
      .insert({
        user_id: currentUser.id,           // destinataire : propri√©taire
        actor_id: currentUser.id,          // celui qui effectue l'action
        type: "shop",
        title: "üóë Boutique supprim√©e",
        message: `La boutique "${deletedShopInfo.name}" a √©t√© supprim√©e`,
        target_id: deletedShopInfo.id,
        link: `/shops`,
        is_read: false
      });

    alert("‚úÖ Boutique supprim√©e (images incluses)");
    loadMyShops();

  } catch (err) {
    console.error("‚ùå Erreur suppression compl√®te :", err);
    alert("Erreur inattendue lors de la suppression");
  }
};

myShopsContainer.appendChild(div);
   });
}
// ===== OUVRIR BOUTIQUE =====
async function openShop(shop){
  if (!shop) return;
  currentShop = shop;

  shopFullModal.style.display = "block";
  createShopSection.style.display = "none";
  shopProductsSection.style.display = "block";
  shopProductsTitle.textContent = "Boutique : " + shop.name;

  await loadShopProducts(shop.id);
}

// ===== CHARGER PRODUITS BOUTIQUE =====
async function loadShopProducts(shopId) {
  const productsContainer = document.getElementById("productsContainer");
  if (!productsContainer || !shopId) return;

  productsContainer.innerHTML = "";

  // üîπ R√©cup√©rer le nom de la boutique
  const { data: shop, error: shopError } = await supabase
    .from("shops")
    .select("name")
    .eq("id", shopId)
    .single();

  const shopName = shopError || !shop ? "la boutique" : shop.name;

  // üîπ Charger produits
  const { data: products, error } = await supabase
    .from("shop_products")
    .select("*")
    .eq("shop_id", shopId)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Erreur chargement produits :", error);
    productsContainer.innerHTML =
      "<p style='color:red;'>Erreur chargement produits</p>";
    return;
  }

  if (!products || products.length === 0) {
    productsContainer.innerHTML = "<p>Aucun produit disponible</p>";
    return;
  }

  for (const product of products) {
    const div = document.createElement("div");
    div.className = "productCard";

    div.innerHTML = `
      ${product.image_url ? `
        <img src="${product.image_url}" alt="${product.name}">
      ` : ""}

      <h4>${product.name}</h4>
      <p>${product.description || ""}</p>

      <!-- ‚úÖ DISPONIBILIT√â -->
      <p style="font-weight:600;color:#2e7d32;">
        ${formatAvailability(product.availability)}
      </p>

      <strong>${product.price} FCFA</strong>

      <button class="deleteProductBtn"
        style="background:#e53935;color:#fff;margin-top:8px">
        Supprimer
      </button>
    `;

    // ===== SUPPRESSION PRODUIT =====
    div.querySelector(".deleteProductBtn").onclick = async () => {
      if (!confirm(`‚ö†Ô∏è Supprimer le produit "${product.name}" ?`)) return;

      const { error: deleteError } = await supabase
        .from("shop_products")
        .delete()
        .eq("id", product.id);

      if (deleteError) {
        console.error(deleteError);
        alert("Erreur suppression produit");
        return;
      }

      await supabase.from("notif_market").insert({
        user_id: currentUser.id,
        actor_id: currentUser.id,
        type: "product",
        title: "Produit supprim√©",
        message: `Le produit "${product.name}" a √©t√© supprim√© de la boutique "${shopName}"`,
        link: `/shop?id=${shopId}`,
        is_read: false
      });

      await loadShopProducts(shopId);
    };

    productsContainer.appendChild(div);
  }
}

// ===== FORMAT DISPONIBILIT√â =====
function formatAvailability(value) {
  const map = {
    now: "‚úÖ Disponible",
    "1_week": "‚è≥ Disponible dans 1 semaine",
    "2_weeks": "‚è≥ Disponible dans 2 semaines",
    "1_month": "üìÖ Disponible dans 1 mois",
    "2_months": "üìÖ Disponible dans 2 mois",
    "3_months": "üìÖ Disponible dans 3 mois",
    "6_months": "üìÖ Disponible dans 6 mois",
    "1_year": "üìÜ Disponible dans 1 an"
  };
  return map[value] || "‚è≥ Indisponible";
}

// ===== AJOUT PRODUIT BOUTIQUE =====
submitProductBtn.onclick = async () => {
  if (!currentShop) {
    alert("S√©lectionnez d'abord une boutique");
    return;
  }

  // üîπ V√©rifier si l'utilisateur a assez de pi√®ces pour cr√©er un produit
  const productCost = 5; // 5 pi√®ces pour ajouter un produit
  if ((currentProfile.coins || 35) < productCost) {
    alert("‚ö†Ô∏è Vous n'avez pas assez de pi√®ces pour ajouter ce produit");
    return;
  }

  const name = productName.value.trim();
  const description = productDesc.value.trim();
  const price = Number(productPrice.value);
  const file = productImage.files[0];

  // ‚ö†Ô∏è R√âCUP√âRER LA DISPONIBILIT√â
  const availabilitySelect = document.getElementById("productAvailability");
  const availability = availabilitySelect ? availabilitySelect.value : "now";

  if (!name || !price) {
    alert("Nom et prix obligatoires");
    return;
  }

  try {
    // üîπ Infos boutique
    const { data: shop, error: shopError } = await supabase
      .from("shops")
      .select("name, premium_level")
      .eq("id", currentShop.id)
      .single();

    if (shopError || !shop) {
      alert("Impossible de r√©cup√©rer la boutique");
      return;
    }

    const shopName = shop.name;

    // üîπ V√©rifier limite produits
    const { data: products } = await supabase
      .from("shop_products")
      .select("id")
      .eq("shop_id", currentShop.id);

    const maxProducts = shopProductLimits[shop.premium_level || "free"];
    if (products.length >= maxProducts) {
      alert(`Limite atteinte (${maxProducts} produits)`);
      return;
    }

    // üîπ Upload image
    let imageUrl = null;
    if (file) {
      const compressedFile = await compressImage(file, 800, 0.7);
      const fileName = `product_${currentShop.id}_${Date.now()}.jpg`;

      await supabase.storage
        .from("products")
        .upload(fileName, compressedFile, {
          contentType: "image/jpeg"
        });

      imageUrl = supabase.storage
        .from("products")
        .getPublicUrl(fileName).data.publicUrl;
    }

    // üîπ INSERT PRODUIT
    const { error } = await supabase.from("shop_products").insert({
      shop_id: currentShop.id,
      name,
      description,
      price,
      image_url: imageUrl,
      availability
    });

    if (error) {
      console.error("Erreur Supabase :", error);
      alert("‚ùå Erreur lors de l'ajout du produit");
      return;
    }

    // üîπ D√©duire les pi√®ces et mettre √† jour frontend & Supabase
    currentProfile.coins = (currentProfile.coins || 35) - productCost;

    await supabase
      .from("profiles")
      .update({ coins: currentProfile.coins })
      .eq("id", currentUser.id);

    // Mettre √† jour le compteur frontend
    const coinsElement = document.getElementById("userCoins");
    if (coinsElement) coinsElement.textContent = currentProfile.coins;

    alert(`‚úÖ Produit ajout√© avec succ√®s ! Il vous reste ${currentProfile.coins} pi√®ces`);

    await supabase.from("notif_market").insert({
      user_id: currentUser.id,
      actor_id: currentUser.id,
      type: "product",
      title: "Nouveau produit",
      message: `Le produit "${name}" a √©t√© ajout√© dans la boutique "${shopName}"`,
      link: `/shop?id=${currentShop.id}`,
      is_read: false
    });

    // üîπ Reset formulaire
    productName.value = "";
    productDesc.value = "";
    productPrice.value = "";
    productImage.value = "";
    if (availabilitySelect) availabilitySelect.value = "now";

    await loadShopProducts(currentShop.id);

  } catch (err) {
    console.error("Erreur ajout produit :", err);
    alert("Erreur inattendue lors de l'ajout");
  }
};
// ===== INIT =====
await loadCurrentUser();
</script>
  </body>
</html>
