<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Commandes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}
body{background:#f4f6f9}
header{background:#4CAF50;color:white;padding:15px;text-align:center}
main{max-width:1100px;margin:30px auto;padding:0 15px}

h2{margin:20px 0 10px}

.orders-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(330px,1fr));
gap:15px;
}

.order-card{
background:white;
padding:15px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,0.05);
transition:0.2s;
}
.order-card:hover{
transform:translateY(-3px);
box-shadow:0 6px 15px rgba(0,0,0,0.08);
}

.order-card p{margin:5px 0;font-size:14px}

.status{
padding:4px 8px;
border-radius:6px;
font-size:12px;
font-weight:600;
display:inline-block;
}
.pending{background:#ffeaa7}
.accepted{background:#74b9ff;color:white}
.paid{background:#00b894;color:white}
.refused{background:#d63031;color:white}

.btn{
padding:6px 10px;
border:none;
border-radius:6px;
cursor:pointer;
font-size:13px;
margin-top:8px;
margin-right:5px;
}
.accept-btn{background:#4CAF50;color:white}
.refuse-btn{background:#e74c3c;color:white}
.receive-btn{background:#3498db;color:white}
.pay-btn{background:#2ecc71;color:white}

/* MODAL */
.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.5);
justify-content:center;
align-items:center;
}
.modal-content{
background:white;
padding:20px;
border-radius:10px;
width:90%;
max-width:400px;
}
.modal-content input{
width:100%;
padding:8px;
margin:8px 0;
}
</style>
</head>

<body>

<header>
<h1>Mes Commandes</h1>
</header>

<main>

<h2>üõí Commandes que j'ai faites</h2>
<div class="orders-grid" id="buyerOrders"></div>

<h2>üè™ Commandes re√ßues (Je suis vendeur)</h2>
<div class="orders-grid" id="sellerOrders"></div>

</main>

<!-- MODAL CREATION -->
<div class="modal" id="orderModal">
<div class="modal-content">
<h3>Cr√©er une commande</h3>
<input type="text" id="orderAddress" placeholder="Adresse de livraison">
<input type="text" id="orderPhone" placeholder="T√©l√©phone">
<button class="btn accept-btn" id="createOrderBtn">Confirmer commande</button>
<button class="btn refuse-btn" onclick="closeOrderModal()">Annuler</button>
</div>
</div>

<!-- MODAL PAIEMENT -->
<div class="modal" id="paymentModal">
<div class="modal-content">
<h3>Paiement</h3>
<p>Montant : <span id="paymentAmount"></span></p>
<button class="btn pay-btn" id="payOrderBtn">Payer maintenant</button>
<button class="btn refuse-btn" onclick="closePaymentModal()">Annuler</button>
</div>
</div>

<script type="module">
import { supabase } from './supabase.js';

let currentUser=null;
let currentProduct=null;
let currentOrderId=null;
let isProcessing=false;

// ================= INIT =================
async function init() {
  const { data, error } = await supabase.auth.getUser();

  console.log("USER:", data);
  console.log("ERROR:", error);

  if (!data?.user) {
    alert("Utilisateur non connect√©");
    return;
  }

  currentUser = data.user;

  const { data: orders, error: err2 } = await supabase
    .from("orders")
    .select("*");

  console.log("ORDERS:", orders);
  console.log("ORDERS ERROR:", err2);
}
  await supabase.auth.signInWithPassword({
  email: "tonemail@test.com",
  password: "tonmotdepasse"
});

// ================= LOAD ORDERS =================
async function loadOrders(){

// ACHETEUR
const {data:buyerOrders}=await supabase
.from("orders")
.select("id,amount,status,seller_id,shop_products(name)")
.eq("buyer_id",currentUser.id)
.order("created_at",{ascending:false});

const buyerDiv=document.getElementById("buyerOrders");
buyerDiv.innerHTML="";

buyerOrders?.forEach(order=>{
const statusClass=order.status;
buyerDiv.innerHTML+=`
<div class="order-card">
<p><strong>Produit:</strong> ${order.shop_products?.name||"Produit"}</p>
<p><strong>Montant:</strong> ${order.amount} FCFA</p>
<p><span class="status ${statusClass}">${order.status}</span></p>
${order.status==="pending"?
`<button class="btn pay-btn" onclick="openPaymentModal('${order.id}',${order.amount})">Payer</button>`:""}
${order.status==="accepted"?
`<button class="btn receive-btn" onclick="completeOrder('${order.id}')">Produits re√ßus</button>`:""}
</div>`;
});

// VENDEUR
const {data:sellerOrders}=await supabase
.from("orders")
.select("id,amount,status,buyer_id,shop_products(name)")
.eq("seller_id",currentUser.id)
.order("created_at",{ascending:false});

const sellerDiv=document.getElementById("sellerOrders");
sellerDiv.innerHTML="";

sellerOrders?.forEach(order=>{
sellerDiv.innerHTML+=`
<div class="order-card">
<p><strong>Produit:</strong> ${order.shop_products?.name||"Produit"}</p>
<p><strong>Montant:</strong> ${order.amount} FCFA</p>
<p><span class="status ${order.status}">${order.status}</span></p>
${order.status==="pending"?
`<button class="btn accept-btn" onclick="acceptOrder('${order.id}')">Accepter</button>
<button class="btn refuse-btn" onclick="refuseOrder('${order.id}')">Refuser</button>`:""}
</div>`;
});
}

// ================= ACTIONS =================
async function acceptOrder(id){
await supabase.rpc("accept_order",{p_order_id:id});
loadOrders();
}

async function refuseOrder(id){
await supabase.rpc("refuse_order",{p_order_id:id});
loadOrders();
}

async function completeOrder(id){
await supabase.rpc("complete_order",{p_order_id:id});
alert("Paiement transf√©r√© au vendeur !");
loadOrders();
}

// ================= TON JS DE CREATION =================
function openOrderModal(){document.getElementById("orderModal").style.display="flex";}
function closeOrderModal(){document.getElementById("orderModal").style.display="none";}
function openPaymentModal(orderId,amount){
currentOrderId=orderId;
document.getElementById("paymentAmount").textContent=amount+" FCFA";
document.getElementById("paymentModal").style.display="flex";
}
function closePaymentModal(){document.getElementById("paymentModal").style.display="none";}

// CREER
document.getElementById("createOrderBtn").addEventListener("click",async()=>{
if(isProcessing||!currentProduct)return;
const address=document.getElementById("orderAddress").value.trim();
const phone=document.getElementById("orderPhone").value.trim();
if(!address||!phone)return alert("Adresse et t√©l√©phone requis");

isProcessing=true;
try{
const {data:userData}=await supabase.auth.getUser();
const {data:orderId,error}=await supabase.rpc("create_order",{
p_buyer:userData.user.id,
p_product_id:currentProduct.productId
});
if(error)throw error;
currentOrderId=orderId;
closeOrderModal();
openPaymentModal(orderId,currentProduct.amount);
}catch(err){alert(err.message);}
isProcessing=false;
});

// PAYER
document.getElementById("payOrderBtn").addEventListener("click",async()=>{
if(isProcessing||!currentOrderId)return;
isProcessing=true;
try{
await supabase.rpc("pay_order",{p_order_id:currentOrderId});
closePaymentModal();
alert("Paiement effectu√© !");
loadOrders();
}catch(err){alert(err.message);}
isProcessing=false;
});
</script>

</body>
</html>
