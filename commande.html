<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Commandes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}
body{
  background:#0f2027;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  color:white;
}
/* ================= HEADER ================= */
.header{
  padding:25px 20px;
  display:flex;
  align-items:center;
  gap:15px;
}
.avatar{
  width:60px;
  height:60px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  color:#2c5364;
  font-weight:bold;
}
.header-info h1{
  font-size:22px;
  font-weight:700;
}
.header-info p{
  font-size:14px;
  opacity:0.8;
}
/* ================= MAIN ================= */
main{
  background:#f4f6f9;
  border-top-left-radius:30px;
  border-top-right-radius:30px;
  padding:25px 20px;
  margin-top:20px;
  color:#333;
}
h2{margin:20px 0 10px;}
.orders-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:15px;
}
.order-card{
  background:white;
  padding:15px;
  border-radius:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
  display:flex;
  flex-direction:column;
}
.order-card p{
  font-size:14px;
  margin:5px 0;
}
.btn{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  margin-top:8px;
  width:100px;
}
.accept-btn{background:#4CAF50;color:white;}
.refuse-btn{background:#e74c3c;color:white;}
.pay-btn{background:#2ecc71;color:white;}
.empty{
  background:white;
  padding:15px;
  border-radius:10px;
  text-align:center;
  color:#888;
}
</style>
</head>
<body>

<div class="header">
  <div class="avatar" id="userAvatar">U</div>
  <div class="header-info">
    <h1>Mes Commandes</h1>
    <p id="userEmail"></p>
  </div>
</div>

<main>

<h2>üõí Commandes que j'ai faites</h2>
<div class="orders-grid" id="buyerOrders"></div>

<h2>üè™ Commandes re√ßues (Je suis vendeur)</h2>
<div class="orders-grid" id="sellerOrders"></div>

</main>

<script type="module">
import { supabase } from './supabase.js';

let currentUser = null;
let isProcessing = false;

// ================= INIT =================
async function init(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){
    alert("Vous devez √™tre connect√©");
    window.location.href="login.html";
    return;
  }

  currentUser = session.user;

  document.getElementById("userEmail").innerText = currentUser.email;
  document.getElementById("userAvatar").innerText =
    currentUser.email.charAt(0).toUpperCase();

  loadOrders();
}

init();

// ================= LOAD ORDERS =================
async function loadOrders(){

  const buyerDiv = document.getElementById("buyerOrders");
  const sellerDiv = document.getElementById("sellerOrders");

  buyerDiv.innerHTML="";
  sellerDiv.innerHTML="";

  // ===== ACHETEUR =====
  const { data:buyerOrders } = await supabase
  .from("orders")
  .select(`
    *,
    seller:profiles!orders_seller_id_fkey(username,email)
  `)
  .eq("buyer_id",currentUser.id);

  // ===== VENDEUR =====
  const { data:sellerOrders } = await supabase
  .from("orders")
  .select(`
    *,
    buyer:profiles!orders_buyer_id_fkey(username,email)
  `)
  .eq("seller_id",currentUser.id);

  // ===== AFFICHAGE ACHETEUR =====
  if(!buyerOrders || buyerOrders.length===0){
    buyerDiv.innerHTML="<div class='empty'>Aucune commande trouv√©e</div>";
  }else{
    buyerOrders.forEach(order=>{
      let payButton = '';
      if(order.status==='accepted'){
        payButton = `<button class="btn pay-btn" onclick="payOrder('${order.id}')">Payer</button>`;
      }
      buyerDiv.innerHTML+=`
        <div class="order-card">
          <p><strong>Vendeur :</strong> ${order.seller?.username || "Inconnu"}</p>
          <p><strong>Email :</strong> ${order.seller?.email || "N/A"}</p>
          <p><strong>Montant :</strong> ${order.amount} FCFA</p>
          <p><strong>Status :</strong> ${order.status}</p>
          ${payButton}
        </div>
      `;
    });
  }

  // ===== AFFICHAGE VENDEUR =====
  if(!sellerOrders || sellerOrders.length===0){
    sellerDiv.innerHTML="<div class='empty'>Aucune commande re√ßue</div>";
  }else{
    sellerOrders.forEach(order=>{
      let actionButtons = '';
      if(order.status==='pending'){
        actionButtons = `
          <button class="btn accept-btn" onclick="acceptOrder('${order.id}')">Accepter</button>
          <button class="btn refuse-btn" onclick="refuseOrder('${order.id}')">Refuser</button>
        `;
      }
      sellerDiv.innerHTML+=`
        <div class="order-card">
          <p><strong>Acheteur :</strong> ${order.buyer?.username || "Inconnu"}</p>
          <p><strong>Email :</strong> ${order.buyer?.email || "N/A"}</p>
          <p><strong>Montant :</strong> ${order.amount} FCFA</p>
          <p><strong>Status :</strong> ${order.status}</p>
          ${actionButtons}
        </div>
      `;
    });
  }
}

// ================= ACTIONS =================
async function acceptOrder(id){
  if(isProcessing) return;
  isProcessing = true;
  const { error } = await supabase.rpc("accept_order",{p_order_id:id});
  if(error) alert(error.message);
  loadOrders();
  isProcessing=false;
}

async function refuseOrder(id){
  if(isProcessing) return;
  isProcessing = true;
  const { error } = await supabase.rpc("refuse_order",{p_order_id:id});
  if(error) alert(error.message);
  loadOrders();
  isProcessing=false;
}

async function payOrder(id){
  if(isProcessing) return;
  isProcessing = true;
  const { error } = await supabase.rpc("pay_order",{p_order_id:id});
  if(error) alert(error.message);
  loadOrders();
  isProcessing=false;
}
</script>

</body>
</html>
