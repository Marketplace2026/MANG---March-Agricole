<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Commandes</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif}

body{
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  color:white;
}

/* HEADER */
.header{
  padding:25px 20px;
  display:flex;
  align-items:center;
  gap:15px;
}

.avatar{
  width:60px;
  height:60px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  color:#2c5364;
  font-weight:bold;
}

.header-info h1{font-size:22px;font-weight:700}
.header-info p{font-size:14px;opacity:0.8}

/* MAIN */
main{
  background:#f4f6f9;
  border-top-left-radius:30px;
  border-top-right-radius:30px;
  padding:25px 20px;
  margin-top:20px;
  color:#333;
}

h2{margin:25px 0 15px}

.orders-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:15px;
}

.order-card{
  background:white;
  padding:18px;
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
  cursor:pointer;
  transition:0.3s;
  position:relative;
}

.order-card:hover{
  transform:translateY(-4px);
}

/* STATUS BANDS */
.status-band{
  padding:8px 10px;
  border-radius:8px;
  font-size:13px;
  font-weight:500;
  margin-bottom:8px;
  color:white;
}

.status-pending{background:#f39c12;}
.status-accepted{background:#2ecc71;}
.status-refused{background:#e74c3c;}
.status-paid{background:#3498db;}

/* BUTTONS */
.btn{
  padding:7px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  margin-top:8px;
  margin-right:6px;
}

.accept-btn{background:#2ecc71;color:white;}
.refuse-btn{background:#e74c3c;color:white;}
.pay-btn{background:#27ae60;color:white;}

.empty{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  color:#888;
}

/* MODAL */
.modal{
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:9999;
}

.modal-content{
  background:white;
  padding:25px;
  border-radius:12px;
  width:100%;
  max-width:450px;
  color:#333;
  animation:fadeIn 0.2s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:scale(0.95)}
  to{opacity:1;transform:scale(1)}
}

.modal-content h3{margin-bottom:15px}
.modal-content p{margin:6px 0;font-size:14px}

.modal-close{
  margin-top:15px;
  background:#e74c3c;
  color:white;
  border:none;
  padding:7px 12px;
  border-radius:6px;
  cursor:pointer;
}
  
.back{
  padding:20px;
  cursor:pointer;
  font-weight:600;
}
</style>
</head>
<body>
<div class="back" onclick="window.location.href='index.html'">‚¨Ö Retour</div>
  
<div class="header">
  <div class="avatar" id="userAvatar">U</div>    
  <div class="header-info">    
    <h1>Mes Commandes</h1>    
    <p id="userEmail"></p>    
  </div>    
</div>

<main>
<h2>üõí Mes achats</h2>
<div class="orders-grid" id="buyerOrders"></div>

<h2>üè™ Commandes re√ßues</h2>
<div class="orders-grid" id="sellerOrders"></div>
</main>

<div class="modal" id="orderModal">
  <div class="modal-content">
    <h3>D√©tails de la commande</h3>
    <div id="orderDetails"></div>
    <button class="modal-close" onclick="closeModal()">Fermer</button>
  </div>
</div>

<script type="module">


  import { supabase } from './supabase.js';

let currentUser = null;
let isProcessing = false;
let allOrders = [];

/* ================= INIT ================= */
async function init() {
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session) {
      window.location.href = "login.html";
      return;
    }
    currentUser = session.user;

    // Affichage info utilisateur
    document.getElementById("userEmail").innerText = currentUser.email;
    document.getElementById("userAvatar").innerText = currentUser.email.charAt(0).toUpperCase();

    await loadOrders();
  } catch (err) {
    console.error("Erreur init:", err);
    alert("Erreur lors de l'initialisation.");
  }
}
init();

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  const buyerDiv = document.getElementById("buyerOrders");
  const sellerDiv = document.getElementById("sellerOrders");

  if (!buyerDiv || !sellerDiv) {
    console.error("Div commandes introuvable");
    return;
  }

  buyerDiv.innerHTML = "<p>Chargement...</p>";
  sellerDiv.innerHTML = "<p>Chargement...</p>";

  try {
    /* ================= COMMANDES ACHETEUR ================= */
    const { data: buyerOrders, error: buyerError } = await supabase
      .from("orders")
      .select(`
        id,
        amount,
        status,
        created_at,
        delivery_address,
        delivery_phone,
        note,
        seller:profiles!orders_seller_id_fkey (
          id,
          username,
          email
        ),
        product:shop_products!fk_orders_product (
          id,
          name,
          description
        )
      `)
      .eq("buyer_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (buyerError) {
      console.error("Erreur commandes acheteur :", buyerError);
      throw buyerError;
    }

    /* ================= COMMANDES VENDEUR ================= */
    const { data: sellerOrders, error: sellerError } = await supabase
      .from("orders")
      .select(`
        id,
        amount,
        status,
        created_at,
        delivery_address,
        delivery_phone,
        note,
        buyer:profiles!orders_buyer_id_fkey (
          id,
          username,
          email
        ),
        product:shop_products!fk_orders_product (
          id,
          name,
          description
        )
      `)
      .eq("seller_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (sellerError) {
      console.error("Erreur commandes vendeur :", sellerError);
      throw sellerError;
    }

    // Nettoyer affichage
    buyerDiv.innerHTML = "";
    sellerDiv.innerHTML = "";

    // Sauvegarder toutes les commandes
    allOrders = [
      ...(buyerOrders || []),
      ...(sellerOrders || [])
    ];

    // Affichage
    renderOrders(buyerOrders || [], buyerDiv, true);
    renderOrders(sellerOrders || [], sellerDiv, false);

  } catch (err) {
    console.error("Erreur g√©n√©rale loadOrders :", err);
    buyerDiv.innerHTML = "<p>Impossible de charger les commandes.</p>";
    sellerDiv.innerHTML = "<p>Impossible de charger les commandes.</p>";
  }
}
/* ================= RENDER ORDERS ================= */
function renderOrders(orders, container, isBuyer) {
  if (!orders || orders.length === 0) {
    container.innerHTML = "<div class='empty'>Aucune commande</div>";
    return;
  }

  container.innerHTML = "";

  orders.forEach(order => {
    const status = order.status?.toLowerCase() || "pending";
    let bandClass = "status-pending";
    let bandText = "En attente";

    if (status === "accepted") { bandClass = "status-accepted"; bandText = "Livraison accept√©e"; }
    if (status === "refused") { bandClass = "status-refused"; bandText = "Livraison refus√©e"; }
    if (status === "paid") { bandClass = "status-paid"; bandText = "Commande pay√©e"; }

    let buttons = "";

    // Vendeur : accepter/refuser
    if (!isBuyer && status === "pending") {
      buttons = `
        <button class="btn accept-btn" onclick="event.stopPropagation();acceptOrder('${order.id}')">Accepter</button>
        <button class="btn refuse-btn" onclick="event.stopPropagation();refuseOrder('${order.id}')">Refuser</button>
      `;
    }

    // Acheteur : payer
    if (isBuyer && status === "accepted") {
      buttons = `
        <button class="btn pay-btn" onclick="event.stopPropagation();promptPinPay('${order.id}')">Payer</button>
      `;
    }

    const otherUser = isBuyer ? order.seller : order.buyer;

    container.innerHTML += `
      <div class="order-card" onclick="showDetails('${order.id}')">
        <div class="status-band ${bandClass}">${bandText}</div>
        <p><strong>Produit :</strong> ${order.product?.name || "N/A"}</p>
        <p><strong>${isBuyer ? "Vendeur" : "Acheteur"} :</strong> ${otherUser?.username || "N/A"}</p>
        <p><strong>Montant :</strong> ${order.amount} FCFA</p>
        <p><strong>Date :</strong> ${new Date(order.created_at).toLocaleString()}</p>
        ${buttons}
      </div>
    `;
  });
  }

/* ================= ACTIONS VENDEUR ================= */
async function acceptOrder(orderId) {
  if (isProcessing) return;
  isProcessing = true;

  try {
    const { error } = await supabase.rpc("accept_order", { p_order_id: orderId });
    if (error) throw error;
    alert("Commande accept√©e !");
    await loadOrders();
  } catch (err) {
    console.error("Erreur acceptOrder:", err);
    alert("Impossible d‚Äôaccepter : " + err.message);
  }

  isProcessing = false;
}

async function refuseOrder(orderId) {
  if (isProcessing) return;
  isProcessing = true;

  try {
    const { error } = await supabase.rpc("refuse_order", { p_order_id: orderId });
    if (error) throw error;
    alert("Commande refus√©e ! L'argent a √©t√© retourn√© √† l'acheteur.");
    await loadOrders();
  } catch (err) {
    console.error("Erreur refuseOrder:", err);
    alert("Impossible de refuser : " + err.message);
  }

  isProcessing = false;
}

/* ================= PAYER AVEC PIN ================= */
async function promptPinPay(orderId) {
  const order = allOrders.find(o => String(o.id) === String(orderId));
  if (!order) return;

  const userPin = prompt("Entrez votre PIN pour confirmer le paiement :");
  if (!userPin) return;

  try {
    const { data: profile, error: pinError } = await supabase
      .from("profiles")
      .select("pin")
      .eq("id", currentUser.id)
      .single();
    if (pinError) throw pinError;

    if (!profile || profile.pin !== userPin) {
      alert("PIN incorrect !");
      return;
    }

    await payOrder(orderId);
  } catch (err) {
    console.error("Erreur PIN:", err);
    alert("Impossible de v√©rifier le PIN : " + err.message);
  }
}

async function payOrder(orderId) {
  if (isProcessing) return;
  isProcessing = true;

  try {
    const order = allOrders.find(o => String(o.id) === String(orderId));
    if (!order) throw new Error("Commande introuvable");

    const commission = Math.round(order.amount * 0.05);
    const payToSeller = order.amount - commission;

    const { error } = await supabase.rpc("pay_order_with_commission", { 
      p_order_id: orderId,
      p_amount_to_seller: payToSeller
    });
    if (error) throw error;

    alert(`Paiement effectu√© ! ${payToSeller} FCFA envoy√©s au vendeur, commission: ${commission} FCFA.`);
    await loadOrders();
  } catch (err) {
    console.error("Erreur payOrder:", err);
    alert("Impossible de payer la commande : " + err.message);
  }

  isProcessing = false;
}

/* ================= MODAL ================= */
function showDetails(orderId) {
  const order = allOrders.find(o => String(o.id) === String(orderId));
  if (!order) return;

  const isBuyer = order.buyer_id === currentUser.id;
  const otherUser = isBuyer ? order.seller : order.buyer;

  document.getElementById("orderDetails").innerHTML = `
    <p><strong>ID :</strong> ${order.id}</p>
    <p><strong>Produit :</strong> ${order.product?.name || "N/A"}</p>
    <p><strong>Description :</strong> ${order.product?.description || "N/A"}</p>
    <p><strong>${isBuyer ? "Vendeur" : "Acheteur"} :</strong> ${otherUser?.username || "N/A"}</p>
    <p><strong>Email :</strong> ${otherUser?.email || "N/A"}</p>
    <p><strong>Montant :</strong> ${order.amount} FCFA</p>
    <p><strong>Status :</strong> ${order.status}</p>
    <hr>
    <p><strong>Adresse :</strong> ${order.delivery_address || "N/A"}</p>
    <p><strong>T√©l√©phone :</strong> ${order.delivery_phone || "N/A"}</p>
    <p><strong>Note :</strong> ${order.note || "N/A"}</p>
    <p><strong>Commission :</strong> ${Math.round(order.amount*0.05)} FCFA</p>
  `;

  document.getElementById("orderModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("orderModal").style.display = "none";
}

/* ================= GLOBAL ================= */
window.acceptOrder = acceptOrder;
window.refuseOrder = refuseOrder;
window.payOrder = payOrder;
window.promptPinPay = promptPinPay;
window.showDetails = showDetails;
window.closeModal = closeModal;
</script>
</body>
</html>
