<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes Commandes</title>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#4CAF50;color:white;padding:15px;text-align:center}
main{max-width:1100px;margin:30px auto;padding:0 15px}
h2{margin:20px 0 10px}

.orders-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
gap:15px;
}

.order-card{
background:white;
padding:15px;
border-radius:10px;
box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

.status{
padding:4px 8px;
border-radius:6px;
font-size:12px;
font-weight:600;
display:inline-block;
}

.pending{background:#ffeaa7}
.accepted{background:#74b9ff;color:white}
.paid{background:#00b894;color:white}
.refused{background:#d63031;color:white}

.btn{
padding:6px 10px;
border:none;
border-radius:6px;
cursor:pointer;
font-size:13px;
margin-top:8px;
margin-right:5px;
color:white;
}

.accept-btn{background:#4CAF50}
.refuse-btn{background:#e74c3c}
.receive-btn{background:#3498db}
.pay-btn{background:#2ecc71}
</style>
</head>

<body>

<header>
<h1>Mes Commandes</h1>
</header>

<main>

<h2>üõí Commandes que j'ai faites</h2>
<div class="orders-grid" id="buyerOrders"></div>

<h2>üè™ Commandes re√ßues (Je suis vendeur)</h2>
<div class="orders-grid" id="sellerOrders"></div>

</main>

<script type="module">
import { supabase } from './supabase.js';

let currentUser = null;

// ================= INIT =================
async function init(){
  console.log("INIT START");

  const { data, error } = await supabase.auth.getUser();

  console.log("USER:", data);
  console.log("ERROR:", error);

  if(!data?.user){
    alert("Utilisateur non connect√©");
    return;
  }

  currentUser = data.user;
  console.log("Current User ID:", currentUser.id);

  await loadOrders();
}

init();

// ================= LOAD ORDERS =================
async function loadOrders(){
  console.log("LOADING ORDERS...");

  // ACHETEUR
  const { data: buyerOrders, error: buyerError } = await supabase
  .from("orders")
  .select(`
    id,
    amount,
    status,
    created_at,
    shop_products(name)
  `)
  .eq("buyer_id", currentUser.id)
  .order("created_at",{ascending:false});

  console.log("BUYER ORDERS:", buyerOrders);
  console.log("BUYER ERROR:", buyerError);

  // VENDEUR
  const { data: sellerOrders, error: sellerError } = await supabase
  .from("orders")
  .select(`
    id,
    amount,
    status,
    created_at,
    shop_products(name)
  `)
  .eq("seller_id", currentUser.id)
  .order("created_at",{ascending:false});

  console.log("SELLER ORDERS:", sellerOrders);
  console.log("SELLER ERROR:", sellerError);

  const buyerDiv = document.getElementById("buyerOrders");
  const sellerDiv = document.getElementById("sellerOrders");

  buyerDiv.innerHTML="";
  sellerDiv.innerHTML="";

  if(!buyerOrders?.length){
    buyerDiv.innerHTML="<p>Aucune commande trouv√©e.</p>";
  }

  if(!sellerOrders?.length){
    sellerDiv.innerHTML="<p>Aucune commande re√ßue.</p>";
  }

  // Affichage acheteur
  buyerOrders?.forEach(order=>{
    buyerDiv.innerHTML+=`
    <div class="order-card">
      <p><strong>Produit:</strong> ${order.shop_products?.name||"Produit"}</p>
      <p><strong>Montant:</strong> ${order.amount} FCFA</p>
      <p><span class="status ${order.status}">${order.status}</span></p>

      ${order.status==="pending" ?
      `<button class="btn pay-btn" onclick="payOrder('${order.id}')">Payer</button>`
      : ""}

      ${order.status==="accepted" ?
      `<button class="btn receive-btn" onclick="completeOrder('${order.id}')">Produits re√ßus</button>`
      : ""}
    </div>`;
  });

  // Affichage vendeur
  sellerOrders?.forEach(order=>{
    sellerDiv.innerHTML+=`
    <div class="order-card">
      <p><strong>Produit:</strong> ${order.shop_products?.name||"Produit"}</p>
      <p><strong>Montant:</strong> ${order.amount} FCFA</p>
      <p><span class="status ${order.status}">${order.status}</span></p>

      ${order.status==="pending" ?
      `<button class="btn accept-btn" onclick="acceptOrder('${order.id}')">Accepter</button>
       <button class="btn refuse-btn" onclick="refuseOrder('${order.id}')">Refuser</button>`
      : ""}
    </div>`;
  });
}

// ================= ACTIONS =================
window.acceptOrder = async function(id){
  console.log("ACCEPT:", id);
  const { error } = await supabase.rpc("accept_order",{p_order_id:id});
  console.log("ACCEPT ERROR:", error);
  loadOrders();
}

window.refuseOrder = async function(id){
  console.log("REFUSE:", id);
  const { error } = await supabase.rpc("refuse_order",{p_order_id:id});
  console.log("REFUSE ERROR:", error);
  loadOrders();
}

window.completeOrder = async function(id){
  console.log("COMPLETE:", id);
  const { error } = await supabase.rpc("complete_order",{p_order_id:id});
  console.log("COMPLETE ERROR:", error);
  alert("Paiement transf√©r√© au vendeur !");
  loadOrders();
}

window.payOrder = async function(id){
  console.log("PAY:", id);
  const { error } = await supabase.rpc("pay_order",{p_order_id:id});
  console.log("PAY ERROR:", error);
  alert("Paiement effectu√© !");
  loadOrders();
}
</script>

</body>
</html>
